/* nanoScrollerJS - v0.7.2
* http://jamesflorentino.github.com/nanoScrollerJS/
* Copyright (c) 2013 James Florentino; Licensed MIT */
(function(g,k,t){var c,l,h,v,d,e,a,n,s,j,w,x,b,m,r,u,i,f,p,o,q;o={paneClass:"pane",sliderClass:"slider",contentClass:"content",iOSNativeScrolling:false,preventPageScrolling:false,disableResize:false,alwaysVisible:false,flashDelay:1500,sliderMinHeight:20,sliderMaxHeight:null};u="scrollbar";r="scroll";n="mousedown";s="mousemove";w="mousewheel";j="mouseup";m="resize";d="drag";f="up";b="panedown";h="DOMMouseScroll";v="down";p="wheel";e="keydown";a="keyup";i="touchmove";c=k.navigator.appName==="Microsoft Internet Explorer"&&/msie 7./i.test(k.navigator.appVersion)&&k.ActiveXObject;l=null;q=function(){var y,A,z;y=t.createElement("div");A=y.style;A.position="absolute";A.width="100px";A.height="100px";A.overflow=r;A.top="-9999px";t.body.appendChild(y);z=y.offsetWidth-y.clientWidth;t.body.removeChild(y);return z};x=(function(){function y(A,z){this.el=A;this.options=z;l||(l=q());this.$el=g(this.el);this.doc=g(t);this.win=g(k);this.$content=this.$el.children("."+z.contentClass);this.$content.attr("tabindex",0);this.content=this.$content[0];if(this.options.iOSNativeScrolling&&(this.el.style.WebkitOverflowScrolling!=null)){this.nativeScrolling()}else{this.generate()}this.createEvents();this.addEvents();this.reset()}y.prototype.preventScrolling=function(A,z){if(!this.isActive){return}if(A.type===h){if(z===v&&A.originalEvent.detail>0||z===f&&A.originalEvent.detail<0){A.preventDefault()}}else{if(A.type===w){if(!A.originalEvent||!A.originalEvent.wheelDelta){return}if(z===v&&A.originalEvent.wheelDelta<0||z===f&&A.originalEvent.wheelDelta>0){A.preventDefault()}}}};y.prototype.nativeScrolling=function(){this.$content.css({WebkitOverflowScrolling:"touch"});this.iOSNativeScrolling=true;this.isActive=true};y.prototype.updateScrollValues=function(){var z;z=this.content;this.maxScrollTop=z.scrollHeight-z.clientHeight;this.contentScrollTop=z.scrollTop;if(!this.iOSNativeScrolling){this.maxSliderTop=this.paneHeight-this.sliderHeight;this.sliderTop=this.contentScrollTop*this.maxSliderTop/this.maxScrollTop}};y.prototype.createEvents=function(){var z=this;this.events={down:function(A){z.isBeingDragged=true;z.offsetY=A.pageY-z.slider.offset().top;z.pane.addClass("active");z.doc.bind(s,z.events[d]).bind(j,z.events[f]);return false},drag:function(A){z.sliderY=A.pageY-z.$el.offset().top-z.offsetY;z.scroll();z.updateScrollValues();if(z.contentScrollTop>=z.maxScrollTop){z.$el.trigger("scrollend")}else{if(z.contentScrollTop===0){z.$el.trigger("scrolltop")}}return false},up:function(A){z.isBeingDragged=false;z.pane.removeClass("active");z.doc.unbind(s,z.events[d]).unbind(j,z.events[f]);return false},resize:function(A){z.reset()},panedown:function(A){z.sliderY=(A.offsetY||A.originalEvent.layerY)-(z.sliderHeight*0.5);z.scroll();z.events.down(A);return false},scroll:function(A){if(z.isBeingDragged){return}z.updateScrollValues();if(!z.iOSNativeScrolling){z.sliderY=z.sliderTop;z.slider.css({top:z.sliderTop})}if(A==null){return}if(z.contentScrollTop>=z.maxScrollTop){if(z.options.preventPageScrolling){z.preventScrolling(A,v)}z.$el.trigger("scrollend")}else{if(z.contentScrollTop===0){if(z.options.preventPageScrolling){z.preventScrolling(A,f)}z.$el.trigger("scrolltop")}}},wheel:function(A){if(A==null){return}z.sliderY+=-A.wheelDeltaY||-A.delta;z.scroll();return false}}};y.prototype.addEvents=function(){var z;this.removeEvents();z=this.events;if(!this.options.disableResize){this.win.bind(m,z[m])}if(!this.iOSNativeScrolling){this.slider.bind(n,z[v]);this.pane.bind(n,z[b]).bind(""+w+" "+h,z[p])}this.$content.bind(""+r+" "+w+" "+h+" "+i,z[r])};y.prototype.removeEvents=function(){var z;z=this.events;this.win.unbind(m,z[m]);if(!this.iOSNativeScrolling){this.slider.unbind();this.pane.unbind()}this.$content.unbind(""+r+" "+w+" "+h+" "+i,z[r])};y.prototype.generate=function(){var B,C,A,z,D;A=this.options;z=A.paneClass,D=A.sliderClass,B=A.contentClass;if(!this.$el.find(""+z).length&&!this.$el.find(""+D).length){this.$el.append('<div class="'+z+'"><div class="'+D+'" /></div>')}this.pane=this.$el.children("."+z);this.slider=this.pane.find("."+D);if(l){C=this.$el.css("direction")==="rtl"?{left:-l}:{right:-l};this.$el.addClass("has-scrollbar")}if(C!=null){this.$content.css(C)}return this};y.prototype.restore=function(){this.stopped=false;this.pane.show();this.addEvents()};y.prototype.reset=function(){var F,G,H,A,B,z,D,C,E;if(this.iOSNativeScrolling){this.contentHeight=this.content.scrollHeight;return}if(!this.$el.find("."+this.options.paneClass).length){this.generate().stop()}if(this.stopped){this.restore()}F=this.content;H=F.style;A=H.overflowY;if(c){this.$content.css({height:this.$content.height()})}G=F.scrollHeight+l;z=this.pane.outerHeight();C=parseInt(this.pane.css("top"),10);B=parseInt(this.pane.css("bottom"),10);D=z+C+B;E=Math.round(D/G*D);if(E<this.options.sliderMinHeight){E=this.options.sliderMinHeight}else{if((this.options.sliderMaxHeight!=null)&&E>this.options.sliderMaxHeight){E=this.options.sliderMaxHeight}}if(A===r&&H.overflowX!==r){E+=l}this.maxSliderTop=D-E;this.contentHeight=G;this.paneHeight=z;this.paneOuterHeight=D;this.sliderHeight=E;this.slider.height(E);this.events.scroll();this.pane.show();this.isActive=true;if((F.scrollHeight===F.clientHeight)||(this.pane.outerHeight(true)>=F.scrollHeight&&A!==r)){this.pane.hide();this.isActive=false}else{if(this.el.clientHeight===F.scrollHeight&&A===r){this.slider.hide()}else{this.slider.show()}}this.pane.css({visibility:(this.options.alwaysVisible?"visible":"")});return this};y.prototype.scroll=function(){if(!this.isActive){return}this.sliderY=Math.max(0,this.sliderY);this.sliderY=Math.min(this.maxSliderTop,this.sliderY);this.$content.scrollTop((this.paneHeight-this.contentHeight+l)*this.sliderY/this.maxSliderTop*-1);if(!this.iOSNativeScrolling){this.slider.css({top:this.sliderY})}return this};y.prototype.scrollBottom=function(z){if(!this.isActive){return}this.reset();this.$content.scrollTop(this.contentHeight-this.$content.height()-z).trigger(w);return this};y.prototype.scrollTop=function(z){if(!this.isActive){return}this.reset();this.$content.scrollTop(+z).trigger(w);return this};y.prototype.scrollTo=function(z){if(!this.isActive){return}this.reset();this.scrollTop(g(z).get(0).offsetTop);return this};y.prototype.stop=function(){this.stopped=true;this.removeEvents();this.pane.hide();return this};y.prototype.flash=function(){var z=this;if(!this.isActive){return}this.reset();this.pane.addClass("flashed");setTimeout(function(){z.pane.removeClass("flashed")},this.options.flashDelay);return this};return y})();g.fn.nanoScroller=function(y){return this.each(function(){var z,A;if(!(A=this.nanoscroller)){z=g.extend({},o,y);this.nanoscroller=A=new x(this,z)}if(y&&typeof y==="object"){g.extend(A.options,y);if(y.scrollBottom){return A.scrollBottom(y.scrollBottom)}if(y.scrollTop){return A.scrollTop(y.scrollTop)}if(y.scrollTo){return A.scrollTo(y.scrollTo)}if(y.scroll==="bottom"){return A.scrollBottom(0)}if(y.scroll==="top"){return A.scrollTop(0)}if(y.scroll&&y.scroll instanceof g){return A.scrollTo(y.scroll)}if(y.stop){return A.stop()}if(y.flash){return A.flash()}}return A.reset()})}})(jQuery,window,document);
/* /htapps/roger.babel/pt/web/js/jquery.nanoscroller-min.js */
head.ready(function(){var f;var d;var g;var c;var e;f=$(window);d=$(".sidebar-wrap");g=d.find(".scrollable");if(!d.length){return}if($("body").is(".view-image")||$("body").is(".view-plaintext")){return}HT.x=10;var a=function(){e=$(".navbar-static-top");var l=$(window).height();var k=$(window).height()-e.height()-$(".toolbar-horizontal").outerHeight()-20;var j=$("#scrolling").height();if(k>j){k=j}var i=k-$(".bibLinks").height()-HT.x;console.log("CALCULATING SCROLLABLE HEIGHT",k,j,i);return i};$.subscribe("action.toggle.fullscreen.sidebar",function(){if(d.parent().is(":visible")){console.log("SIDEBAR PARENT IS VISIBLE");d.trigger("sticky_kit:detach");d.stick_in_parent({inner_scrolling:false,offset_top:e.height()+10,recalc_every:500})}else{console.log("SIDEBAR PARENT IS HIDDEN");d.trigger("sticky_kit:detach");d.css("left","auto")}});var b=d.position().left;d.data("original-left",d.position().left);d.on("sticky_kit:stick",function(h){d.css("left","auto")}).on("sticky_kit:unstick",function(h){d.css("left","auto")}).on("sticky_kit:bottom",function(h){d.css("left","auto")}).on("sticky_kit:unbottom",function(h){});f.scroll(function(){var h=d.css("left");if(d.css("position")=="fixed"){if(h=="auto"){h=d.position().left}d.css("left",(-f.scrollLeft()+b)+"px")}else{d.css("left","auto")}});$.subscribe("view.ready.sidebar",function(){d.trigger("sticky_kit:detach");g.height(a());d.stick_in_parent({inner_scrolling:false,offset_top:e.height()+10,recalc_every:500})})});
/* /htapps/roger.babel/pt/web/js/sidebar-min.js */
head.ready(function(){function r(s){$(s).contents().each(function(v,w){if(w.nodeType==1){r(w)}else{if(j<=g){if(j+w.length>=g){n.setStart(w,g-j)}}if(j<=c){if(j+w.length>=c){n.setEnd(w,c-j)}}j=j+w.length}})}var g,c,n,m,j;function f(z,w,v,x){var y=[];v.querySelectorAll("p").forEach(function(A,s){g=A.innerText.toLowerCase().indexOf(x.toLowerCase());if(g>-1){n=v.ownerDocument.createRange();c=g+x.length;j=0;r(A,g,c);var B=z.cfiFromRange(n);y.push(B)}else{}});return y}console.log("AHOY READER");var t=$("html").data("epub-root");var d="paginated";var l;if(location.hash&&location.hash.startsWith("#/6")){l="epubcfi("+location.hash.substr(1)+")";console.log("AHOY STARTING WITH",location.hash,l);location.hash=""}else{if(sessionStorage.getItem("id")==HT.params.id){l="epubcfi("+sessionStorage.getItem("hash").substr(1)+")";console.log("AHOY STARTING WITH SAVED",l)}}var a=cozy.reader("content",{href:t,flow:d});HT.reader=a;var u=$("#action-go-prev").parent();console.log("AHOY TOOLBAR",u);cozy.control.pageFirst({container:u.get(0)}).addTo(a);cozy.control.pagePrevious({container:u.get(0)}).addTo(a);cozy.control.pageNext({container:u.get(0)}).addTo(a);cozy.control.pageLast({container:u.get(0)}).addTo(a);cozy.control.navigator({region:"bottom.navigator"}).addTo(a);var e=function(v){target=a.currentLocation();$("a[data-target].active").removeClass("active");$(v).addClass("active");var s=$(v).data("target");a.reopen({flow:s})};$("a[data-target=scrolled-doc]").on("click",function(s){s.preventDefault();s.stopPropagation();e(this)});$("a[data-target=paginate]").on("click",function(s){s.preventDefault();s.stopPropagation();e(this)});var o=["small","default","large"];var k=1;var q=function(v){k+=v;var s=o[k];if(s=="large"){$("#action-zoom-in").attr("disabled","disabled");$("#action-zoom-out").attr("disabled",null)}else{if(s=="small"){$("#action-zoom-in").attr("disabled",null);$("#action-zoom-out").attr("disabled","disabled")}else{$("#action-zoom-in").attr("disabled",null);$("#action-zoom-out").attr("disabled",null)}}a.reopen({text_size:s})};$("#action-zoom-in").on("click",function(s){s.preventDefault();s.stopPropagation();q(1)});$("#action-zoom-out").on("click",function(s){s.preventDefault();s.stopPropagation();q(-1)});$("#action-toggle-fullscreen").on("click",function(s){if(screenfull.enabled){screenfull.toggle($(".container.page.centered").get(0))}});var p=function(y,x,w,v){var s=[];$.each(y,function(){if(this.parent==x){s.push([this,w,v])}});return s};var i=$(".table-of-contents ul");a.on("update-contents",function(A){if(A){var w=i;var v=p(A.toc,null,0,w);while(v.length){var s=v.shift();var y=s[0];var w=s[2];console.log("AHOY MENU",w,w.get(0).tagName);if(w.get(0).tagName=="LI"){var x=w.find("ul");if(!x.size()){x=$("<ul></ul>").appendTo(w);console.log("AHOY WHAT?")}w=x}var B=$("<li><a></a></li>").appendTo(w);var z=B.find("a");z.attr("href",y.href);z.text(y.label);$.each(p(A.toc,y.id,s[1]+1,B).reverse(),function(){v.unshift(this)})}}});i.on("click","a",function(v){v.preventDefault();var s=$(this).attr("href");console.log("AHOY GO TO",s);a.gotoPage(s)});var b=HT.params.h;if(b){b=b.split(":")}else{b=[]}var h={};window.DEBUG=window.DEBUG||{};a.on("update-section",function(v){var s=a._rendition.manager.current();if(!s){return}var w=s.section;if(!h[w.href]){h[w.href]=true;console.log("AHOY",w.href,b);DEBUG.view=s;if(true&&s.contents&&b.length>0){console.log("AHOY WIDTH 1",$(s.contents.window).width());b.forEach(function(y){m=s.contents.window.getSelection();var x=s.contents.document.getElementsByTagName("body").item(0);var z=f(s.contents,m,x,y);if(z.length){z.forEach(function(A){console.log("AHOY HIGHLIGHTING",A,y);a.annotations.highlight(A)})}});setTimeout(function(){console.log("AHOY WIDTH 2",$(s.contents.window).width())},500)}}});a.on("update-section",function(){sessionStorage.setItem("id",HT.params.id);sessionStorage.setItem("hash",window.location.hash)});a.start(l);setTimeout(function(){},100)});
/* /htapps/roger.babel/pt/web/js/epub_reader-min.js */
