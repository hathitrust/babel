jQuery.easing.jswing=jQuery.easing.swing;jQuery.extend(jQuery.easing,{def:"easeOutQuad",swing:function(e,f,a,h,g){return jQuery.easing[jQuery.easing.def](e,f,a,h,g)},easeInQuad:function(e,f,a,h,g){return h*(f/=g)*f+a},easeOutQuad:function(e,f,a,h,g){return -h*(f/=g)*(f-2)+a},easeInOutQuad:function(e,f,a,h,g){if((f/=g/2)<1){return h/2*f*f+a}return -h/2*((--f)*(f-2)-1)+a},easeInCubic:function(e,f,a,h,g){return h*(f/=g)*f*f+a},easeOutCubic:function(e,f,a,h,g){return h*((f=f/g-1)*f*f+1)+a},easeInOutCubic:function(e,f,a,h,g){if((f/=g/2)<1){return h/2*f*f*f+a}return h/2*((f-=2)*f*f+2)+a},easeInQuart:function(e,f,a,h,g){return h*(f/=g)*f*f*f+a},easeOutQuart:function(e,f,a,h,g){return -h*((f=f/g-1)*f*f*f-1)+a},easeInOutQuart:function(e,f,a,h,g){if((f/=g/2)<1){return h/2*f*f*f*f+a}return -h/2*((f-=2)*f*f*f-2)+a},easeInQuint:function(e,f,a,h,g){return h*(f/=g)*f*f*f*f+a},easeOutQuint:function(e,f,a,h,g){return h*((f=f/g-1)*f*f*f*f+1)+a},easeInOutQuint:function(e,f,a,h,g){if((f/=g/2)<1){return h/2*f*f*f*f*f+a}return h/2*((f-=2)*f*f*f*f+2)+a},easeInSine:function(e,f,a,h,g){return -h*Math.cos(f/g*(Math.PI/2))+h+a},easeOutSine:function(e,f,a,h,g){return h*Math.sin(f/g*(Math.PI/2))+a},easeInOutSine:function(e,f,a,h,g){return -h/2*(Math.cos(Math.PI*f/g)-1)+a},easeInExpo:function(e,f,a,h,g){return(f==0)?a:h*Math.pow(2,10*(f/g-1))+a},easeOutExpo:function(e,f,a,h,g){return(f==g)?a+h:h*(-Math.pow(2,-10*f/g)+1)+a},easeInOutExpo:function(e,f,a,h,g){if(f==0){return a}if(f==g){return a+h}if((f/=g/2)<1){return h/2*Math.pow(2,10*(f-1))+a}return h/2*(-Math.pow(2,-10*--f)+2)+a},easeInCirc:function(e,f,a,h,g){return -h*(Math.sqrt(1-(f/=g)*f)-1)+a},easeOutCirc:function(e,f,a,h,g){return h*Math.sqrt(1-(f=f/g-1)*f)+a},easeInOutCirc:function(e,f,a,h,g){if((f/=g/2)<1){return -h/2*(Math.sqrt(1-f*f)-1)+a}return h/2*(Math.sqrt(1-(f-=2)*f)+1)+a},easeInElastic:function(f,h,e,l,k){var i=1.70158;var j=0;var g=l;if(h==0){return e}if((h/=k)==1){return e+l}if(!j){j=k*0.3}if(g<Math.abs(l)){g=l;var i=j/4}else{var i=j/(2*Math.PI)*Math.asin(l/g)}return -(g*Math.pow(2,10*(h-=1))*Math.sin((h*k-i)*(2*Math.PI)/j))+e},easeOutElastic:function(f,h,e,l,k){var i=1.70158;var j=0;var g=l;if(h==0){return e}if((h/=k)==1){return e+l}if(!j){j=k*0.3}if(g<Math.abs(l)){g=l;var i=j/4}else{var i=j/(2*Math.PI)*Math.asin(l/g)}return g*Math.pow(2,-10*h)*Math.sin((h*k-i)*(2*Math.PI)/j)+l+e},easeInOutElastic:function(f,h,e,l,k){var i=1.70158;var j=0;var g=l;if(h==0){return e}if((h/=k/2)==2){return e+l}if(!j){j=k*(0.3*1.5)}if(g<Math.abs(l)){g=l;var i=j/4}else{var i=j/(2*Math.PI)*Math.asin(l/g)}if(h<1){return -0.5*(g*Math.pow(2,10*(h-=1))*Math.sin((h*k-i)*(2*Math.PI)/j))+e}return g*Math.pow(2,-10*(h-=1))*Math.sin((h*k-i)*(2*Math.PI)/j)*0.5+l+e},easeInBack:function(e,f,a,i,h,g){if(g==undefined){g=1.70158}return i*(f/=h)*f*((g+1)*f-g)+a},easeOutBack:function(e,f,a,i,h,g){if(g==undefined){g=1.70158}return i*((f=f/h-1)*f*((g+1)*f+g)+1)+a},easeInOutBack:function(e,f,a,i,h,g){if(g==undefined){g=1.70158}if((f/=h/2)<1){return i/2*(f*f*(((g*=(1.525))+1)*f-g))+a}return i/2*((f-=2)*f*(((g*=(1.525))+1)*f+g)+2)+a},easeInBounce:function(e,f,a,h,g){return h-jQuery.easing.easeOutBounce(e,g-f,0,h,g)+a},easeOutBounce:function(e,f,a,h,g){if((f/=g)<(1/2.75)){return h*(7.5625*f*f)+a}else{if(f<(2/2.75)){return h*(7.5625*(f-=(1.5/2.75))*f+0.75)+a}else{if(f<(2.5/2.75)){return h*(7.5625*(f-=(2.25/2.75))*f+0.9375)+a}else{return h*(7.5625*(f-=(2.625/2.75))*f+0.984375)+a}}}},easeInOutBounce:function(e,f,a,h,g){if(f<g/2){return jQuery.easing.easeInBounce(e,f*2,0,h,g)*0.5+a}return jQuery.easing.easeOutBounce(e,f*2-g,0,h,g)*0.5+h*0.5+a}});
/* /htapps/roger.babel/pt/web/js/jquery.easing.1.3-min.js */
(function(d){d.each(["backgroundColor","borderBottomColor","borderLeftColor","borderRightColor","borderTopColor","color","outlineColor"],function(f,e){d.fx.step[e]=function(g){if(!g.colorInit){g.start=c(g.elem,e);g.end=b(g.end);g.colorInit=true}g.elem.style[e]="rgb("+[Math.max(Math.min(parseInt((g.pos*(g.end[0]-g.start[0]))+g.start[0]),255),0),Math.max(Math.min(parseInt((g.pos*(g.end[1]-g.start[1]))+g.start[1]),255),0),Math.max(Math.min(parseInt((g.pos*(g.end[2]-g.start[2]))+g.start[2]),255),0)].join(",")+")"}});function b(f){var e;if(f&&f.constructor==Array&&f.length==3){return f}if(e=/rgb\(\s*([0-9]{1,3})\s*,\s*([0-9]{1,3})\s*,\s*([0-9]{1,3})\s*\)/.exec(f)){return[parseInt(e[1]),parseInt(e[2]),parseInt(e[3])]}if(e=/rgb\(\s*([0-9]+(?:\.[0-9]+)?)\%\s*,\s*([0-9]+(?:\.[0-9]+)?)\%\s*,\s*([0-9]+(?:\.[0-9]+)?)\%\s*\)/.exec(f)){return[parseFloat(e[1])*2.55,parseFloat(e[2])*2.55,parseFloat(e[3])*2.55]}if(e=/#([a-fA-F0-9]{2})([a-fA-F0-9]{2})([a-fA-F0-9]{2})/.exec(f)){return[parseInt(e[1],16),parseInt(e[2],16),parseInt(e[3],16)]}if(e=/#([a-fA-F0-9])([a-fA-F0-9])([a-fA-F0-9])/.exec(f)){return[parseInt(e[1]+e[1],16),parseInt(e[2]+e[2],16),parseInt(e[3]+e[3],16)]}if(e=/rgba\(0, 0, 0, 0\)/.exec(f)){return a.transparent}return a[d.trim(f).toLowerCase()]}function c(g,e){var f;do{f=d.curCSS(g,e);if(f!=""&&f!="transparent"||d.nodeName(g,"body")){break}e="backgroundColor"}while(g=g.parentNode);if(!f){f="transparent"}return b(f)}var a={aqua:[0,255,255],azure:[240,255,255],beige:[245,245,220],black:[0,0,0],blue:[0,0,255],brown:[165,42,42],cyan:[0,255,255],darkblue:[0,0,139],darkcyan:[0,139,139],darkgrey:[169,169,169],darkgreen:[0,100,0],darkkhaki:[189,183,107],darkmagenta:[139,0,139],darkolivegreen:[85,107,47],darkorange:[255,140,0],darkorchid:[153,50,204],darkred:[139,0,0],darksalmon:[233,150,122],darkviolet:[148,0,211],fuchsia:[255,0,255],gold:[255,215,0],green:[0,128,0],indigo:[75,0,130],khaki:[240,230,140],lightblue:[173,216,230],lightcyan:[224,255,255],lightgreen:[144,238,144],lightgrey:[211,211,211],lightpink:[255,182,193],lightyellow:[255,255,224],lime:[0,255,0],magenta:[255,0,255],maroon:[128,0,0],navy:[0,0,128],olive:[128,128,0],orange:[255,165,0],pink:[255,192,203],purple:[128,0,128],violet:[128,0,128],red:[255,0,0],silver:[192,192,192],white:[255,255,255],yellow:[255,255,0],transparent:[255,255,255]}})(jQuery);
/* /htapps/roger.babel/pt/web/js/jquery.color-min.js */
(function(a){a.fn.textfill=function(b){b=jQuery.extend({maxFontSize:null,minFontSize:4,step:1.25,sel:null},b);return this.each(function(){var l=b.sel?a(this).find(b.sel):a(this).children(":visible"),m=b.maxFontSize||parseInt(l.css("font-size")),j=a(this).height(),k=a(this).width(),c,f;var h=a(this);do{h.css("font-size",m+"px");c=a.map(l,function(n){return a(n).outerHeight()}).reduce(function(n,o){return n+o},0);var f=0;l.each(function(){if(f<a(this).outerWidth()){f=a(this).outerWidth()}});m=m-b.step}while((c>j||f>k)&&m>b.minFontSize);var d=0;do{l.each(function(n,q){if(q!==undefined){var o=a(q);var p=o.scrollLeft();o.scrollLeft(p+1);if(o.scrollLeft()>p){d=1}}});if(d){m=m-b.step;h.css("font-size",m+"px");d=0}}while(d);d=0;var g=0;var i=1.25;do{h.css("line-height",i);var e=h.scrollTop();h.scrollTop(e+1);if(h.scrollTop()>e){h.scrollTop(e);d=1;i-=0.25;h.css("line-height",i)}else{d=0}g+=1;if(g>1000){break}}while(d&&i>0)})}})(jQuery);
/* /htapps/roger.babel/pt/web/js/jquery.textfill-min.js */
function BookReader(){this.reduce=4;this.padding=10;this.mode=1;this.ui="full";this.thumbWidth=100;this.thumbRowBuffer=2;this.thumbColumns=6;this.thumbMaxLoading=4;this.displayedRows=[];this.displayedIndices=[];this.imgs={};this.prefetchedImgs={};this.timer=null;this.animating=false;this.auto=false;this.autoTimer=null;this.flipSpeed="fast";this.twoPagePopUp=null;this.leafEdgeTmp=null;this.embedPopup=null;this.printPopup=null;this.searchTerm="";this.searchResults={};this.firstIndex=null;this.lastDisplayableIndex2up=null;this.logoURL="http://www.archive.org/index.php";this.imagesBaseURL="/bookreader/images/";this.constMode1up=1;this.constMode2up=2;this.constModeThumb=3;this.reductionFactors=[{reduce:0.5,autofit:null},{reduce:1,autofit:null},{reduce:2,autofit:null},{reduce:4,autofit:null},{reduce:8,autofit:null},{reduce:16,autofit:null}];this.onePage={autofit:"height"};this.twoPage={coverInternalPadding:10,coverExternalPadding:10,bookSpineDivWidth:30,autofit:"auto"};return this}BookReader.prototype.init=function(){var b=undefined;this.pageScale=this.reduce;var a=this.paramsFromFragment(window.location.hash);if(!this.canSwitchToMode(this.mode)){this.mode=this.constMode1up}if("undefined"!=typeof(a.index)){b=a.index}else{if("undefined"!=typeof(a.page)){b=this.getPageIndex(a.page)}}if("undefined"==typeof(b)){if("undefined"!=typeof(this.titleLeaf)){if(this.numLeafs>2){b=this.leafNumToIndex(this.titleLeaf)}}}if("undefined"==typeof(b)){b=0}if("undefined"!=typeof(a.mode)){this.mode=a.mode}document.title=this.shortTitle(50);$("#BookReader").empty();this.initToolbar(this.mode,this.ui);$("#BookReader").append("<div id='BRcontainer'></div>");$("#BRcontainer").append("<div id='BRpageview'></div>");$("#BRcontainer").bind("scroll",this,function(c){c.data.loadLeafs()});this.setupKeyListeners();this.startLocationPolling();$(window).bind("resize",this,function(f){if(1==f.data.mode){if(f.data.autofit){f.data.resizePageView()}f.data.centerPageView();$("#BRpageview").empty();f.data.displayedIndices=[];f.data.updateSearchHilites();f.data.loadLeafs()}else{if(3==f.data.mode){f.data.prepareThumbnailView()}else{if(f.data.twoPage.autofit){f.data.prepareTwoPageView()}else{var c=f.data.twoPageGetViewCenter();var d=false;if(f.data.twoPage.totalWidth<$("#BRcontainer").attr("clientWidth")){c.percentageX=0.5;d=true}if(f.data.twoPage.totalHeight<$("#BRcontainer").attr("clientHeight")){c.percentageY=0.5;d=true}if(d){f.data.twoPageCenterView(c.percentageX,c.percentageY)}}}}});if(1==this.mode){this.firstIndex=b;this.prepareOnePageView();this.jumpToIndex(b)}else{if(3==this.mode){this.firstIndex=b;this.prepareThumbnailView();this.jumpToIndex(b)}else{this.displayedIndices=[0];this.firstIndex=b;this.displayedIndices=[this.firstIndex];this.prepareTwoPageView()}}this.updateFromParams(a)};BookReader.prototype.setupKeyListeners=function(){var i=this;var d=33;var c=34;var a=35;var f=36;var b=37;var e=38;var h=39;var g=40;$(document).keydown(function(j){if(!i.keyboardNavigationIsDisabled(j)){switch(j.keyCode){case d:case e:if(2==i.mode){j.preventDefault();i.prev()}break;case g:case c:if(2==i.mode){j.preventDefault();i.next()}break;case a:j.preventDefault();i.last();break;case f:j.preventDefault();i.first();break;case b:if(2==i.mode){j.preventDefault();i.left()}break;case h:if(2==i.mode){j.preventDefault();i.right()}break}}})};BookReader.prototype.drawLeafs=function(){if(1==this.mode){this.drawLeafsOnePage()}else{if(3==this.mode){this.drawLeafsThumbnail()}else{this.drawLeafsTwoPage()}}};BookReader.prototype.bindGestures=function(a){a.unbind("gesturechange").bind("gesturechange",function(b){b.preventDefault();if(b.originalEvent.scale>1.5){br.zoom(1)}else{if(b.originalEvent.scale<0.6){br.zoom(-1)}}})};BookReader.prototype.setClickHandler2UP=function(a,c,b){$(a).unbind("tap").bind("tap",c,function(d){b(d)})};BookReader.prototype.drawLeafsOnePage=function(){this.timer=null;var a=$("#BRcontainer").attr("scrollTop");var k=a+$("#BRcontainer").height();var g=[];var l={};var q;var p=0;var f=0;for(q=0;q<this.numLeafs;q++){var j=parseInt(this._getPageHeight(q)/this.reduce);f+=j;var s=(p>=a)&&(p<=k);var c=(f>=a)&&(f<=k);var o=(p<=a)&&(f>=k);if(s|c|o){g.push(q);if(p<=a){l[q]=(j-(a-p))/j}else{if(f>=k){l[q]=(j-(f-k))/j}else{l[q]=1}}}p+=j+10;f+=10}var r=g[0];this.firstIndex=r;for(q=0;q<g.length;q++){var e=g[q];if(l[e]>l[this.firstIndex]&&l[this.firstIndex]<0.4){this.firstIndex=e;if(this.firstIndex!=this.lastUpdatedIndex){this.lastUpdatedIndex=this.firstIndex}}}if(this.displayedIndices.length>0){this.updateLocationHash()}if((0!=r)&&(1<this.reduce)){r--;g.unshift(r)}var d=g[g.length-1];if(((this.numLeafs-1)!=d)&&(1<this.reduce)){g.push(d+1)}p=0;var q;for(q=0;q<r;q++){p+=parseInt(this._getPageHeight(q)/this.reduce)+10}var n=$("#BRcontainer").attr("scrollWidth");for(q=0;q<g.length;q++){var e=g[q];var j=parseInt(this._getPageHeight(e)/this.reduce);if(BookReader.util.notInArray(g[q],this.displayedIndices)){var m=parseInt(this._getPageWidth(e)/this.reduce);var h=document.createElement("div");h.className="BRpagediv1up";h.id="pagediv"+e;h.style.position="absolute";$(h).css("top",p+"px");var b=(n-m)>>1;if(b<0){b=0}$(h).css("left",b+"px");$(h).css("width",m+"px");$(h).css("height",j+"px");$("#BRpageview").append(h);var t=this.createContentElement(e,this.reduce,m,j);$(h).append(t)}else{}p+=j+10}for(q=0;q<this.displayedIndices.length;q++){if(BookReader.util.notInArray(this.displayedIndices[q],g)){var e=this.displayedIndices[q];$("#pagediv"+e).remove()}else{}}this.displayedIndices=g.slice();this.updateSearchHilites();if(null!=this.getPageNum(r)){this.updatePageNumBox()}else{$("#BRpagenum").val("")}this.updateToolbarZoom(this.reduce)};BookReader.prototype.drawLeafsThumbnail=function(C){this.timer=null;var M=$("#BRcontainer").attr("scrollWidth")-20;var J;var x;var F;var E=0;var q=0;var r=0;var p=0;var h=0;var O=[];var m=this;var w;for(J=0;J<this.numLeafs;J++){x=this.thumbWidth;if(E+(x+this.padding)>M){p++;E=0;h=0}if(O[p]===undefined){O[p]={}}if(O[p].leafs===undefined){O[p].leafs=[];O[p].height=0;O[p].top=0}O[p].leafs[h]={};O[p].leafs[h].num=J;O[p].leafs[h].left=E;F=parseInt((this.getPageHeight(O[p].leafs[h].num)*this.thumbWidth)/this.getPageWidth(O[p].leafs[h].num),10);if(F>O[p].height){O[p].height=F}if(h===0){q+=this.padding+O[p].height}E+=x+this.padding;if(E>r){r=E}h++;if(J==C){w=q-this.padding-O[p].height}}$("#BRpageview").height(q);var a=Math.floor(($("#BRcontainer").attr("scrollWidth")-r)/2)-14;if(typeof(w)!="undefined"){$("#BRcontainer").scrollTop(w)}var N=$("#BRcontainer").attr("scrollTop");var t=N+$("#BRcontainer").height();var y=0;var D=0;var u=[];var K=this.numLeafs-1;var d=0;for(J=0;J<O.length;J++){D+=this.padding+O[J].height;var H=(y>=N)&&(y<=t);var n=(D>=N)&&(D<=t);var f=(y<=N)&&(D>=t);if(H|n|f){u.push(J);if(O[J].leafs[0].num<K){K=O[J].leafs[0].num}if(O[J].leafs[O[J].leafs.length-1].num>d){d=O[J].leafs[O[J].leafs.length-1].num}}if(y>O[J].top){O[J].top=y}y=D}var o=u[0];var v=u[u.length-1];for(J=1;J<this.thumbRowBuffer+1;J++){if(v+J<O.length){u.push(v+J)}}for(J=1;J<this.thumbRowBuffer+1;J++){if(o-J>=0){u.push(o-J)}}var I;var s;var e;var A;var L;var g;var l;var b;for(J=0;J<u.length;J++){if(BookReader.util.notInArray(u[J],this.displayedRows)){s=u[J];for(I=0;I<O[s].leafs.length;I++){A=I;leaf=O[s].leafs[I].num;x=this.thumbWidth;F=parseInt((this.getPageHeight(leaf)*this.thumbWidth)/this.getPageWidth(leaf),10);y=O[s].top;e=O[s].leafs[A].left+a;if("rl"==this.pageProgression){e=M-x-e}L=document.createElement("div");L.id="pagediv"+leaf;L.style.position="absolute";L.className="BRpagedivthumb";e+=this.padding;$(L).css("top",y+"px");$(L).css("left",e+"px");$(L).css("width",x+"px");$(L).css("height",F+"px");g=document.createElement("a");$(g).data("leaf",leaf);$(g).bind("tap",function(i){m.firstIndex=$(this).data("leaf");m.switchMode(m.constMode1up);i.preventDefault()});var z="image of page "+this.getPageNum(leaf);g.href="#page/"+(this.getPageNum(leaf))+"/mode/1up";$(g).attr({title:z});$(L).append(g);$("#BRpageview").append(L);l=document.createElement("img");var B=Math.floor(this.getPageWidth(leaf)/this.thumbWidth);$(l).attr({src:this.imagesBaseURL+"transparent.png",title:z,alt:z}).css({width:x+"px",height:F+"px"}).addClass("BRlazyload").data("srcURL",this._getPageURI(leaf,B));$(g).append(l)}}}var G;for(J=0;J<this.displayedRows.length;J++){if(BookReader.util.notInArray(this.displayedRows[J],u)){s=this.displayedRows[J];for(G=0;G<O[s].leafs.length;G++){A=O[s].leafs[G].num;$("#pagediv"+A).remove()}}else{}}var c=this.currentIndex();if(c<K){this.setCurrentIndex(K)}else{if(c>d){this.setCurrentIndex(d)}}this.displayedRows=u.slice();if(this.displayedRows.length>0){this.updateLocationHash()}$(".BRpagedivthumb_highlight").removeClass("BRpagedivthumb_highlight");$("#pagediv"+this.currentIndex()).addClass("BRpagedivthumb_highlight");this.lazyLoadThumbnails();if(null!==this.getPageNum(this.currentIndex())){$("#BRpagenum").val(this.getPageNum(this.currentIndex()))}else{$("#BRpagenum").val("")}this.updateToolbarZoom(this.reduce)};BookReader.prototype.lazyLoadThumbnails=function(e){$(".BRlazyloading").filter("[complete=true]").removeClass("BRlazyloading");var g=$(".BRlazyloading").length;var d=this.thumbMaxLoading-g;var a=this;if(a.load_counter==null){a.load_counter=0}if(d>0){a.load_counter+=1;var b=new Date();var f=b.getTime()-e;var c=[b.getHours(),b.getMinutes(),b.getSeconds()];var a=this;$("#BRpageview img.BRlazyload").filter(":lt("+d+")").each(function(){console.log("THUMBNAIL:",a.load_counter,":",c.join(":"),f,":",g,"/",d,"<",a.thumbMaxLoading);a.lazyLoadImage(this)})}};BookReader.prototype.lazyLoadImage=function(c){var b=new Image();var a=this;$(b).addClass("BRlazyloading").one("load",function(){$(this).removeClass("BRlazyloading");var d=(new Date()).getTime();setTimeout(function(){a.lazyLoadThumbnails(d)},a.lazyDelay)}).one("error",function(){$(this).removeClass("BRlazyloading")}).attr({width:$(c).width(),height:$(c).height(),src:$(c).data("srcURL"),title:$(c).attr("title"),alt:$(c).attr("alt")});$(c).before(b).remove();b=null};BookReader.prototype.drawLeafsTwoPage=function(){var c=$("#BRtwopageview").attr("scrollTop");var b=c+$("#BRtwopageview").height();var g=this.twoPage.currentIndexL;var f=this._getPageHeight(g);var n=this._getPageWidth(g);var l=this.leafEdgeWidth(g);var h=this.twoPage.edgeWidth-l;var k=this.twoPage.bookCoverDivWidth;var m=this.twoPage.middle;var j=this.twoPageTop();var e=this.twoPage.bookCoverDivLeft;this.twoPage.scaledWL=this.getPageWidth2UP(g);this.twoPage.gutter=this.twoPageGutter();this.prefetchImg(g);$(this.prefetchedImgs[g]).css({position:"absolute",left:this.twoPage.gutter-this.twoPage.scaledWL+"px",right:"",top:j+"px",height:this.twoPage.height+"px",width:this.twoPage.scaledWL+"px",borderRight:"1px solid black",zIndex:2}).appendTo("#BRtwopageview");var d=this.twoPage.currentIndexR;var a=this._getPageHeight(d);var i=this._getPageWidth(d);this.twoPage.scaledWR=this.getPageWidth2UP(d);this.prefetchImg(d);$(this.prefetchedImgs[d]).css({position:"absolute",left:this.twoPage.gutter+"px",right:"",top:j+"px",height:this.twoPage.height+"px",width:this.twoPage.scaledWR+"px",borderLeft:"1px solid black",zIndex:2}).appendTo("#BRtwopageview");this.displayedIndices=[this.twoPage.currentIndexL,this.twoPage.currentIndexR];this.setMouseHandlers2UP();this.twoPageSetCursor();this.updatePageNumBox2UP();this.updateToolbarZoom(this.reduce)};BookReader.prototype.updatePageNumBox2UP=function(){if(null!=this.getPageNum(this.twoPage.currentIndexL)){this.updatePageNumBox()}else{$("#BRpagenum").val("")}this.updateLocationHash()};BookReader.prototype.loadLeafs=function(){var a=this;if(null==this.timer){this.timer=setTimeout(function(){a.drawLeafs()},250)}else{clearTimeout(this.timer);this.timer=setTimeout(function(){a.drawLeafs()},250)}};BookReader.prototype.zoom=function(a){switch(this.mode){case this.constMode1up:if(a==1){return this.zoom1up("in")}else{return this.zoom1up("out")}case this.constMode2up:if(a==1){return this.zoom2up("in")}else{return this.zoom2up("out")}case this.constModeThumb:return this.zoomThumb(a)}};BookReader.prototype.zoom1up=function(b){if(2==this.mode){this.switchMode(1);return}var a=this.nextReduce(this.reduce,b,this.onePage.reductionFactors);if(this.reduce==a.reduce){return}this.reduce=a.reduce;this.onePage.autofit=a.autofit;this.pageScale=this.reduce;this.resizePageView();$("#BRpageview").empty();this.displayedIndices=[];this.loadLeafs();this.updateToolbarZoom(this.reduce);this.removeSearchHilites();this.updateSearchHilites()};BookReader.prototype.resizePageView=function(){switch(this.mode){case this.constMode1up:case this.constMode2up:this.resizePageView1up();break;case this.constModeThumb:this.prepareThumbnailView(this.currentIndex());break;default:alert("Resize not implemented for this mode")}};BookReader.prototype.resizePageView1up=function(){var h;var c=0;var k=$("#BRcontainer").attr("clientWidth");var e=$("#BRcontainer").attr("scrollTop");var l=$("#BRcontainer").attr("scrollLeft");var q=$("#BRpageview").height();var m=$("#BRpageview").width();var d=this.centerY1up();var g=this.centerX1up();if(0!=q){var p=d/q}else{var p=0}this.onePageCalculateReductionFactors($("#BRcontainer").attr("clientWidth"),$("#BRcontainer").attr("clientHeight"));if(this.onePage.autofit){var b=this.nextReduce(this.reduce,this.onePage.autofit,this.onePage.reductionFactors);this.reduce=b.reduce}for(h=0;h<this.numLeafs;h++){c+=parseInt(this._getPageHeight(h)/this.reduce)+this.padding;var a=parseInt(this._getPageWidth(h)/this.reduce);if(a>k){k=a}}$("#BRpageview").height(c);$("#BRpageview").width(k);var f=p*c;var n=Math.max(0,Math.floor(f-$("#BRcontainer").height()/2));$("#BRcontainer").attr("scrollTop",n);var j=g*(k/m);var o=j-$("#BRcontainer").attr("clientWidth")/2;o=Math.max(o,0);$("#BRcontainer").attr("scrollLeft",o);this.loadLeafs();this.removeSearchHilites();this.updateSearchHilites()};BookReader.prototype.centerX1up=function(){var a;if($("#BRpageview").width()<$("#BRcontainer").attr("clientWidth")){a=$("#BRpageview").width()}else{a=$("#BRcontainer").attr("scrollLeft")+$("#BRcontainer").attr("clientWidth")/2}a=Math.floor(a);return a};BookReader.prototype.centerY1up=function(){var a=$("#BRcontainer").attr("scrollTop")+$("#BRcontainer").height()/2;return Math.floor(a)};BookReader.prototype.centerPageView=function(){var a=$("#BRcontainer").attr("scrollWidth");var b=$("#BRcontainer").attr("clientWidth");if(a>b){$("#BRcontainer").attr("scrollLeft",(a-b)/2)}};BookReader.prototype.zoom2up=function(c){this.stopFlipAnimations();this.twoPageCalculateReductionFactors();var a=this.nextReduce(this.reduce,c,this.twoPage.reductionFactors);if((this.reduce==a.reduce)&&(this.twoPage.autofit==a.autofit)){return}this.twoPage.autofit=a.autofit;this.reduce=a.reduce;this.pageScale=this.reduce;var d=this.twoPageGetViewCenter();if(1==c){for(var b in this.prefetchedImgs){delete this.prefetchedImgs[b]}}this.prepareTwoPageView(d.percentageX,d.percentageY)};BookReader.prototype.zoomThumb=function(b){var a=this.thumbColumns;switch(b){case -1:this.thumbColumns+=1;break;case 1:this.thumbColumns-=1;break}if(this.thumbColumns<2){this.thumbColumns=2}else{if(this.thumbColumns>8){this.thumbColumns=8}}if(this.thumbColumns!=a){this.prepareThumbnailView()}};BookReader.prototype.getThumbnailWidth=function(a){var c=(a+1)*this.padding;var b=($("#BRpageview").width()-c)/(a+0.5);return parseInt(b)};BookReader.prototype.quantizeReduce=function(d,c){var b=c[0].reduce;var e=Math.abs(d-b);for(var a=1;a<c.length;a++){newDistance=Math.abs(d-c[a].reduce);if(newDistance<e){e=newDistance;b=c[a].reduce}}return b};BookReader.prototype.nextReduce=function(d,c,b){if(c=="in"){var f=0;for(var a=1;a<b.length;a++){if(b[a].reduce<d){f=a}}return b[f]}else{if(c=="out"){var e=b.length-1;var f=e;for(var a=e;a>=0;a--){if(b[a].reduce>d){f=a}}return b[f]}}for(var a=0;a<b.length;a++){if(b[a].autofit==c){return b[a]}}alert("Could not find reduction factor for direction "+c);return b[0]};BookReader.prototype._reduceSort=function(d,c){return d.reduce-c.reduce};BookReader.prototype.jumpToPage=function(d){var a=this.getPageIndex(d);if("undefined"!=typeof(a)){var b=0;var c;this.jumpToIndex(a);$("#BRcontainer").attr("scrollTop",b);return true}return false};BookReader.prototype.jumpToIndex=function(l,e,b){if(this.constMode2up==this.mode){this.autoStop();if(l<Math.min(this.twoPage.currentIndexL,this.twoPage.currentIndexR)){this.flipBackToIndex(l)}else{if(l>Math.max(this.twoPage.currentIndexL,this.twoPage.currentIndexR)){this.flipFwdToIndex(l)}}}else{if(this.constModeThumb==this.mode){var k=$("#BRcontainer").attr("scrollWidth")-20;var g;var d=0;var q=0;var m=0;var n=0;var a=0;var f=0;var p=0;for(g=0;g<(l+1);g++){d=this.thumbWidth;if(m+(d+this.padding)>k){m=0;a=0;p=0}q=parseInt((this.getPageHeight(p)*this.thumbWidth)/this.getPageWidth(p),10);if(q>a){a=q}if(p==0){f=n}if(p==0){n+=this.padding+a}m+=d+this.padding;p++}this.firstIndex=l;if($("#BRcontainer").attr("scrollTop")==f){this.loadLeafs()}else{$("#BRcontainer").animate({scrollTop:f},"fast")}}else{var g;var f=0;var o=0;var j;for(g=0;g<l;g++){j=parseInt(this._getPageHeight(g)/this.reduce);f+=j+this.padding}if(b){var c=parseInt((b)/this.reduce);c-=$("#BRcontainer").attr("clientHeight")>>1;f+=c}else{f-=this.padding/2}if(e){var c=parseInt((e)/this.reduce);c-=$("#BRcontainer").attr("clientWidth")>>1;o+=c}else{o=$("#BRcontainer").scrollLeft()}$("#BRcontainer").animate({scrollTop:f,scrollLeft:o},"fast")}}};BookReader.prototype.switchMode=function(a){if(a==this.mode){return}if(!this.canSwitchToMode(a)){return}this.autoStop();this.removeSearchHilites();this.mode=a;this.switchToolbarMode(a);if(this.pageScale!=this.reduce){this.reduce=this.pageScale}if(1==a){this.onePageCalculateReductionFactors($("#BRcontainer").attr("clientWidth"),$("#BRcontainer").attr("clientHeight"));this.reduce=this.quantizeReduce(this.reduce,this.onePage.reductionFactors);this.prepareOnePageView()}else{if(3==a){this.reduce=this.quantizeReduce(this.reduce,this.reductionFactors);this.prepareThumbnailView()}else{this.twoPage.autofit=false;this.twoPageCalculateReductionFactors();this.reduce=this.quantizeReduce(this.reduce,this.twoPage.reductionFactors);this.prepareTwoPageView();this.twoPageCenterView(0.5,0.5)}}};BookReader.prototype.prepareOnePageView=function(){var a=this.currentIndex();$("#BRcontainer").empty();$("#BRcontainer").css({overflowY:"scroll",overflowX:"auto"});$("#BRcontainer").append("<div id='BRpageview'></div>");$("#BRcontainer").dragscrollable();this.bindGestures($("#BRcontainer"));this.resizePageView();this.jumpToIndex(a);this.displayedIndices=[];this.drawLeafsOnePage()};BookReader.prototype.prepareThumbnailView=function(){$("#BRcontainer").empty();$("#BRcontainer").css({overflowY:"scroll",overflowX:"auto"});$("#BRcontainer").append("<div id='BRpageview'></div>");$("#BRcontainer").dragscrollable();this.bindGestures($("#BRcontainer"));this.thumbWidth=this.getThumbnailWidth(this.thumbColumns);this.reduce=this.getPageWidth(0)/this.thumbWidth;this.displayedRows=[];this.drawLeafsThumbnail(this.currentIndex())};BookReader.prototype.prepareTwoPageView=function(e,b){$("#BRcontainer").empty();$("#BRcontainer").css("overflow","auto");var d=this.firstIndex;if(d<this.firstDisplayableIndex()){d=this.firstDisplayableIndex()}if(d>this.lastDisplayableIndex()){d=this.lastDisplayableIndex()}var c=this.getSpreadIndices(d);this.twoPage.currentIndexL=c[0];this.twoPage.currentIndexR=c[1];this.firstIndex=this.twoPage.currentIndexL;this.calculateSpreadSize();this.pruneUnusedImgs();this.prefetch();$("#BRcontainer").append('<div id="BRtwopageview"></div>');$("#BRcontainer").dragscrollable();this.bindGestures($("#BRcontainer"));$("#BRtwopageview").css({height:this.twoPage.totalHeight+"px",width:this.twoPage.totalWidth+"px",position:"absolute"});if(this.twoPage.totalWidth<$("#BRcontainer").attr("clientWidth")){e=0.5}if(this.twoPage.totalHeight<$("#BRcontainer").attr("clientHeight")){b=0.5}this.twoPageCenterView(e,b);this.twoPage.coverDiv=document.createElement("div");$(this.twoPage.coverDiv).attr("id","BRbookcover").css({width:this.twoPage.bookCoverDivWidth+"px",height:this.twoPage.bookCoverDivHeight+"px",visibility:"visible",position:"absolute",left:this.twoPage.bookCoverDivLeft+"px",top:this.twoPage.bookCoverDivTop+"px"}).appendTo("#BRtwopageview");this.leafEdgeR=document.createElement("div");this.leafEdgeR.className="BRleafEdgeR";$(this.leafEdgeR).css({width:this.twoPage.leafEdgeWidthR+"px",height:this.twoPage.height-1+"px",left:this.twoPage.gutter+this.twoPage.scaledWR+"px",top:this.twoPage.bookCoverDivTop+this.twoPage.coverInternalPadding+"px"}).appendTo("#BRtwopageview");this.leafEdgeL=document.createElement("div");this.leafEdgeL.className="BRleafEdgeL";$(this.leafEdgeL).css({width:this.twoPage.leafEdgeWidthL+"px",height:this.twoPage.height-1+"px",left:this.twoPage.bookCoverDivLeft+this.twoPage.coverInternalPadding+"px",top:this.twoPage.bookCoverDivTop+this.twoPage.coverInternalPadding+"px"}).appendTo("#BRtwopageview");div=document.createElement("div");$(div).attr("id","BRbookspine").css({width:this.twoPage.bookSpineDivWidth+"px",height:this.twoPage.bookSpineDivHeight+"px",left:this.twoPage.bookSpineDivLeft+"px",top:this.twoPage.bookSpineDivTop+"px"}).appendTo("#BRtwopageview");var a=this;this.prepareTwoPagePopUp();this.displayedIndices=[];this.drawLeafsTwoPage();this.updateToolbarZoom(this.reduce);this.prefetch();this.removeSearchHilites();this.updateSearchHilites()};BookReader.prototype.prepareTwoPagePopUp=function(){this.twoPagePopUp=document.createElement("div");this.twoPagePopUp.className="BRtwoPagePopUp";$(this.twoPagePopUp).css({zIndex:"1000"}).appendTo("#BRcontainer");$(this.twoPagePopUp).hide();$(this.leafEdgeL).add(this.leafEdgeR).bind("mouseenter",this,function(a){$(a.data.twoPagePopUp).show()});$(this.leafEdgeL).add(this.leafEdgeR).bind("mouseleave",this,function(a){$(a.data.twoPagePopUp).hide()});$(this.leafEdgeL).bind("click",this,function(b){b.data.autoStop();var a=b.data.jumpIndexForLeftEdgePageX(b.pageX);b.data.jumpToIndex(a)});$(this.leafEdgeR).bind("click",this,function(b){b.data.autoStop();var a=b.data.jumpIndexForRightEdgePageX(b.pageX);b.data.jumpToIndex(a)});$(this.leafEdgeR).bind("mousemove",this,function(b){var a=b.data.jumpIndexForRightEdgePageX(b.pageX);$(b.data.twoPagePopUp).text("View "+b.data.getPageName(a));$(b.data.twoPagePopUp).css({left:b.pageX-$("#BRcontainer").offset().left+$("#BRcontainer").scrollLeft()+20+"px",top:b.pageY-$("#BRcontainer").offset().top+$("#BRcontainer").scrollTop()+"px"})});$(this.leafEdgeL).bind("mousemove",this,function(b){var a=b.data.jumpIndexForLeftEdgePageX(b.pageX);$(b.data.twoPagePopUp).text("View "+b.data.getPageName(a));$(b.data.twoPagePopUp).css({left:b.pageX-$("#BRcontainer").offset().left+$("#BRcontainer").scrollLeft()-$(b.data.twoPagePopUp).width()-25+"px",top:b.pageY-$("#BRcontainer").offset().top+$("#BRcontainer").scrollTop()+"px"})})};BookReader.prototype.calculateSpreadSize=function(){var a=this.twoPage.currentIndexL;var d=this.twoPage.currentIndexR;var c;if(this.twoPage.autofit){c=this.getIdealSpreadSize(a,d)}else{c=this.getSpreadSizeFromReduce(a,d,this.reduce)}this.twoPage.height=c.height;this.twoPage.width=c.width;this.twoPage.scaledWL=this.getPageWidth2UP(a);this.twoPage.scaledWR=this.getPageWidth2UP(d);this.twoPage.edgeWidth=c.totalLeafEdgeWidth;this.twoPage.leafEdgeWidthL=this.leafEdgeWidth(this.twoPage.currentIndexL);this.twoPage.leafEdgeWidthR=this.twoPage.edgeWidth-this.twoPage.leafEdgeWidthL;this.twoPage.bookCoverDivWidth=this.twoPage.scaledWL+this.twoPage.scaledWR+2*this.twoPage.coverInternalPadding+this.twoPage.edgeWidth;this.twoPage.bookCoverDivHeight=this.twoPage.height+2*this.twoPage.coverInternalPadding;var g=this.gutterOffsetForIndex(a);var b=this.twoPage.scaledWL-g+this.twoPage.leafEdgeWidthL;var f=this.twoPage.scaledWR+g+this.twoPage.leafEdgeWidthR;var e=Math.max(b,f);this.twoPage.totalWidth=2*(e+this.twoPage.coverInternalPadding+this.twoPage.coverExternalPadding);this.twoPage.totalHeight=this.twoPage.height+2*(this.twoPage.coverInternalPadding+this.twoPage.coverExternalPadding);this.twoPage.middle=this.twoPage.totalWidth>>1;this.twoPage.gutter=this.twoPage.middle+this.gutterOffsetForIndex(a);this.twoPage.bookCoverDivLeft=this.twoPage.gutter-this.twoPage.scaledWL-this.twoPage.leafEdgeWidthL-this.twoPage.coverInternalPadding;this.twoPage.bookCoverDivTop=this.twoPage.coverExternalPadding;this.twoPage.bookSpineDivHeight=this.twoPage.height+2*this.twoPage.coverInternalPadding;this.twoPage.bookSpineDivLeft=this.twoPage.middle-(this.twoPage.bookSpineDivWidth>>1);this.twoPage.bookSpineDivTop=this.twoPage.bookCoverDivTop;this.reduce=c.reduce};BookReader.prototype.getIdealSpreadSize=function(b,a){var e={};var m=1.5;var h={height:this._getPageHeight(b),width:this._getPageWidth(b)};var d={height:this._getPageHeight(a),width:this._getPageWidth(a)};var j=h.height/h.width;var g=d.height/d.width;var i;if(Math.abs(j-m)<Math.abs(g-m)){i=j}else{i=g}var l=parseInt(this.numLeafs*0.1);var k=parseInt($("#BRcontainer").attr("clientWidth")*0.1);e.totalLeafEdgeWidth=Math.min(l,k);var c=2*(this.twoPage.coverInternalPadding+this.twoPage.coverExternalPadding)+e.totalLeafEdgeWidth;var f=2*(this.twoPage.coverInternalPadding+this.twoPage.coverExternalPadding);e.width=($("#BRcontainer").width()-c)>>1;e.width-=10;e.height=$("#BRcontainer").height()-f;e.height-=20;if(e.height/i<=e.width){e.width=parseInt(e.height/i)}else{e.height=parseInt(e.width*i)}e.reduce=((h.height+d.height)/2)/e.height;return e};BookReader.prototype.getSpreadSizeFromReduce=function(a,e,g){var d={};var f=parseInt(this.numLeafs*0.1);var c=parseInt($("#BRcontainer").attr("clientWidth")*0.1);d.totalLeafEdgeWidth=Math.min(f,c);var h=this._getPageWidth(a)+this._getPageWidth(e);var b=this._getPageHeight(a)+this._getPageHeight(e);d.height=parseInt((b/2)/this.reduce);d.width=parseInt((h/2)/this.reduce);d.reduce=g;return d};BookReader.prototype.twoPageGetAutofitReduce=function(){var a=this.getIdealSpreadSize(this.twoPage.currentIndexL,this.twoPage.currentIndexR);return a.reduce};BookReader.prototype.onePageGetAutofitWidth=function(){var a=20;return(this.getMedianPageSize().width+0)/($("#BRcontainer").attr("clientWidth")-a*2)};BookReader.prototype.onePageGetAutofitHeight=function(){return(this.getMedianPageSize().height+0)/($("#BRcontainer").attr("clientHeight")-this.padding*2)};BookReader.prototype.getMedianPageSize=function(){if(this._medianPageSize){return this._medianPageSize}var b=[];var c=[];for(var a=0;a<this.numLeafs;a++){b.push(this.getPageWidth(a));c.push(this.getPageHeight(a))}b.sort();c.sort();this._medianPageSize={width:b[parseInt(b.length/2)],height:c[parseInt(c.length/2)]};return this._medianPageSize};BookReader.prototype.onePageCalculateReductionFactors=function(b,a){this.onePage.reductionFactors=this.reductionFactors.concat([{reduce:this.onePageGetAutofitWidth(),autofit:"width"},{reduce:this.onePageGetAutofitHeight(),autofit:"height"}]);this.onePage.reductionFactors.sort(this._reduceSort)};BookReader.prototype.twoPageCalculateReductionFactors=function(){this.twoPage.reductionFactors=this.reductionFactors.concat([{reduce:this.getIdealSpreadSize(this.twoPage.currentIndexL,this.twoPage.currentIndexR).reduce,autofit:"auto"}]);this.twoPage.reductionFactors.sort(this._reduceSort)};BookReader.prototype.twoPageSetCursor=function(){if(($("#BRtwopageview").width()>$("#BRcontainer").attr("clientWidth"))||($("#BRtwopageview").height()>$("#BRcontainer").attr("clientHeight"))){$(this.prefetchedImgs[this.twoPage.currentIndexL]).css("cursor","move");$(this.prefetchedImgs[this.twoPage.currentIndexR]).css("cursor","move")}else{$(this.prefetchedImgs[this.twoPage.currentIndexL]).css("cursor","");$(this.prefetchedImgs[this.twoPage.currentIndexR]).css("cursor","")}};BookReader.prototype.currentIndex=function(){if(this.mode==this.constMode1up||this.mode==this.constModeThumb){return this.firstIndex}else{if(this.mode==this.constMode2up){return BookReader.util.clamp(this.firstIndex,0,this.numLeafs-1)}else{throw"currentIndex called for unimplemented mode "+this.mode}}};BookReader.prototype.setCurrentIndex=function(a){this.firstIndex=a};BookReader.prototype.right=function(){if("rl"!=this.pageProgression){this.next()}else{this.prev()}};BookReader.prototype.rightmost=function(){if("rl"!=this.pageProgression){this.last()}else{this.first()}};BookReader.prototype.left=function(){if("rl"!=this.pageProgression){this.prev()}else{this.next()}};BookReader.prototype.leftmost=function(){if("rl"!=this.pageProgression){this.first()}else{this.last()}};BookReader.prototype.next=function(){if(2==this.mode){this.autoStop();this.flipFwdToIndex(null)}else{if(this.firstIndex<this.lastDisplayableIndex()){this.jumpToIndex(this.firstIndex+1)}}};BookReader.prototype.prev=function(){if(2==this.mode){this.autoStop();this.flipBackToIndex(null)}else{if(this.firstIndex>=1){this.jumpToIndex(this.firstIndex-1)}}};BookReader.prototype.first=function(){this.jumpToIndex(this.firstDisplayableIndex())};BookReader.prototype.last=function(){this.jumpToIndex(this.lastDisplayableIndex())};BookReader.prototype.scrollDown=function(){if($.inArray(this.mode,[this.constMode1up,this.constModeThumb])>=0){if(this.mode==this.constMode1up&&(this.reduce>=this.onePageGetAutofitHeight())){return this.next()}$("#BRcontainer").animate({scrollTop:"+="+this._scrollAmount()+"px"},400,"easeInOutExpo");return true}else{return false}};BookReader.prototype.scrollUp=function(){if($.inArray(this.mode,[this.constMode1up,this.constModeThumb])>=0){if(this.mode==this.constMode1up&&(this.reduce>=this.onePageGetAutofitHeight())){return this.prev()}$("#BRcontainer").animate({scrollTop:"-="+this._scrollAmount()+"px"},400,"easeInOutExpo");return true}else{return false}};BookReader.prototype._scrollAmount=function(){if(this.constMode1up==this.mode){return parseInt($("#BRcontainer").attr("clientHeight")-this.getPageHeight(this.currentIndex())/this.reduce*0.03)}return parseInt(0.9*$("#BRcontainer").attr("clientHeight"))};BookReader.prototype.flipBackToIndex=function(a){if(1==this.mode){return}var b=this.twoPage.currentIndexL;if(this.animating){return}if(null!=this.leafEdgeTmp){alert("error: leafEdgeTmp should be null!");return}if(null==a){a=b-2}var d=this.getSpreadIndices(a);if(d[0]<this.firstDisplayableIndex()||d[1]<this.firstDisplayableIndex()){return}this.animating=true;if("rl"!=this.pageProgression){this.prepareFlipLeftToRight(d[0],d[1]);this.flipLeftToRight(d[0],d[1])}else{var c=this.prepareFlipRightToLeft(d[0],d[1]);this.flipRightToLeft(d[0],d[1],c)}};BookReader.prototype.flipLeftToRight=function(i,e){var g=this.twoPage.currentIndexL;var d=this.leafEdgeWidth(this.twoPage.currentIndexL);var f=this.leafEdgeWidth(i);var k=d-f;var n=this.getPageWidth2UP(g);var a=this.getPageWidth2UP(i);var m=this.getPageWidth2UP(e);var j=this.twoPageTop();var c=this.twoPage.middle+this.gutterOffsetForIndex(i);var h=c-n-k;this.leafEdgeTmp=document.createElement("div");this.leafEdgeTmp.className="BRleafEdgeTmp";$(this.leafEdgeTmp).css({width:k+"px",height:this.twoPage.height-1+"px",left:h+"px",top:j+"px",zIndex:1000}).appendTo("#BRtwopageview");$(this.leafEdgeL).css({width:f+"px",left:c-n-f+"px"});var b=$(this.prefetchedImgs[g]).offset().left;var l=$("#BRtwopageview").attr("clientWidth")-b-$(this.prefetchedImgs[g]).width()+$("#BRtwopageview").offset().left-2+"px";$(this.prefetchedImgs[g]).css({right:l,left:""});$(this.leafEdgeTmp).animate({left:c},this.flipSpeed,"easeInSine");var o=this;this.removeSearchHilites();$(this.prefetchedImgs[g]).animate({width:"0px"},o.flipSpeed,"easeInSine",function(){$(o.leafEdgeTmp).animate({left:c+m+"px"},o.flipSpeed,"easeOutSine");$(o.prefetchedImgs[e]).animate({width:m+"px"},o.flipSpeed,"easeOutSine",function(){$(o.prefetchedImgs[i]).css("zIndex",2);$(o.leafEdgeR).css({width:o.twoPage.edgeWidth-f+"px",left:c+m+"px"});$(o.leafEdgeL).css({width:f+"px",left:c-a-f+"px"});$(o.twoPage.coverDiv).css({width:o.twoPageCoverWidth(a+m)+"px",left:c-a-f-o.twoPage.coverInternalPadding+"px"});$(o.leafEdgeTmp).remove();o.leafEdgeTmp=null;o.twoPage.currentIndexL=i;o.twoPage.currentIndexR=e;o.twoPage.scaledWL=a;o.twoPage.scaledWR=m;o.twoPage.gutter=c;o.firstIndex=o.twoPage.currentIndexL;o.displayedIndices=[i,e];o.pruneUnusedImgs();o.prefetch();o.animating=false;o.updateSearchHilites2UP();o.updatePageNumBox2UP();o.setMouseHandlers2UP();o.twoPageSetCursor();if(o.animationFinishedCallback){o.animationFinishedCallback();o.animationFinishedCallback=null}})})};BookReader.prototype.flipFwdToIndex=function(b){if(this.animating){return}if(null!=this.leafEdgeTmp){alert("error: leafEdgeTmp should be null!");return}if(null==b){b=this.twoPage.currentIndexR+2}if(b>this.lastDisplayableIndex()){return}this.animating=true;var a=this.getSpreadIndices(b);if("rl"!=this.pageProgression){var c=this.prepareFlipRightToLeft(a[0],a[1]);this.flipRightToLeft(a[0],a[1],c)}else{var c=this.prepareFlipLeftToRight(a[0],a[1]);this.flipLeftToRight(a[0],a[1])}};BookReader.prototype.flipRightToLeft=function(j,g){var f=this.leafEdgeWidth(this.twoPage.currentIndexL);var a=this.twoPage.edgeWidth-f;var i=this.leafEdgeWidth(j);var c=this.twoPage.edgeWidth-i;var l=a-c;var m=this.twoPageTop();var h=this.getPageWidth2UP(this.twoPage.currentIndexR);var q=this.twoPage.middle;var e=q+this.gutterOffsetForIndex(j);this.leafEdgeTmp=document.createElement("div");this.leafEdgeTmp.className="BRleafEdgeTmp";$(this.leafEdgeTmp).css({width:l+"px",height:this.twoPage.height-1+"px",left:e+h+"px",top:m+"px",zIndex:1000}).appendTo("#BRtwopageview");var o=this.getPageWidth2UP(this.twoPage.currentIndexL);var k=this.getPageWidth2UP(this.twoPage.currentIndexR);var b=this.getPageWidth2UP(j);var n=this.getPageWidth2UP(g);$(this.leafEdgeR).css({width:c+"px",left:e+n+"px"});var p=this;var d=this.flipSpeed;this.removeSearchHilites();$(this.leafEdgeTmp).animate({left:e},d,"easeInSine");$(this.prefetchedImgs[this.twoPage.currentIndexR]).animate({width:"0px"},d,"easeInSine",function(){$(p.leafEdgeTmp).animate({left:e-b-l+"px"},d,"easeOutSine");$(p.prefetchedImgs[j]).animate({width:b+"px"},d,"easeOutSine",function(){$(p.prefetchedImgs[g]).css("zIndex",2);$(p.leafEdgeL).css({width:i+"px",left:e-b-i+"px"});$(p.twoPage.coverDiv).css({width:p.twoPageCoverWidth(b+n)+"px",left:e-b-i-p.twoPage.coverInternalPadding+"px"});$(p.leafEdgeTmp).remove();p.leafEdgeTmp=null;p.twoPage.currentIndexL=j;p.twoPage.currentIndexR=g;p.twoPage.scaledWL=b;p.twoPage.scaledWR=n;p.twoPage.gutter=e;p.firstIndex=p.twoPage.currentIndexL;p.displayedIndices=[j,g];p.pruneUnusedImgs();p.prefetch();p.animating=false;p.updateSearchHilites2UP();p.updatePageNumBox2UP();p.setMouseHandlers2UP();p.twoPageSetCursor();if(p.animationFinishedCallback){p.animationFinishedCallback();p.animationFinishedCallback=null}})})};BookReader.prototype.setMouseHandlers2UP=function(){this.setClickHandler2UP(this.prefetchedImgs[this.twoPage.currentIndexL],{self:this},function(a){a.data.self.left();a.preventDefault()});this.setClickHandler2UP(this.prefetchedImgs[this.twoPage.currentIndexR],{self:this},function(a){a.data.self.right();a.preventDefault()})};BookReader.prototype.prefetchImg=function(c){var a=this._getPageURI(c);var d=false;if(undefined==this.prefetchedImgs[c]){d=true}else{if(a!=this.prefetchedImgs[c].uri){d=true}}if(d){var b=document.createElement("img");b.className="BRpageimage";if(c<0||c>(this.numLeafs-1)){$(b).css({"background-color":"transparent"})}var e="image of page "+this.getPageNum(c);b.src=a;b.uri=a;$(b).attr({title:e,alt:e});this.prefetchedImgs[c]=b}};BookReader.prototype.prepareFlipLeftToRight=function(h,b){this.prefetchImg(h);this.prefetchImg(b);var a=this._getPageHeight(h);var d=this._getPageWidth(h);var c=this.twoPage.middle;var g=this.twoPageTop();var e=this.twoPage.height*d/a;var f=c+this.gutterOffsetForIndex(h);leftCSS={position:"absolute",left:f-e+"px",right:"",top:g+"px",height:this.twoPage.height,width:e+"px",borderRight:"1px solid black",zIndex:1};$(this.prefetchedImgs[h]).css(leftCSS);$("#BRtwopageview").append(this.prefetchedImgs[h]);rightCSS={position:"absolute",left:f+"px",right:"",top:g+"px",height:this.twoPage.height,width:"0px",borderLeft:"1px solid black",zIndex:2};$(this.prefetchedImgs[b]).css(rightCSS);$("#BRtwopageview").append(this.prefetchedImgs[b])};BookReader.prototype.prepareFlipRightToLeft=function(h,c){this.prefetchImg(h);this.prefetchImg(c);var a=this._getPageHeight(c);var d=this._getPageWidth(c);var b=this.twoPage.middle;var g=this.twoPageTop();var e=this.twoPage.height*d/a;var f=b+this.gutterOffsetForIndex(h);$(this.prefetchedImgs[c]).css({position:"absolute",left:f+"px",top:g+"px",height:this.twoPage.height,width:e+"px",borderLeft:"1px solid black",zIndex:1});$("#BRtwopageview").append(this.prefetchedImgs[c]);a=this._getPageHeight(h);d=this._getPageWidth(h);e=this.twoPage.height*d/a;$(this.prefetchedImgs[h]).css({position:"absolute",right:$("#BRtwopageview").attr("clientWidth")-f+"px",top:g+"px",height:this.twoPage.height,width:0+"px",borderRight:"1px solid black",zIndex:2});$("#BRtwopageview").append(this.prefetchedImgs[h])};BookReader.prototype.pruneUnusedImgs=function(){for(var a in this.prefetchedImgs){if((a!=this.twoPage.currentIndexL)&&(a!=this.twoPage.currentIndexR)){$(this.prefetchedImgs[a]).remove()}if((a<this.twoPage.currentIndexL-4)||(a>this.twoPage.currentIndexR+4)){delete this.prefetchedImgs[a]}}};BookReader.prototype.prefetch=function(){this.prefetchImg(this.twoPage.currentIndexL);this.prefetchImg(this.twoPage.currentIndexR);var b=3;var d=Math.min(this.twoPage.currentIndexL,this.twoPage.currentIndexR);var g=Math.max(this.twoPage.currentIndexL,this.twoPage.currentIndexR);var h=Math.max(d-b,0);var a=Math.min(g+b,this.numLeafs-1);for(var c=1;c<=b;c++){var f=d-c;if(f>=h){this.prefetchImg(f)}var e=g+c;if(e<=a){this.prefetchImg(e)}}};BookReader.prototype.getPageWidth2UP=function(b){var a=this._getPageHeight(b);var c=this._getPageWidth(b);var d;d=this.twoPage.height*c/a;return Math.floor(this.twoPage.height*c/a)};BookReader.prototype.search=function(b){b=b.replace(/\//g," ");this.searchTerm=b;$("#BookReaderSearchScript").remove();var a=document.createElement("script");a.setAttribute("id","BookReaderSearchScript");a.setAttribute("type","text/javascript");a.setAttribute("src","http://"+this.server+"/BookReader/flipbook_search_br.php?url="+escape(this.bookPath+"_djvu.xml")+"&term="+b+"&format=XML&callback=br.BRSearchCallback");document.getElementsByTagName("head")[0].appendChild(a);$("#BookReaderSearchBox").val(b);$("#BookReaderSearchResults").html("Searching...")};BookReader.prototype.BRSearchCallback=function(m){if(jQuery.browser.msie){var k=new ActiveXObject("Microsoft.XMLDOM");k.async="false";k.loadXML(m)}else{var c=new DOMParser();var k=c.parseFromString(m,"text/xml")}$("#BookReaderSearchResults").empty();$("#BookReaderSearchResults").append("<ul>");for(var q in this.searchResults){if(null!=this.searchResults[q].div){$(this.searchResults[q].div).remove()}delete this.searchResults[q]}var g=k.getElementsByTagName("PAGE");if(0==g.length){$("#BookReaderSearchResults").append("<li>No search results found</li>")}else{for(var l=0;l<g.length;l++){var r=new RegExp(/_(\d{4})\.djvu/);var d=r.exec(g[l].getAttribute("file"));var n=parseInt(d[1],10);var f=g[l].childNodes;var e="";for(var h=0;h<f.length;h++){if("CONTEXT"==f[h].nodeName){e+=f[h].firstChild.nodeValue}else{if("WORD"==f[h].nodeName){e+="<b>"+f[h].firstChild.nodeValue+"</b>";var n=this.leafNumToIndex(n);if(null!=n){var p=f[h].getAttribute("coords").split(",",4);if(4==p.length){this.searchResults[n]={l:parseInt(p[0]),b:parseInt(p[1]),r:parseInt(p[2]),t:parseInt(p[3]),div:null}}}}}}var o=this.getPageName(n);var b=(this.searchResults[n].l+this.searchResults[n].r)>>1;var a=(this.searchResults[n].t+this.searchResults[n].b)>>1;$("#BookReaderSearchResults").append('<li><b><a href="javascript:br.jumpToIndex('+n+","+b+","+a+');">'+o+"</a></b> - "+e+"</li>")}}$("#BookReaderSearchResults").append("</ul>");$("#BookReaderSearchBox").val(this.searchTerm);this.updateSearchHilites()};BookReader.prototype.updateSearchHilites=function(){if(2==this.mode){this.updateSearchHilites2UP()}else{this.updateSearchHilites1UP()}};BookReader.prototype.updateSearchHilites1UP=function(){for(var b in this.searchResults){if(jQuery.inArray(parseInt(b),this.displayedIndices)>=0){var a=this.searchResults[b];if(null==a.div){a.div=document.createElement("div");$(a.div).attr("className","BookReaderSearchHilite").appendTo("#pagediv"+b)}$(a.div).css({width:(a.r-a.l)/this.reduce+"px",height:(a.b-a.t)/this.reduce+"px",left:(a.l)/this.reduce+"px",top:(a.t)/this.reduce+"px"})}else{this.searchResults[b].div=null}}};BookReader.prototype.twoPageGutter=function(){return this.twoPage.middle+this.gutterOffsetForIndex(this.twoPage.currentIndexL)};BookReader.prototype.twoPageTop=function(){return this.twoPage.coverExternalPadding+this.twoPage.coverInternalPadding};BookReader.prototype.twoPageCoverWidth=function(a){return a+this.twoPage.edgeWidth+2*this.twoPage.coverInternalPadding};BookReader.prototype.twoPageGetViewCenter=function(){var a={};var c=$("#BRcontainer").offset();var b=$("#BRtwopageview").offset();a.percentageX=(c.left-b.left+($("#BRcontainer").attr("clientWidth")>>1))/this.twoPage.totalWidth;a.percentageY=(c.top-b.top+($("#BRcontainer").attr("clientHeight")>>1))/this.twoPage.totalHeight;return a};BookReader.prototype.twoPageCenterView=function(f,d){if("undefined"==typeof(f)){f=0.5}if("undefined"==typeof(d)){d=0.5}var c=$("#BRtwopageview").width();var h=$("#BRcontainer").attr("clientWidth");var g=f*c;var b=$("#BRtwopageview").height();var a=$("#BRcontainer").attr("clientHeight");var e=d*b;if(c<h){$("#BRtwopageview").css("left",(h>>1)-g+"px")}else{$("#BRtwopageview").css("left",0);$("#BRcontainer").scrollLeft(g-(h>>1))}if(b<a){$("#BRtwopageview").css("top",(a>>1)-e+"px")}else{$("#BRtwopageview").css("top",0);$("#BRcontainer").scrollTop(e-(a>>1))}};BookReader.prototype.twoPageFlipAreaHeight=function(){return parseInt(this.twoPage.height)};BookReader.prototype.twoPageFlipAreaWidth=function(){var a=100;var b=10;var c=this.twoPage.width*0.15;return parseInt(BookReader.util.clamp(c,b,a))};BookReader.prototype.twoPageFlipAreaTop=function(){return parseInt(this.twoPage.bookCoverDivTop+this.twoPage.coverInternalPadding)};BookReader.prototype.twoPageLeftFlipAreaLeft=function(){return parseInt(this.twoPage.gutter-this.twoPage.scaledWL)};BookReader.prototype.twoPageRightFlipAreaLeft=function(){return parseInt(this.twoPage.gutter+this.twoPage.scaledWR-this.twoPageFlipAreaWidth())};BookReader.prototype.twoPagePlaceFlipAreas=function(){$(this.twoPage.leftFlipArea).css({left:this.twoPageLeftFlipAreaLeft()+"px",width:this.twoPageFlipAreaWidth()+"px"});$(this.twoPage.rightFlipArea).css({left:this.twoPageRightFlipAreaLeft()+"px",width:this.twoPageFlipAreaWidth()+"px"})};BookReader.prototype.updateSearchHilites2UP=function(){for(var f in this.searchResults){f=parseInt(f,10);if(jQuery.inArray(f,this.displayedIndices)>=0){var i=this.searchResults[f];if(null==i.div){i.div=document.createElement("div");$(i.div).attr("className","BookReaderSearchHilite").css("zIndex",3).appendTo("#BRtwopageview")}var h=this._getPageHeight(f);var a=this._getPageWidth(f);var e=this.twoPage.height/h;var c=parseInt(a*e);var b=this.twoPageGutter();var g;if("L"==this.getPageSide(f)){g=b-c}else{g=b}var d=this.twoPageTop();$(i.div).css({width:(i.r-i.l)*e+"px",height:(i.b-i.t)*e+"px",left:g+(i.l)*e+"px",top:d+(i.t)*e+"px"})}else{if(null!=this.searchResults[f].div){$(this.searchResults[f].div).remove()}this.searchResults[f].div=null}}};BookReader.prototype.removeSearchHilites=function(){for(var a in this.searchResults){if(null!=this.searchResults[a].div){$(this.searchResults[a].div).remove();this.searchResults[a].div=null}}};BookReader.prototype.printPage=function(){window.open(this.getPrintURI(),"printpage","width=400, height=500, resizable=yes, scrollbars=no, toolbar=no, location=no")};BookReader.prototype.getPrintURI=function(){var a;if(this.constMode2up==this.mode){a=this.twoPage.currentIndexL}else{a=this.firstIndex}var b="id="+this.subPrefix+"&server="+this.server+"&zip="+this.zip+"&format="+this.imageFormat+"&file="+this._getPageFile(a)+"&width="+this._getPageWidth(a)+"&height="+this._getPageHeight(a);if(this.constMode2up==this.mode){b+="&file2="+this._getPageFile(this.twoPage.currentIndexR)+"&width2="+this._getPageWidth(this.twoPage.currentIndexR);b+="&height2="+this._getPageHeight(this.twoPage.currentIndexR);b+="&title="+encodeURIComponent(this.shortTitle(50)+" - Pages "+this.getPageNum(this.twoPage.currentIndexL)+", "+this.getPageNum(this.twoPage.currentIndexR))}else{b+="&title="+encodeURIComponent(this.shortTitle(50)+" - Page "+this.getPageNum(a))}return"/bookreader/print.php?"+b};BookReader.prototype.showEmbedCode=function(){if(null!=this.embedPopup){return}this.autoStop();this.embedPopup=document.createElement("div");$(this.embedPopup).css({position:"absolute",top:"20px",left:($("#BRcontainer").attr("clientWidth")-400)/2+"px",width:"400px",padding:"20px",border:"3px double #999999",zIndex:3,backgroundColor:"#fff"}).appendTo("#BookReader");htmlStr='<p style="text-align:center;"><b>Embed Bookreader in your blog!</b></p>';htmlStr+="<p>The bookreader uses iframes for embedding. It will not work on web hosts that block iframes. The embed feature has been tested on blogspot.com blogs as well as self-hosted Wordpress blogs. This feature will NOT work on wordpress.com blogs.</p>";htmlStr+='<p>Embed Code: <input type="text" size="40" value="'+this.getEmbedCode()+'"></p>';htmlStr+='<p style="text-align:center;"><a href="" onclick="br.embedPopup = null; $(this.parentNode.parentNode).remove(); return false">Close popup</a></p>';this.embedPopup.innerHTML=htmlStr;$(this.embedPopup).find("input").bind("click",function(){this.select()})};BookReader.prototype.autoToggle=function(){var b=false;if(2!=this.mode){b=true;this.switchMode(2)}if(this.reduce<this.twoPageGetAutofitReduce()){this.zoom2up("auto")}var a=this;if(null==this.autoTimer){this.flipSpeed=2000;if(("rl"==this.pageProgression)&&b){}else{this.flipFwdToIndex()}$("#BRtoolbar .play").hide();$("#BRtoolbar .pause").show();this.autoTimer=setInterval(function(){if(a.animating){return}if(Math.max(a.twoPage.currentIndexL,a.twoPage.currentIndexR)>=a.lastDisplayableIndex()){a.flipBackToIndex(1)}else{a.flipFwdToIndex()}},5000)}else{this.autoStop()}};BookReader.prototype.autoStop=function(){if(null!=this.autoTimer){clearInterval(this.autoTimer);this.flipSpeed="fast";$("#BRtoolbar .pause").hide();$("#BRtoolbar .play").show();this.autoTimer=null}};BookReader.prototype.stopFlipAnimations=function(){this.autoStop();if(this.leafEdgeTmp){$(this.leafEdgeTmp).stop(false,true)}jQuery.each(this.prefetchedImgs,function(){$(this).stop(false,true)});if(this.leafEdgeTmp){$(this.leafEdgeTmp).stop(false,true)}jQuery.each(this.prefetchedImgs,function(){$(this).stop(false,true)})};BookReader.prototype.keyboardNavigationIsDisabled=function(a){if(a.target.tagName=="INPUT"){return true}return false};BookReader.prototype.gutterOffsetForIndex=function(a){var b=parseInt(((a/this.numLeafs)-0.5)*this.twoPage.edgeWidth);if("rl"==this.pageProgression){b=-b}return b};BookReader.prototype.leafEdgeWidth=function(a){if((this.getPageSide(a)=="L")&&(this.pageProgression!="rl")){return parseInt((a/this.numLeafs)*this.twoPage.edgeWidth+0.5)}else{return parseInt((1-a/this.numLeafs)*this.twoPage.edgeWidth+0.5)}};BookReader.prototype.jumpIndexForLeftEdgePageX=function(b){if("rl"!=this.pageProgression){var a=this.twoPage.currentIndexL-($(this.leafEdgeL).offset().left+$(this.leafEdgeL).width()-b)*10;a=BookReader.util.clamp(Math.round(a),this.firstDisplayableIndex(),this.twoPage.currentIndexL-2);return a}else{var a=this.twoPage.currentIndexL+($(this.leafEdgeL).offset().left+$(this.leafEdgeL).width()-b)*10;a=BookReader.util.clamp(Math.round(a),this.twoPage.currentIndexL+2,this.lastDisplayableIndex());return a}};BookReader.prototype.jumpIndexForRightEdgePageX=function(b){if("rl"!=this.pageProgression){var a=this.twoPage.currentIndexR+(b-$(this.leafEdgeR).offset().left)*10;a=BookReader.util.clamp(Math.round(a),this.twoPage.currentIndexR+2,this.lastDisplayableIndex());return a}else{var a=this.twoPage.currentIndexR-(b-$(this.leafEdgeR).offset().left)*10;a=BookReader.util.clamp(Math.round(a),this.firstDisplayableIndex(),this.twoPage.currentIndexR-2);return a}};BookReader.prototype.initToolbar=function(e,b){$("#BookReader").append("<div id='BRtoolbar'><span id='BRtoolbarbuttons' style='float: right'><button class='BRicon print rollover' /> <button class='BRicon rollover embed' /><form class='BRpageform' action='javascript:' onsubmit='br.jumpToPage(this.elements[0].value)'> <span class='label'>Page:<input id='BRpagenum' type='text' size='3' onfocus='br.autoStop();'></input></span></form><div class='BRtoolbarmode2' style='display: none'><button class='BRicon rollover book_leftmost' /><button class='BRicon rollover book_left' /><button class='BRicon rollover book_right' /><button class='BRicon rollover book_rightmost' /></div><div class='BRtoolbarmode1' style='display: none'><button class='BRicon rollover book_top' /><button class='BRicon rollover book_up' /> <button class='BRicon rollover book_down' /><button class='BRicon rollover book_bottom' /></div><div class='BRtoolbarmode3' style='display: none'><button class='BRicon rollover book_top' /><button class='BRicon rollover book_up' /> <button class='BRicon rollover book_down' /><button class='BRicon rollover book_bottom' /></div><button class='BRicon rollover play' /><button class='BRicon rollover pause' style='display: none' /></span><span><a class='BRicon logo rollover' href='"+this.logoURL+"'>&nbsp;</a> <button class='BRicon rollover zoom_out' onclick='br.zoom(-1); return false;'/><button class='BRicon rollover zoom_in' onclick='br.zoom(1); return false;'/> <span class='label'>Zoom: <span id='BRzoom'>"+parseInt(100/this.reduce)+"</span></span> <button class='BRicon rollover one_page_mode' onclick='br.switchMode(1); return false;'/> <button class='BRicon rollover two_page_mode' onclick='br.switchMode(2); return false;'/> <button class='BRicon rollover thumbnail_mode' onclick='br.switchMode(3); return false;'/></span><span id='#BRbooktitle'>&nbsp;&nbsp;<a class='BRblack title' href='"+this.bookUrl+"' target='_blank'>"+this.bookTitle+"</a></span></div>");this.updateToolbarZoom(this.reduce);if(b=="embed"||b=="touch"){$("#BookReader a.logo").attr("target","_blank")}var c=$("#BRtoolbar");c.append();this.bindToolbarNavHandlers(c);var d={".logo":"Go to Archive.org",".zoom_in":"Zoom in",".zoom_out":"Zoom out",".one_page_mode":"One-page view",".two_page_mode":"Two-page view",".thumbnail_mode":"Thumbnail view",".print":"Print this page",".embed":"Embed bookreader",".book_left":"Flip left",".book_right":"Flip right",".book_up":"Page up",".book_down":"Page down",".play":"Play",".pause":"Pause",".book_top":"First page",".book_bottom":"Last page"};if("rl"==this.pageProgression){d[".book_leftmost"]="Last page";d[".book_rightmost"]="First page"}else{d[".book_leftmost"]="First page";d[".book_rightmost"]="Last page"}for(var a in d){c.find(a).attr("title",d[a])}if(!this.canSwitchToMode(this.constMode2up)){c.find(".two_page_mode, .play, .pause").hide()}if(!this.canSwitchToMode(this.constModeThumb)){c.find(".thumbnail_mode").hide()}if(!(this.canSwitchToMode(this.constMode2up)||this.canSwitchToMode(this.constModeThumb))){c.find(".one_page_mode").hide()}this.switchToolbarMode(e)};BookReader.prototype.switchToolbarMode=function(a){if(1==a){$("#BRtoolbar .BRtoolbarzoom").show().css("display","inline");$("#BRtoolbar .BRtoolbarmode2").hide();$("#BRtoolbar .BRtoolbarmode3").hide();$("#BRtoolbar .BRtoolbarmode1").show().css("display","inline")}else{if(2==a){$("#BRtoolbar .BRtoolbarzoom").show().css("display","inline");$("#BRtoolbar .BRtoolbarmode1").hide();$("#BRtoolbar .BRtoolbarmode3").hide();$("#BRtoolbar .BRtoolbarmode2").show().css("display","inline")}else{$("#BRtoolbar .BRtoolbarzoom").hide();$("#BRtoolbar .BRtoolbarmode2").hide();$("#BRtoolbar .BRtoolbarmode1").hide();$("#BRtoolbar .BRtoolbarmode3").show().css("display","inline")}}};BookReader.prototype.bindToolbarNavHandlers=function(b){var a=this;b.find(".book_left").bind("click",function(c){a.left();return false});b.find(".book_right").bind("click",function(c){a.right();return false});b.find(".book_up").bind("click",function(c){if($.inArray(a.mode,[a.constMode1up,a.constModeThumb])>=0){a.scrollUp()}else{a.prev()}return false});b.find(".book_down").bind("click",function(c){if($.inArray(a.mode,[a.constMode1up,a.constModeThumb])>=0){a.scrollDown()}else{a.next()}return false});b.find(".print").bind("click",function(c){a.printPage();return false});b.find(".embed").bind("click",function(c){a.showEmbedCode();return false});b.find(".play").bind("click",function(c){a.autoToggle();return false});b.find(".pause").bind("click",function(c){a.autoToggle();return false});b.find(".book_top").bind("click",function(c){a.first();return false});b.find(".book_bottom").bind("click",function(c){a.last();return false});b.find(".book_leftmost").bind("click",function(c){a.leftmost();return false});b.find(".book_rightmost").bind("click",function(c){a.rightmost();return false})};BookReader.prototype.updateToolbarZoom=function(c){var a;var b=null;if(this.mode==this.constMode2up){b=this.twoPage.autofit}else{b=this.onePage.autofit}if(b){a=b.slice(0,1).toUpperCase()+b.slice(1)}else{a=(100/c).toFixed(2);a=a.replace(/0+$/,"");a=a.replace(/\.$/,"");a+="%"}$("#BRzoom").text(a)};BookReader.prototype.firstDisplayableIndex=function(){if(this.mode!=this.constMode2up){return 0}if("rl"!=this.pageProgression){if(this.getPageSide(0)=="L"){return 0}else{return -1}}else{if(this.getPageSide(0)=="R"){return 0}else{return -1}}};BookReader.prototype.lastDisplayableIndex=function(){var a=this.numLeafs-1;if(this.mode!=this.constMode2up){return a}if("rl"!=this.pageProgression){if(this.getPageSide(a)=="R"){return a}else{return a+1}}else{if(this.getPageSide(a)=="L"){return a}else{return a+1}}};BookReader.prototype.shortTitle=function(a){if(this.bookTitle.length<a){return this.bookTitle}var b=this.bookTitle.substr(0,a-3);b+="...";return b};BookReader.prototype.updateFromParams=function(a){if("undefined"!=typeof(a.mode)){this.switchMode(a.mode)}if("undefined"!=typeof(a.searchTerm)){if(this.searchTerm!=a.searchTerm){this.search(a.searchTerm)}}if("undefined"!=typeof(a.index)){if(a.index!=this.currentIndex()){this.jumpToIndex(a.index)}}else{if("undefined"!=typeof(a.page)){if(a.page!=this.getPageNum(this.currentIndex())){this.jumpToPage(a.page)}}}};BookReader.prototype.paramsFromFragment=function(d){var f={};if(d.substr(0,1)=="#"){d=d.substr(1)}var e=parseInt(/^\d+$/.exec(d));if(!isNaN(e)){f.index=e;return f}var a=d.split("/");var b={};for(var c=0;c<a.length;c+=2){b[a[c]]=a[c+1]}if("1up"==b.mode){f.mode=this.constMode1up}else{if("2up"==b.mode){f.mode=this.constMode2up}else{if("thumb"==b.mode){f.mode=this.constModeThumb}}}if("undefined"!=typeof(b.page)){f.page=b.page}if(b.search!=undefined){f.searchTerm=BookReader.util.decodeURIComponentPlus(b.search)}return f};BookReader.prototype.paramsFromCurrent=function(){var c={};var a=this.currentIndex();var b=this.getPageNum(a);if((b===0)||b){c.page=b}c.index=a;c.mode=this.mode;if(this.searchHighlightVisible()){c.searchTerm=this.searchTerm}return c};BookReader.prototype.fragmentFromParams=function(c){var b="/";var a=[];if("undefined"!=typeof(c.page)){a.push("page",c.page)}else{a.push("page","n"+c.index)}if("undefined"!=typeof(c.mode)){if(c.mode==this.constMode1up){a.push("mode","1up")}else{if(c.mode==this.constMode2up){a.push("mode","2up")}else{if(c.mode==this.constModeThumb){a.push("mode","thumb")}else{throw"fragmentFromParams called with unknown mode "+c.mode}}}}if(c.searchTerm){a.push("search",c.searchTerm)}return BookReader.util.encodeURIComponentPlus(a.join(b)).replace(/%2F/g,"/")};BookReader.prototype.getPageIndex=function(a){var b=this.getPageIndices(a);if(b.length>0){return b[b.length-1]}return undefined};BookReader.prototype.getPageIndices=function(e){var f=[];if(e.slice(0,1)=="n"){try{var b=e.slice(1,e.length);var a=parseInt(b);f.push(a);return f}catch(d){}}var c;for(c=0;c<this.numLeafs;c++){if(this.getPageNum(c)==e){f.push(c)}}return f};BookReader.prototype.getPageName=function(a){return"Page "+this.getPageNum(a)};BookReader.prototype.updateLocationHash=function(){var a="#"+this.fragmentFromParams(this.paramsFromCurrent());window.location.replace(a);this.oldLocationHash=a};BookReader.prototype.startLocationPolling=function(){var a=this;a.oldLocationHash=window.location.hash;if(this.locationPollId){clearInterval(this.locationPollID);this.locationPollId=null}this.locationPollId=setInterval(function(){var b=window.location.hash;if(b!=a.oldLocationHash){if(b!=a.oldUserHash){if(a.animating){a.autoStop();a.animationFinishedCallback=function(){a.updateFromParams(a.paramsFromFragment(b))}}else{a.updateFromParams(a.paramsFromFragment(b))}a.oldUserHash=b}}},500)};BookReader.prototype.canSwitchToMode=function(a){if(a==this.constMode2up||a==this.constModeThumb){if(this.numLeafs<2){return false}}return true};BookReader.prototype.searchHighlightVisible=function(){if(this.constMode2up==this.mode){if(this.searchResults[this.twoPage.currentIndexL]||this.searchResults[this.twoPage.currentIndexR]){return true}}else{if(this.searchResults[this.currentIndex()]){return true}}return false};BookReader.prototype._getPageWidth=function(a){a=BookReader.util.clamp(a,0,this.numLeafs-1);return this.getPageWidth(a)};BookReader.prototype._getPageHeight=function(a){a=BookReader.util.clamp(a,0,this.numLeafs-1);return this.getPageHeight(a)};BookReader.prototype._getPageURI=function(b,e,a){if(b<0||b>=this.numLeafs){return this.imagesBaseURL+"/transparent.png"}if("undefined"==typeof(e)){var c=this.getPageHeight(b)/this.twoPage.height;var d;if(c<2){d=1}else{if(c<4){d=2}else{if(c<8){d=4}else{if(c<16){d=8}else{if(c<32){d=16}else{d=32}}}}}e=d}return this.getPageURI(b,e,a)};BookReader.util={disableSelect:function(a){a.bind("mousedown",function(b){return false});a[0].onselectstart=function(b){return false}},clamp:function(c,b,a){return Math.min(Math.max(c,b),a)},notInArray:function(a,b){return !(jQuery.inArray(a,b)>=0)},getIFrameDocument:function(b){var a=(b.contentWindow||b.contentDocument);return(a.document||a)},decodeURIComponentPlus:function(a){return decodeURIComponent(a).replace(/\+/g," ")},encodeURIComponentPlus:function(a){return encodeURIComponent(a).replace(/%20/g,"+")}};
/* /htapps/roger.babel/pt/web/js/BookReader-min.js */
subclass(HTBookReader,BookReader);function HTBookReader(){BookReader.call(this);this.constModeText=4;this.flags={};this.defaultReduce=4;this.savedReduce={"1.text":1};this.total_slices=9999;this.cache_age=60;this.restricted_width=this.restricted_height=75}HTBookReader.prototype.sliceFromIndex=function(a){return{slice:Math.floor(a/this.slice_size),index:a%this.slice_size}};HTBookReader.prototype.getMetaUrlParams=function(b){var a={id:this.bookId,size:"100",format:"list",limit:this.slice_size};if(this.flags.force!==undefined){a.force=this.force}a.start=b;if(this.flags.debug){a.debug="local"}return a};HTBookReader.prototype.getPageWidth=function(b){var c=this.rotationCache[b]||0;var a=this.__getPageWidth(b);return a};HTBookReader.prototype.getPageHeight=function(b){var d=this.rotationCache[b]||0;var c=this.__getPageHeight(b);if(this.displayMode=="image"&&2!==this.mode&&(d==90||d==270)){var a=this.__getPageWidth(b);c=Math.ceil(a*(a/c))}return c};HTBookReader.prototype.hasPageFeature=function(a,b){var d=this.sliceFromIndex(a);if(this.bookData[d.slice]!=undefined){var c=this.bookData[d.slice]["features"][d.index];return(c.indexOf(b)>=0)}return false};HTBookReader.prototype.__getPageWidth=function(b){var c=this.sliceFromIndex(b);var a;if(!this.hasPageFeature(b,"MISSING_PAGE")&&this.bookData[c.slice]!=undefined&&typeof(this.bookData[c.slice]["width"][c.index])=="number"){a=this.bookData[c.slice]["width"][c.index]}else{if(typeof(this.widthAvg)!="undefined"){a=this.widthAvg}else{a=this.widthAvg=this.getAvgDimension("width")}}return a};HTBookReader.prototype.__getPageHeight=function(a){var c=this.sliceFromIndex(a);var b;if(!this.hasPageFeature(a,"MISSING_PAGE")&&this.bookData[c.slice]!=undefined&&typeof(this.bookData[c.slice]["height"][c.index])=="number"){b=this.bookData[c.slice]["height"][c.index]}else{if(typeof(this.heightAvg)!="undefined"){b=this.heightAvg}else{b=this.heightAvg=this.getAvgDimension("height")}}return b};HTBookReader.prototype.getAvgDimension=function(d){sum=0;count=0;for(var b=0;b<this.slices.length;b++){var c=this.slices[b];for(var a=0;a<this.bookData[c][d].length;a++){if(typeof(this.bookData[c][d][a])=="number"){sum+=this.bookData[c][d][a];count++}}break}return sum/count};HTBookReader.prototype.getPingStatus=function(){var b=this;var a=this.pingURL+"?id="+this.bookId+";seq="+(this.currentIndex()+1)+";test="+(new Date()).getMinutes();$.get(a,function(c){if(c=="-"){b.alertSessionExpired()}else{setTimeout(function(){b.getPingStatus()},1000)}})};HTBookReader.prototype.alertSessionExpired=function(){$.pnotify({pnotify_title:"Login expired",pnotify_notice_icon:"",pnotify_hide:false,pnotify_closer:true,pnotify_opacity:1,pnotify_width:"250px",pnotify_history:false,pnotify_text:"Your authentication session has expired."})};HTBookReader.prototype.getPageURI=function(c,g,b){var a;var j;if("undefined"==typeof(g)){a=1}else{a=g}if("undefined"==typeof(b)){j=0}else{j=b}if(j==null||j==0){j=this.rotationCache[c]||0}if(this.mode==2){j=0}var k=0;if(j==90){k=1}else{if(j==180){k=2}else{if(j==270){k=3}}}var d=this.getURLParameter("q1");var f=Math.round(this.getMedianPageSize().width/a);var h;if(this.displayMode=="text"&&this.mode==1){h=this.url_config.text}else{if(this.mode==3){h=this.url_config.thumb}else{h=this.url_config.image}}h+="?id="+this.bookId+";seq="+(c+1);if(this.mode==1&&this.displayMode=="text"){if(this.q1){h+=";q1="+this.q1}}else{h+=";width="+f+";orient="+k}if(this.flags.debug){h+=";debug="+this.flags.debug}if(this.flags.attr){h+=";attr="+this.flags.attr}return h};HTBookReader.prototype.canRotatePage=function(a){return true};HTBookReader.prototype.getPageSide=function(a){if("rl"!=this.pageProgression){if(0==(a&1)){return"R"}else{return"L"}}else{if(0==(a&1)){return"L"}else{return"R"}}};HTBookReader.prototype.getPageNum=function(a){if(a<0){return}var c=this.sliceFromIndex(a);var b=this.bookData[c.slice]["page_num"][c.index];if(b){return b}else{return"n"+a}};HTBookReader.prototype.leafNumToIndex=function(d){for(var b=0;b<this.slices.length;b++){var c=this.slices[b];for(var a=0;a<this.bookData[c]["seq"].length;a++){if(this.bookData[c]["seq"][a]==d){return a+1}}}return null};HTBookReader.prototype.getSpreadIndices=function(a){var b=[null,null];if("rl"==this.pageProgression){if(this.getPageSide(a)=="R"){b[1]=a;b[0]=a+1}else{b[0]=a;b[1]=a-1}}else{if(this.getPageSide(a)=="L"){b[0]=a;b[1]=a+1}else{b[1]=a;b[0]=a-1}}return b};HTBookReader.prototype.uniquifyPageNums=function(){var a={};for(var c=this.slices.length-1;c--;c>=0){var f=this.slices[c];for(var b=this.bookData[f]["page_num"].length-1;b--;b>=0){var d=this.bookData[f]["page_num"][b];if(!a[d]){a[d]=true}else{this.bookData[f]["page_num"][b]=null}}}};HTBookReader.prototype.cleanupMetadata=function(){this.uniquifyPageNums()};HTBookReader.prototype.updateViewSettings=function(){var a=0;var c=$("#BRcontainer").attr("clientWidth");for(i=0;i<this.numLeafs;i++){a+=parseInt(this._getPageHeight(i)/this.reduce)+this.padding;var b=parseInt(this._getPageWidth(i)/this.reduce);if(b>c){c=b}}$("#BRpageview").height(a);$("#BRpageview").width(c);if(3==this.mode){this.drawLeafsThumbnail()}};HTBookReader.prototype.getEmbedURL=function(){var a="http://"+window.location.host+"/stream/"+this.bookId;if(this.subPrefix!=this.bookId){a+="/"+this.subPrefix}a+="?ui=embed";return a};HTBookReader.prototype.getEmbedCode=function(){return"<iframe src='"+this.getEmbedURL()+"' width='480px' height='430px'></iframe>"};HTBookReader.prototype.installBookDataSlice=function(a,b,c){if(this.bookData==null){this.bookData={};this.slices=[];this.numLeafs=0}this.bookData[a]=b;this.slices.push(a);if(c){lscache.set(this.bookId+"-"+a,b,this.cache_age)}if(a==0){this.titleLeaf=this.bookData[0]["first_page_sequence"];this.total_slices=Math.ceil(b.total_items/this.slice_size);this.total_items=b.total_items;this.flags.download_progress_base=b.download_progress_base}this.numLeafs+=this.bookData[a]["seq"].length;this.cleanupMetadata();this.complete=this.slices.length==this.total_slices};HTBookReader.prototype.loadBookDataSlice=function(h,g){var a=this;var c=function(l,j,k){a.installBookDataSlice(l,j,k);if(l==0){a.init()}else{a.updateViewSettings()}a.loadBookDataSlice(l+1)};if(h<a.total_slices){var b=lscache.get(a.bookId+"-"+h);if(b){c(h,b,false)}else{var f=h*this.slice_size;var d=a.getMetaUrlParams(f);$.getJSON(a.url_config.meta,d,function(j){c(h,j,true)})}}else{a.complete=true}};HTBookReader.prototype.init=function(){var b=this;var j=undefined;var h=this.paramsFromFragment(window.location.hash);var d=false;if("undefined"!=typeof(h.index)){j=h.index;d=true}else{if("undefined"!=typeof(h.page)){j=this.getPageIndex(h.page);d=true}}if(h.displayMode){this.displayMode=h.displayMode;if(this.displayMode=="text"){this.onePage.autofit="width"}}var c=Date();if(!this.complete&&d){console.log("INIT: WAITING FOR",c,j,"/",this.complete,"/",d,"/",this.sliceFromIndex(j),":",this.total_slices);if("undefined"==typeof(j)||this.sliceFromIndex(j).slice<this.total_slices){var b=this;setTimeout(function(){if(b.notice){b.notice.setContent("<span>Loading: "+(b.numLeafs)+" / "+b.total_items+"</span>")}b.init()},500);console.log("WAITING:",c);return}}console.log("BOOK READER INIT",c);var a=0;if("undefined"!=typeof(h.mode)){this.mode=h.mode}var g=this.thumbMaxLoading;var f=this.lazyDelay;if(a){setTimeout(function(){b.lazyDelay=f;b.thumbMaxLoading=g},a*10)}if(b.notice!=null){b.notice.setTitle("&#160;").setContent("<span>All finished</span>");setTimeout(function(){b.notice.hide()},a+1000)}setTimeout(function(){BookReader.prototype.init.call(b);b.saveReduce()},a);if(this.ui=="full"){this.bindPageControlHandlers()}if(!this.complete){this.loadBookDataSlice(this.slices.length)}};HTBookReader.prototype.shortTitle=function(a){return this.bookTitle};HTBookReader.prototype.openNotice=function(){var a=this;if(a.notice==null){var b=new Boxy("<span>Loading book data</span>",{show:true,modal:false,draggable:true,closeable:false,title:"Please wait"});a.notice=b}};HTBookReader.prototype.getURLParameter=function(b,a){if(a==null){a=location.search}return unescape((RegExp(b+"=(.+?)(;|&|$)").exec(a)||[,null])[1])};HTBookReader.prototype.onePageCalculateReductionFactors=function(c,a){BookReader.prototype.onePageCalculateReductionFactors.call(this,c,a);var b=this.onePage.reductionFactors[this.onePage.reductionFactors.length-1];var d=this.reductionFactors[this.reductionFactors.length-1];if(b.reduce>d.reduce){this.onePage.reductionFactors.pop();this.onePage.reductionFactors[this.onePage.reductionFactors.length-1].autofit="height"}};HTBookReader.prototype.initToolbar=function(c,b){var a=this;$("#btnBookReader1up").click(function(){a.switchMode(1,this);a.toggleDisplayMode("image");return false});$("#btnBookReaderText").click(function(){if(!$(this).hasClass("PTbuttonDisabled")){a.switchMode(1,this);a.toggleDisplayMode("text")}return false});$("#btnBookReader2up").click(function(){if(!$(this).hasClass("PTbuttonDisabled")){try{a.switchMode(2,this)}catch(d){console.log(d)}}return false});$("#btnBookReaderThumbnail").click(function(){if(!$(this).hasClass("PTbuttonDisabled")){a.switchMode(3,this)}return false});$("#mdpZoomOut").click(function(){a.zoom(-1);return false});$("#mdpZoomIn").click(function(){a.zoom(1);return false});$("#mdpZoomStatus").html('<span id="BRzoom">'+parseInt(100/a.reduce)+"</span>");a.updateToolbarZoom(a.reduce);$("#mdpLastPageLink").click(function(d){if(a.mode==2){a.rightmost()}else{a.last()}return false});$("#mdpFirstPageLink").click(function(d){if(a.mode==2){a.leftmost()}else{a.first()}return false});$("#mdpPreviousPageLink").click(function(d){if(a.mode==2){a.left()}else{if($.inArray(a.mode,[a.constMode1up,a.constModeThumb])>=0){a.scrollUp()}else{a.prev()}}return false});$("#mdpNextPageLink").click(function(d){if(a.mode==2){a.right()}else{if($.inArray(a.mode,[a.constMode1up,a.constModeThumb])>=0){a.scrollDown()}else{a.next()}}return false});if(!this.canSwitchToMode(this.constMode2up)){$("#btnBookReader2up").addClass("PTbuttonDisabled")}if(!this.canSwitchToMode(this.constModeThumb)){$("#btnBookReaderThumbnail").addClass("PTbuttonDisabled")}if(!this.flags.has_ocr){$("#btnBookReaderText").addClass("PTbuttonDisabled")}$("#mdpJumpToSectionSubmit").bind("click",function(){var f=$("#mdpJumpToSection");var d=parseInt(f.val());if(d&&d>0){a.jumpToIndex(d-1)}return false});$("#mdpPageForm").unbind("submit").bind("submit",function(){var d=$(this);if(!FormValidation(d.get(0).num,"Please enter a page number in the box.")){return false}var f=d.get(0).num.value;a.jumpToPage(f);return false});if(this.flags.final_access_status!="allow"){$("#mdpToolbar").css("opacity",0.4)}this.switchToolbarMode(c);this.switchCurrentPageDownloadLinks()};HTBookReader.prototype.switchToolbarMode=function(c){var a;a=$(".PTbuttonActive").removeClass("PTbuttonActive");if(a.length>0){var b=a.attr("title").replace(" is the current view","");a.attr("title",b).find("img").attr("title",b)}if(1==c){if(this.displayMode=="text"){a=$("#btnBookReaderText").addClass("PTbuttonActive");this.toggleZoomHandlers(false);this.toggleRotateHandlers(false)}else{a=$("#btnBookReader1up").addClass("PTbuttonActive");this.toggleZoomHandlers(true);this.toggleRotateHandlers(true)}}else{if(2==c){a=$("#btnBookReader2up").addClass("PTbuttonActive");this.toggleZoomHandlers(true);this.toggleRotateHandlers(false)}else{if(3==c){a=$("#btnBookReaderThumbnail").addClass("PTbuttonActive");this.toggleZoomHandlers(true);this.toggleRotateHandlers(false)}}}var b=a.attr("title")+" is the current view";a.attr("title",b).find("img").attr("title",b)};HTBookReader.prototype.updateToolbarZoom=function(f){BookReader.prototype.updateToolbarZoom.call(this,f);var a=(this.mode==this.constMode2up)?this.twoPage.reductionFactors:this.onePage.reductionFactors;if(a){var d=[];d.push(this.nextReduce(this.reduce,"out",a));d.push(this.nextReduce(this.reduce,"in",a));for(var b=0;b<d.length;b++){var c;if(d[b].autofit){c=d[b].autofit;c=c.slice(0,1).toUpperCase()+c.slice(1)}else{c=d[b].reduce;c=(100/c).toFixed(2);c=c.replace(/0+$/,"");c=c.replace(/\.$/,"");c+="%"}d[b]=c}$("#mdpZoomOut, #mdpZoomOut img").attr("title","Zoom Out: "+d[0]);$("#mdpZoomIn, #mdpZoomIn img").attr("title","Zoom In: "+d[1])}};HTBookReader.prototype.getThumbnailWidth=function(a){var c=BookReader.prototype.getThumbnailWidth.call(this,a);if(this.flags.final_access_status!="allow"){var f=this.getAvgDimension("height");var b=this.getAvgDimension("width");var d=b/f;return this.restricted_height*d}return c};HTBookReader.prototype.getThumbnailHeight=function(b){var a=BookReader.prototype.getThumbnailHeight.call(this,b);if(this.flags.final_access_status!="allow"){return this.restricted_height}return width};HTBookReader.prototype.saveReduce=function(){var a=this.mode;if(this.mode==1){a+="."+this.displayMode}this.savedReduce[a]=this.reduce};HTBookReader.prototype.getSavedReduce=function(){var a=this.mode;if(this.mode==1){a+="."+this.displayMode}var b=this.savedReduce[a];if(b==null){if(this.mode==1&&this.displayMode=="text"){b=1}else{b=this.defaultReduce}}return b};HTBookReader.prototype.switchMode=function(c,b){if(c==this.mode){return}if(!this.canSwitchToMode(c)){return}this.autoStop();this.removeSearchHilites();this.saveReduce();this.mode=c;this.switchToolbarMode(c);this.reduce=this.getSavedReduce();if(1==c){this.onePageCalculateReductionFactors($("#BRcontainer").attr("clientWidth"),$("#BRcontainer").attr("clientHeight"));this.prepareOnePageView()}else{if(3==c){this.reduce=this.quantizeReduce(this.reduce,this.reductionFactors);this.prepareThumbnailView()}else{this.twoPage.autofit=null;this.twoPageCalculateReductionFactors();if(this.savedReduce[this.mode]==null){for(var a=0;a<this.twoPage.reductionFactors.length;a++){if(this.twoPage.reductionFactors[a].autofit!=null){this.reduce=this.twoPage.reductionFactors[a].reduce;this.twoPage.autofit=this.twoPage.reductionFactors[a].autofit;break}}}else{this.reduce=this.quantizeReduce(this.reduce,this.twoPage.reductionFactors)}this.prepareTwoPageView();this.twoPageCenterView(0.5,0.5)}}this.switchCurrentPageDownloadLinks()};HTBookReader.prototype.switchCurrentPageDownloadLinks=function(){var c=$("#pagePdfLink");var b=c.text();c.removeClass("disabled");if(this.mode==this.constMode2up){var d=c.clone().insertAfter(c).text(b.replace("this page","right page")).attr("id","pageRightPdfLink");c.text(b.replace("this page","left page"));var a=d.attr("href");a=this._updateUrlFromParams(a,{seq:this.currentIndex()},{id:"#"+c.attr("id")});d.attr("href",a)}else{if(this.mode==this.constMode1up){$("#pageRightPdfLink").remove();c.text(b.replace("left page","this page"))}else{$("#pageRightPdfLink").remove();c.text(b.replace("this page","left page"));c.addClass("disabled")}}};HTBookReader.prototype._updateUrlFromParams=function(c,j,d){if(d===null){d={}}was_escaped=null;if(c.indexOf("target=")>-1){var f=c.split("target=");was_escaped=f.shift();c=unescape(f.join("target="))}if(j.page&&(typeof(j.page)=="number"||j.page.slice(0,1)!="n")&&(d.id!="#pageRightPdfLink")){var g;g="num="+j.page;if(c.indexOf("num=")>-1){c=c.replace(/num=\w+(;?)/,g+"$1")}else{c+=";"+g}}else{c=c.replace(/num=\w+(;?)/,"")}if(j.index){var b;var a=j.index+1;if(d&&d.id=="#pageRightPdfLink"){a+=1}b="seq="+a;if(c.indexOf("seq=")>-1){c=c.replace(/seq=\d+(;?)/,b+"$1")}else{c+=";"+b}}else{c=c.replace(/seq=\d+(;?)/,"")}if(d&&d.view&&j.mode){var h;h="view="+this.getMode(j);if(c.indexOf("view=")>-1){c=c.replace(/view=\w+(;?)/,h+"$1")}else{c+=";"+h}}if(was_escaped!=null){c=was_escaped+"target="+escape(c)}else{if(d.id=="#fullPdfLink"){c=c.replace(/seq=\d+(;?)/,"");c=c.replace(/num=\w+(;?)/,"")}}c=c.replace(/;+$/g,"");return c};HTBookReader.prototype.updateLocationHash=function(){var b=this;var j=this.paramsFromCurrent();$.each(["#btnClassicView","#btnClassicText","#pagePdfLink","#pageRightPdfLink","#fullPdfLink","#loginLink"],function(k,o){var n=$(o);var l=n.attr("href");if(l!=null){var m={id:o};if((o=="#loginLink")||(o=="#fullPdfLink")){m.view=true}l=b._updateUrlFromParams(l,j,m);n.attr("href",l)}});if(window.history&&window.history.replaceState!=null){var h=this._updateUrlFromParams(window.location.search,j,{view:true});window.history.replaceState(null,document.title,h)}else{var g="#"+this.fragmentFromParams(j);window.location.replace(g)}if(this.last_index!=j.index){if(this.last_index!=null){if(pageTracker!=null){var f=this.paramsForTracking(j);var a=window.location.protocol+"//"+window.location.host+window.location.pathname+"?";var d=["id="+f.id];d.push("view="+f.view);d.push("orient="+f.orient);d.push("size="+f.size);var c=this.getPageNum(f.seq);if(typeof(c)=="number"){d.push("num=",c)}d.push("seq="+f.seq);a+=d.join(";");_gaq.push(["_trackPageview",a])}}this.last_index=j.index}this.oldLocationHash=g};HTBookReader.prototype.paramsForTracking=function(f){var b=this;var a={};if(f==null){f=b.paramsFromCurrent()}var c=b.rotationCache[f.index]==null?0:b.rotationCache[f.index];if(c==90){c=1}else{if(c==180){c=2}else{if(c==270){c=3}}}var d=(100/b.reduce).toFixed(2);a.id=b.bookId;a.seq=f.index;a.size=d;a.orient=c;a.view=$(".PTbuttonActive").attr("href").replace(/.*view=(\w+).*/,"$1");return a};HTBookReader.prototype.paramsFromFragment=function(d){var f=BookReader.prototype.paramsFromFragment.call(this,d);var a=d.split("/");var b={};for(var c=0;c<a.length;c+=2){b[a[c]]=a[c+1]}f.displayMode="image";if(b.mode&&b.mode=="text"){f.displayMode="text";f.mode=this.constMode1up}f.debug=b.debug;return f};HTBookReader.prototype.paramsFromCurrent=function(){var a=BookReader.prototype.paramsFromCurrent.call(this);a.displayMode=this.displayMode;return a};HTBookReader.prototype.toggleDisplayMode=function(b){if(this.displayMode==b){return}this.displayMode=b;this.switchToolbarMode(this.mode);if(this.displayMode=="text"){this.saved1upReduce=this.reduce;for(var a=0;a<this.onePage.reductionFactors.length;a++){if(this.onePage.reductionFactors[a].reduce==1){this.reduce=1;this.onePage.autofit=this.onePage.reductionFactors[a].autofit;break}}}else{if(this.saved1upReduce){for(var a=0;a<this.onePage.reductionFactors.length;a++){if(this.onePage.reductionFactors[a].reduce==this.saved1upReduce){this.reduce=this.saved1upReduce;this.onePage.autofit=this.onePage.reductionFactors[a].autofit;break}}}}this.prepareOnePageView()};BookReader.prototype.prepareOnePageView=function(){var b=this.currentIndex();$("#BRcontainer").empty();$("#BRcontainer").css({overflowY:"scroll",overflowX:"auto"});$("#BRcontainer").append("<div id='BRpageview'></div>");var a={ignoreTargets:["ocrText","rotateAction"]};$("#BRcontainer").dragscrollable(a);this.bindGestures($("#BRcontainer"));this.resizePageView();this.jumpToIndex(b);this.displayedIndices=[];this.drawLeafsOnePage()};HTBookReader.prototype.nextReduce=function(c,b,a){return BookReader.prototype.nextReduce.call(this,c,b,a)};HTBookReader.prototype.getMode=function(b){var a;if(b.mode==this.constMode1up){if(b.displayMode=="text"){a="text"}else{a="1up"}}else{if(b.mode==this.constMode2up){a="2up"}else{if(b.mode==this.constModeThumb){a="thumb"}else{throw"getMode called with unknown mode "+b.mode}}}return a};HTBookReader.prototype.fragmentFromParams=function(c){var b="/";var a=[];if("undefined"!=typeof(c.page)){a.push("page",c.page)}else{a.push("page","n"+c.index)}if("undefined"!=typeof(c.mode)){a.push(this.getMode(c))}if(c.searchTerm){a.push("search",c.searchTerm)}return BookReader.util.encodeURIComponentPlus(a.join(b)).replace(/%2F/g,"/")};HTBookReader.prototype.jumpToIndex=function(b,d,c){if(!this.inTextMode){BookReader.prototype.jumpToIndex.call(this,b,d,c);return}this.firstIndex=b;var a=this.getOcrURI(b);var g=$("#MdpOcrFrame");var f=g.css("left");g.attr("src",a).addClass("loading");this.updatePageNumBox();this.updateLocationHash()};HTBookReader.prototype.updatePageNumBox=function(){var a=this.getPageNum(this.currentIndex());if((typeof(a)=="string")&&(a.substr(0,1)=="n")){a=""}$("#BRpagenum").val(a)};function fireEvent(b,c){if(document.createEvent){var a=document.createEvent("HTMLEvents");a.initEvent(c,true,true);return !b.dispatchEvent(a)}else{var a=document.createEventObject();return b.fireEvent("on"+c,a)}}HTBookReader.prototype.printPage=function(a){if(a==null){a=this.currentIndex()}fireEvent($("a#pagePdfLink").get(0),"click");return false};HTBookReader.prototype.reflowText=function(c){var a=(40/Math.round(this.reduce));var b=(14/Math.round(this.reduce));if(b<9){b=9}$(c).textfill({minFontSize:b,maxFontSize:a})};HTBookReader.prototype.drawLeafsThumbnail=function(E){this.timer=null;var O=$("#BRcontainer").attr("scrollWidth")-20;var L;var z;var H;var G=0;var r=0;var s=0;var q=0;var l=0;var Q=[];var n=this;var y;for(L=0;L<this.numLeafs;L++){z=this.thumbWidth;if(G+(z+this.padding)>O){q++;G=0;l=0}if(Q[q]===undefined){Q[q]={}}if(Q[q].leafs===undefined){Q[q].leafs=[];Q[q].height=0;Q[q].top=0}Q[q].leafs[l]={};Q[q].leafs[l].num=L;Q[q].leafs[l].left=G;H=parseInt((this.getPageHeight(Q[q].leafs[l].num)*this.thumbWidth)/this.getPageWidth(Q[q].leafs[l].num),10);if(H>Q[q].height){Q[q].height=H}if(l===0){r+=this.padding+Q[q].height}G+=z+this.padding;if(G>s){s=G}l++;if(L==E){y=r-this.padding-Q[q].height}}$("#BRpageview").height(r);var a=Math.floor(($("#BRcontainer").attr("scrollWidth")-s)/2)-14;if(typeof(y)!="undefined"){$("#BRcontainer").scrollTop(y)}var P=$("#BRcontainer").attr("scrollTop");var u=P+$("#BRcontainer").height();var A=0;var F=0;var v=[];var M=this.numLeafs-1;var d=0;for(L=0;L<Q.length;L++){F+=this.padding+Q[L].height;var J=(A>=P)&&(A<=u);var o=(F>=P)&&(F<=u);var g=(A<=P)&&(F>=u);if(J|o|g){v.push(L);if(Q[L].leafs[0].num<M){M=Q[L].leafs[0].num}if(Q[L].leafs[Q[L].leafs.length-1].num>d){d=Q[L].leafs[Q[L].leafs.length-1].num}}if(A>Q[L].top){Q[L].top=A}A=F}var p=v[0];var x=v[v.length-1];for(L=1;L<this.thumbRowBuffer+1;L++){if(x+L<Q.length){v.push(x+L)}}for(L=1;L<this.thumbRowBuffer+1;L++){if(p-L>=0){v.push(p-L)}}var K;var t;var f;var C;var N;var h;var m;var b;for(L=0;L<v.length;L++){if(BookReader.util.notInArray(v[L],this.displayedRows)){t=v[L];for(K=0;K<Q[t].leafs.length;K++){C=K;leaf=Q[t].leafs[K].num;z=this.thumbWidth;H=parseInt((this.getPageHeight(leaf)*this.thumbWidth)/this.getPageWidth(leaf),10);A=Q[t].top;f=Q[t].leafs[C].left+a;if("rl"==this.pageProgression){f=O-z-f}var w=$("div#pagediv"+leaf);if(w.length>0){continue}N=document.createElement("div");N.id="pagediv"+leaf;N.style.position="absolute";N.className="BRpagedivthumb";f+=this.padding;$(N).css("top",A+"px");$(N).css("left",f+"px");$(N).css("width",z+"px");$(N).css("height",H+"px");h=document.createElement("a");$(h).data("leaf",leaf);$(h).bind("click",function(j){n.firstIndex=$(this).data("leaf");n.switchMode(n.constMode1up);j.preventDefault()});var B="image of page "+this.getPageNum(leaf);h.href="#page/"+(this.getPageNum(leaf))+"/mode/1up";$(h).attr({title:B});$(N).append(h);$("#BRpageview").append(N);m=document.createElement("img");var D=Math.floor(this.getPageWidth(leaf)/this.thumbWidth);$(m).attr("src",this.imagesBaseURL+"transparent.png").css({width:z+"px",height:H+"px"}).addClass("BRlazyload").data("srcURL",this._getPageURI(leaf,D));$(h).append(m)}}}var I;for(L=0;L<this.displayedRows.length;L++){if(BookReader.util.notInArray(this.displayedRows[L],v)){t=this.displayedRows[L];for(I=0;I<Q[t].leafs.length;I++){C=Q[t].leafs[I].num;$("#pagediv"+C).remove()}}else{}}var c=this.currentIndex();if(c<M){this.setCurrentIndex(M)}else{if(c>d){this.setCurrentIndex(d)}}this.displayedRows=v.slice();if(this.displayedRows.length>0){this.updateLocationHash()}$(".BRpagedivthumb_highlight").removeClass("BRpagedivthumb_highlight");$("#pagediv"+this.currentIndex()).addClass("BRpagedivthumb_highlight");this.lazyLoadThumbnails();if(null!==this.getPageNum(this.currentIndex())){this.updatePageNumBox()}else{$("#BRpagenum").val("")}this.updateToolbarZoom(this.reduce)};HTBookReader.prototype._createTextElement=function(c,a){e=document.createElement("div");$(e).addClass("ocrTextContainer");$(e).css("height",a+"px");$(e).css("width",c+"px");var b=document.createElement("div");$(b).addClass("ocrScrollBar");$(e).append(b);return e};HTBookReader.prototype._insertTextPane=function(f,g,h,c){var k=(5/Math.round(this.reduce));var j=(1/Math.round(this.reduce));if(j<1){j=1}var a=$(h);var b=a.width();var d=Math.floor(b/8);$(f).addClass("ocrText").attr("id","ocr"+g).appendTo(a).css({left:d+"px",width:(d*6)+"px"}).textfill({maxFontSize:40,sel:c});a.animate({backgroundColor:"#ffffff",opacity:1},"fast",function(){$(".ocrScrollBar",a).css("backgroundColor","white")})};HTBookReader.prototype.createContentElement=function(d,g,b,j){var k=this;var f;var a=this._getPageURI(d,g,0);if(this.hasPageFeature(d,"MISSING_PAGE")){f=this._createTextElement(b,j);setTimeout(function(){var l='<div class="noText ocrText"><div class="noTextAlert">MISSING PAGE</div><span>This page is missing in the original.</span><br /><span>Please continue to available pages.</span><br /><span><a target="_blank" href="http://www.hathitrust.org/help_digital_library#PageNotAvailable">See the Help page for more information.</a></span></div>';k._insertTextPane(l,d,f)},200)}else{if(this.displayMode=="image"){f=document.createElement("img");$(f).css("width",b+"px");$(f).css("height",j+"px");var h="image of page "+this.getPageNum(d);$(f).attr({alt:h,title:h});f.src=a}else{var c="span";f=this._createTextElement(b,j);$.get(a,null,function(l){if(!l){l='<div class="noText ocrText"><div class="noTextAlert">NO TEXT ON PAGE</div><span>This page does not contain any text</span><br /><span>recoverable by the OCR engine</span></div>';c=null}k._insertTextPane(l,d,f,c)})}}return f};HTBookReader.prototype.tweakDragParams=function(){$("#BRcontainer").dragscrollable({dragSelector:".ocrScrollBar",acceptPropagatedEvent:false,preventDefault:false})};$(window).scroll(function(){var a=$("#BRpageControls");if(a.is(":visible")){$("div#BRpageControls").fadeOut(250)}});HTBookReader.prototype.rotationCache={};HTBookReader.prototype.rotatePage=function(a,d){if(a==null){a=this.currentIndex()}if(d==null){d=90}var c=this.rotationCache[a];if(c==null){c=0}c+=d;if(c<0){c+=360}if(c==360){c=0}this.rotationCache[a]=c;$("div.BRpagediv1up").remove();this.displayedIndices=[];this.drawLeafs();var b=this;setTimeout(function(){b.jumpToIndex(a)},150)};HTBookReader.prototype.toggleZoomHandlers=function(a){var b=this;var c=$(".zoomAction");if(a===undefined){a=!c.hasClass("PTbuttonDisabled")}if(a){c.removeClass("PTbuttonDisabled")}else{c.addClass("PTbuttonDisabled")}};HTBookReader.prototype.toggleRotateHandlers=function(a){var b=this;var c=$(".rotateAction");if(a===undefined){a=!c.hasClass("PTbuttonDisabled")}if(a){c.removeClass("PTbuttonDisabled")}else{c.addClass("PTbuttonDisabled")}};HTBookReader.prototype.bindPageControlHandlers=function(b){var a=this;var b=$("#BRpageControls");$("a#rotate-counterclockwise").click(function(d){var c=a.currentIndex();a.rotatePage(c,-90);return false});$("a#rotate-clockwise").click(function(d){var c=a.currentIndex();a.rotatePage(c,90);return false})};
/* /htapps/roger.babel/pt/web/js/HTBookReader-min.js */
(function(c){var b=function(h,f){var g=h.split(" ");var d=new Array();for(var e=0;e<g.length;e++){d.push(g[e]+f)}return d.join(" ")};var a=function(e){var d;var g;if(typeof(e.clientX)!="undefined"){d=e.clientX;g=e.clientY}else{if(typeof(e.screenX)!="undefined"){d=e.screenX;g=e.screenY}else{if(typeof(e.targetTouches)!="undefined"){d=e.targetTouches[0].pageX;g=e.targetTouches[0].pageY}else{if(typeof(e.originalEvent)=="undefined"){var f="";for(i in e){f+=", "+i+": "+e[i]}console.error("don't understand x and y for "+e.type+" event: "+f)}else{if(typeof(e.originalEvent.clientX)!="undefined"){d=e.originalEvent.clientX;g=e.originalEvent.clientY}else{if(typeof(e.originalEvent.screenX)!="undefined"){d=e.originalEvent.screenX;g=e.originalEvent.screenY}else{if(typeof(e.originalEvent.targetTouches)!="undefined"){d=e.originalEvent.targetTouches[0].pageX;g=e.originalEvent.targetTouches[0].pageY}}}}}}}return{left:d,top:g}};c.fn.dragscrollable=function(d){var g=c(this);var f=c.extend({dragSelector:">:first",acceptPropagatedEvent:true,preventDefault:true,dragstart:"mousedown touchstart",dragcontinue:"mousemove touchmove",dragend:"mouseup mouseleave touchend",dragMinDistance:5,namespace:".ds",ignoreTargets:null},d||{});f.dragstart=b(f.dragstart,f.namespace);f.dragcontinue=b(f.dragcontinue,f.namespace);f.dragend=b(f.dragend,f.namespace);var e={dragStartHandler:function(j){console.log("TARGET",j.target);if(j.which>1||(!j.data.acceptPropagatedEvent&&j.target!=this)){return false}var h=true;if(f.ignoreTargets!==null&&j.target!=this){console.log("HEY:",f.ignoreTargets);c.each(f.ignoreTargets,function(){console.log("IGNORE",this,"/",c(j.target).hasClass(this),"/",c(j.target).parents("."+this));if(c(j.target).hasClass(this)||c(j.target).parents("."+this).size()>0){console.log("IGNORE",this,"/",c(j.target).hasClass(this),"/",c(j.target).parents("."+this));h=false}})}if(!h&&!j.shiftKey){console.log("RETURNING? short-circuit dragcontinue?",j.target,this,g);j.stopPropagation();console.log("UNBOUND");return}console.log("DRAG SCROLLING");j.data.firstCoord=a(j);j.data.lastCoord=j.data.firstCoord;g.bind(f.dragcontinue,j.data,e.dragContinueHandler).bind(f.dragend,j.data,e.dragEndHandler);if(j.data.preventDefault){j.preventDefault();return false}},dragContinueHandler:function(j){var h=a(j);var k={left:(h.left-j.data.lastCoord.left),top:(h.top-j.data.lastCoord.top)};j.data.scrollable.scrollLeft(j.data.scrollable.scrollLeft()-k.left);j.data.scrollable.scrollTop(j.data.scrollable.scrollTop()-k.top);j.data.lastCoord=h;if(j.data.preventDefault){j.preventDefault();return false}},dragEndHandler:function(h){g.unbind(f.dragcontinue).unbind(f.dragend);var k={left:Math.abs(h.data.lastCoord.left-h.data.firstCoord.left),top:Math.abs(h.data.lastCoord.top-h.data.firstCoord.top)};var j=Math.max(k.left,k.top);if(j<f.dragMinDistance){c(h.target).trigger("tap")}if(h.data.preventDefault&&j>f.dragMinDistance){h.preventDefault();return false}}};return this.each(function(){var h={scrollable:c(this),acceptPropagatedEvent:f.acceptPropagatedEvent,preventDefault:f.preventDefault};c(this).undelegate().delegate(f.dragSelector,f.dragstart,h,e.dragStartHandler)})};c.fn.removedragscrollable=function(d){if(typeof(d)=="undefined"){d=".ds"}return this.each(function(){var e=c(document).find("*").andSelf().unbind(d)})}})(jQuery);
/* /htapps/roger.babel/pt/web/js/dragscrollable-min.js */
var lscache=function(){var e="-cacheexpiration";function b(){return("localStorage" in window)&&window.localStorage!==null}function d(){return("JSON" in window)&&window.JSON!==null}function a(f){return f+e}function c(){return Math.floor((new Date().getTime())/60000)}return{set:function(h,l,n){if(!b()){return}if(typeof l!="string"){if(!d()){return}try{l=JSON.stringify(l)}catch(m){return}}try{localStorage[h]=l}catch(m){if(m.name==="QUOTA_EXCEEDED_ERR"){var k=[];for(var h in localStorage){if(h.indexOf(e)>-1){var j=h.split(e)[0];k.push({key:j,expiration:parseInt(localStorage[h])})}}k.sort(function(o,i){return(o-i)});for(var g=0,f=Math.min(30,k.length);g<f;g++){localStorage.removeItem(k[g].key);localStorage.removeItem(a(k[g].key))}}else{return}}if(n){localStorage[a(h)]=c()+n}else{localStorage.removeItem(a(h))}},get:function(f){if(!b()){return null}if(localStorage[a(f)]){var i=parseInt(localStorage[a(f)]);if(c()>i){localStorage.removeItem(f);localStorage.removeItem(a(f));return null}else{if(d()){try{var g=JSON.parse(localStorage[f]);return g}catch(h){return localStorage[f]}}else{return localStorage[f]}}}return null},remove:function(f){if(!b()){return null}localStorage.removeItem(f);localStorage.removeItem(a(f))}}}();
/* /htapps/roger.babel/pt/web/js/lscache-min.js */
