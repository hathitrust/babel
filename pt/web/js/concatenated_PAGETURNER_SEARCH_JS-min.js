var HT=HT||{};HT.Downloader={init:function(a){this.options=$.extend({},this.options,a);this.id=this.options.params.id;this.pdf={};return this},options:{},start:function(){var a=this;this.bindEvents()},bindEvents:function(){var a=this;$("#fullPdfLink").addClass("interactive").click(function(b){b.preventDefault();if($(this).attr("rel")=="allow"){if(a.options.params.download_progress_base==null){return true}a.downloadPdf(this)}else{a.explainPdfAccess(this)}return false})},explainPdfAccess:function(b){var a=$("#noPdfAccess").html();this.$dialog=bootbox.alert(a);this.$dialog.addClass("login")},downloadPdf:function(c){var a=this;a.src=$(c).attr("href");var b='<div class="initial"><p>Setting up download...</p></div><div class="progress progress-striped active hide"><div class="bar" width="0%"></div></div><div class="done hide"><p>All done!</p></div>';a.$dialog=bootbox.dialog(b,[{label:"Cancel","class":"btn-dismiss",callback:function(){if(a.$dialog.data("deactivated")){a.$dialog.modal("hide");return}$.ajax({url:a.src+";callback=HT.downloader.cancelDownload;stop=1",dataType:"script",cache:false,error:function(d,f,e){console.log("DOWNLOAD CANCELLED ERROR");a.$dialog.modal("hide");console.log(d,f,e);if(d.status==503){a.displayWarning(d)}else{a.displayError()}}})}},{label:"Download PDF","class":"download-pdf btn-dismiss btn-primary hide",callback:function(){window.location.href=a.pdf.download_url;setTimeout(function(){a.$dialog.modal("hide")},500);return false}}],{header:"Building your PDF"});a.requestDownload()},requestDownload:function(){var a=this;$.ajax({url:a.src+";callback=HT.downloader.startDownloadMonitor",dataType:"script",cache:false,error:function(b,d,c){console.log("DOWNLOAD STARTUP NOT DETECTED");if(a.$dialog){a.$dialog.modal("hide")}if(b.status==503){a.displayWarning(b)}else{a.displayError(b)}}})},cancelDownload:function(c,a,d){var b=this;b.clearTimer();b.$dialog.modal("hide")},startDownloadMonitor:function(c,a,d){var b=this;if(b.timer){console.log("ALREADY POLLING");return}b.pdf.progress_url=c;b.pdf.download_url=a;b.pdf.total=d;b.is_running=true;b.num_processed=0;b.i=0;b.timer=setInterval(function(){b.checkStatus()},1000);b.checkStatus()},checkStatus:function(){var a=this;a.i+=1;$.ajax({url:a.pdf.progress_url,data:{ts:(new Date).getTime()},cache:false,dataType:"html",success:function(d){var b=a.updateProgress(d);var c=$.trim(d).split("\n").reverse();a.num_processed+=1;if(b.done){a.clearTimer()}else{if(b.error){a.$dialog.modal("hide");a.displayError();a.clearTimer()}}},error:function(b,d,c){console.log("FAILED: ",b,"/",d,"/",c);a.$dialog.modal("hide");a.clearTimer();if(b.status==404&&(a.i>25||a.num_processed>0)){a.showEror()}}})},updateProgress:function(d){var b=this;var a={done:false,error:false};var c;var e=$(d).find("#current").data("value");if(e=="EOT"){a.done=true;c=100}else{e=parseInt(e);c=100*(e/b.pdf.total)}if(b.last_percent!=c){b.last_percent=c;b.num_attempts=0}else{b.num_attempts+=1}if(b.num_attempts>5){a.error=true}if(b.$dialog.find(".initial").is(":visible")){b.$dialog.find(".initial").hide();b.$dialog.find(".progress").removeClass("hide")}b.$dialog.find(".bar").css({width:c+"%"});if(c==100){b.$dialog.find(".progress").hide();b.$dialog.find(".done").show();b.$dialog.find(".download-pdf").show();b.$dialog.data("deactivated",true)}return a},clearTimer:function(){var a=this;if(a.timer){clearInterval(a.timer);a.timer=null}},displayWarning:function(f){var a=this;var g=parseInt(f.getResponseHeader("X-Choke-UntilEpoch"));var e=f.getResponseHeader("X-Choke-Rate");if(g<=5){setTimeout(function(){a.requestDownload()},5000);return}g*=1000;var b=(new Date).getTime();var d=(Math.ceil((g-b)/1000));var c=('<div><p>You have exceeded the download rate of {rate}. You may proceed in <span id="throttle-timeout">{countdown}</span> seconds.</p><p>Download limits protect HathiTrust resources from abuse and help ensure a consistent experience for everyone.</p></div>').replace("{rate}",e).replace("{countdown}",d);a.$dialog=bootbox.dialog(c,[{label:"OK","class":"btn-dismiss btn-primary",callback:function(){clearInterval(a.countdown_timer);return true}}]);a.countdown_timer=setInterval(function(){d-=1;a.$dialog.find("#throttle-timeout").text(d);if(d==0){clearInterval(a.countdown_timer)}console.log("TIC TOC",d)},1000)},displayError:function(b){var a="<p>There was a problem building your PDF; staff have been notified.</p><p>Please try again in 24 hours.</p>";bootbox.dialog(a,[{label:"OK","class":"btn-dismiss btn-inverse"}],{classes:"error"});console.log(b)},EOT:true};head.ready(function(){HT.downloader=Object.create(HT.Downloader).init({params:HT.params});HT.downloader.start()});
/* /htapps/roger.babel/pt/web/js/downloader-min.js */
head.ready(function(){$("#versionIcon").click(function(a){a.preventDefault();bootbox.alert('<p>This is the date when this item was last updated. Version dates are updated when improvements such as higher quality scans or more complete scans have been made. <br /><br /><a href="/cgi/feedback?page=form" data-default-form="data-default-form" data-toggle="feedback tracking-action" data-id="" data-tracking-action="Show Feedback">Contact us</a> for more information.</p>')})});
/* /htapps/roger.babel/pt/web/js/version_popup-min.js */
head.ready(function(){var m="a";var f="b";var e="This item is in your collection(s):";var d=$(".collectionLinks .select-collection");var b=$(".errormsg");var j=$(".infomsg");function o(q){if(!b.length){b=$('<div class="alert alert-error errormsg"></div>').insertAfter(d)}b.text(q).show()}function p(q){if(!j.length){j=$('<div class="alert alert-info infomsg"></div>').insertAfter(d)}j.text(q).show()}function l(){b.hide().text()}function h(){j.hide().text()}function n(){var q="/cgi/mb";if(location.pathname.indexOf("/shcgi/")>-1){q="/shcgi/mb"}return q}function i(t){var q={};var s=t.split("|");for(var r=0;r<s.length;r++){kv=s[r].split("=");q[kv[0]]=kv[1]}return q}function k(r){var q=$.extend({creating:false,label:"Save Changes"},r);var s=$('<form class="form-horizontal" action="mb"><div class="control-group"><label class="control-label" for="edit-cn">Collection Name</label><div class="controls"><input type="text" class="input-large" maxlength="100" name="cn" id="edit-cn" value="" placeholder="Your collection name" /><span class="label counter" id="edit-cn-count">100</span></div></div><div class="control-group"><label class="control-label" for="edit-desc">Description</label><div class="controls"><textarea id="edit-desc" name="desc" rows="4" maxlength="255" class="input-large" placeholder="Add your collection description."></textarea><span class="label counter" id="edit-desc-count">255</span></div></div><div class="control-group"><div class="controls"><label class="radio inline"><input type="radio" name="shrd" id="edit-shrd-0" value="0" checked="checked" > Private </label><label class="radio inline"><input type="radio" name="shrd" id="edit-shrd-1" value="1" > Public </label></div></div></form>');if(q.cn){s.find("input[name=cn]").val(q.cn)}if(q.desc){s.find("textarea[name=desc]").val(q.desc)}if(q.shrd!=null){s.find("input[name=shrd][value="+q.shrd+"]").attr("checked","checked")}else{if(!HT.login_status.logged_in){s.find("input[name=shrd][value=0]").attr("checked","checked");$('<div class="alert alert-info">Login to create public/permanent collections.</div>').appendTo(s);s.find("input[name=shrd][value=1]").parent().remove()}}if(q.$hidden){q.$hidden.clone().appendTo(s)}else{$("<input type='hidden' name='c' />").appendTo(s).val(q.c);$("<input type='hidden' name='a' />").appendTo(s).val(q.a)}if(q.iid){$("<input type='hidden' name='iid' />").appendTo(s).val(q.iid)}var t=bootbox.dialog(s,[{label:"Cancel","class":"btn-dismiss"},{label:q.label,"class":"btn-primary",callback:function(){var v=$.trim(s.find("input[name=cn]").val());var u=$.trim(s.find("textarea[name=desc]").val());if(!v){$('<div class="alert alert-error">You must enter a collection name.</div>').appendTo(s);return false}p("Submitting; please wait...");a({a:"additsnc",cn:v,desc:u,shrd:s.find("input[name=shrd]:checked").val()})}}]);t.find("input[type=text],textarea").each(function(){var w=$(this);var v=$("#"+w.attr("id")+"-count");var u=w.attr("maxlength");v.text(u-w.val().length);w.bind("keyup",function(){v.text(u-w.val().length)})})}function a(r){var q=$.extend({},{page:"ajax",id:HT.params.id},r);$.ajax({url:n(),data:q}).done(function(s){var t=i(s);h();if(t.result=="ADD_ITEM_SUCCESS"){c(t)}else{if(t.result=="ADD_ITEM_FAILURE"){o("Item could not be added at this time.")}else{console.log(s)}}}).fail(function(s,u,t){console.log(u,t)})}function c(u){var r=$(".collection-membership");var q=n()+"?a=listis;c="+u.coll_id;var s=$("<a>").attr("href",q).text(u.coll_name);$("<li></li>").appendTo(r).append(s);$(".collection-membership-summary").text(e);var t=d.find("option[value='"+u.coll_id+"']");t.remove()}function g(q,u,t){if(q<=1000&&q+u>1000){var r;if(u>1){r="these "+u+" items"}else{r="this item"}var s="Note: Your collection contains "+q+" items.  Adding "+r+" to your collection will increase its size to more than 1000 items.  This means your collection will not be searchable until it is indexed, usually within 48 hours.  After that, just newly added items will see this delay before they can be searched. \n\nDo you want to proceed?";confirm(s,function(v){if(v){t()}})}else{t()}}$("#PTaddItemBtn").click(function(t){t.preventDefault();var s="addI";l();var q=d.find("select").val();var r=d.find("select option:selected").text();if((q==m)){o("You must select a collection.");return}if(q==f){k({creating:true,c:q,id:HT.params.id,a:s});return}p("Submitting; please wait...");a({c2:q,a:"addits"})})});
/* /htapps/roger.babel/pt/web/js/collection_tools-min.js */
head.ready(function(){var b=$("html");var a="UA-39581946-1";var c=function(){var d=[];d.push("id="+HT.params.id.replace(/\//g,"___"));if(window.location.href.indexOf("/pt/search")>-1){d.push("view=search")}else{d.push("view="+HT.params.view)}if(HT.params.seq){d.push("seq="+HT.params.seq)}return"/"+d.join("/")};$.subscribe("update.reader.state",function(){HT.analytics.trackPageview(c(),a)});if($.trim(b.data("analytics-skip"))=="true"){return}setTimeout(function(){if(HT.analytics.enabled){HT.analytics.trackPageview(c(),a)}},500)});
/* /htapps/roger.babel/pt/web/js/google_analytics_experiment-min.js */
