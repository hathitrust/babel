// body[data-show-highlights="false"], 
body.hide-highlights {
  .image {
    .highlight {
      display: none !important;
    }
  }

  .page-text {
    .highlight--plaintext {
      background: transparent !important;
    }
  }
}

// READER
.d--reader {
  min-height: 0;
  position: relative;

  // grid-column: 3;
  // grid-row: 1;
  @include grid-column(3,4);
  @include grid-row(1,2);

  // display: grid;
  // grid-template-columns: 1fr;
  // grid-template-rows: 1fr;
  @include display-grid();
  @include grid-template-columns(1fr);
  @include grid-template-rows(1fr);
  overflow: hidden;

  background: #fffefb;

  @supports not (display: grid) {
    order: 3;
    flex-grow: 1;
    display: flex;

    .d--reader--container {
      flex-grow: 1;
    }
  }

  &[data-view="1up"], &[data-view="thumb"], &[data-view="page"] {
    .d--reader--container {
      overflow: auto;

      &.animating {
        overflow: hidden;
      }

      @supports not (display: grid) {
        .d--reader--viewer {
          height: auto !important;
        }
      }
    }
  }

  &[data-view="thumb"] {
    .d--reader--viewer {
      flex-direction: row;
      flex-wrap: wrap;

      .page {
        margin-top: 3rem;

        .image {
          min-height: 160px;
        }
      }
    }
  }

  &[data-view="page"] {
    justify-content: center;

    &.short {
      align-content: center;
    }

    .d--reader--viewer {
      // display: grid;
      min-height: 0;
      height: auto;
      width: 100%;

      @include display-grid();
      grid-template-areas: "page";
      // grid-template-rows: 1fr;
      // grid-template-columns: min-content;
      @include grid-template-rows(1fr);
      @include grid-template-columns(min-content);

      justify-content: center;
      align-content: center;

      &.animating {
        overflow: hidden;
      }

      &::after {
        display: block;
        content: "";
        height: 6rem;
      }

      .page {

        &.placeholder { display: none; }

        backface-visibility: hidden;
        grid-area: page;
        -ms-grid-row: 1;
        -ms-grid-row-span: 1;

        visibility: hidden;
        opacity: 0;

        margin-bottom: 4rem;

        &[data-visible="true"] {
          visibility: visible;
          opacity: 1;
        }

        &[data-visible="false"] {
          .image {
            height: 0 !important;
            img {
              display: none;
            }
          }
        }

        .image {
          img {
            height: 100%;
          }
        }

        &.page--foldout {
          .image {
            transform: scale(1.1);
          }
        }

        &.page--moveToLeft {
          animation: imageMoveToLeft .4s ease both;
          @media ( prefers-reduced-motion ) {
            animation-duration: $reduced-duration;
          }
        }

        &.page--moveFromRight {
          animation: imageMoveFromRight .4s ease both;
          @media ( prefers-reduced-motion ) {
            animation-duration: $reduced-duration;
          }
        }

        // $fade-duration: .7s;
        $fade-duration: .2s;
        $fadeOut-duration: .4s;
        &.page--moveFromRightFade {
          animation: imageMoveFromRightFade $fade-duration ease both;
          @media ( prefers-reduced-motion ) {
            animation-duration: $reduced-duration;
          }
        }

        &.page--moveToRight {
          animation: imageMoveToRight .2s ease both;
          @media ( prefers-reduced-motion ) {
            animation-duration: $reduced-duration;
          }
        }

        &.page--moveFromLeft {
          animation: imageMoveFromLeft .2s ease both;
          @media ( prefers-reduced-motion ) {
            animation-duration: $reduced-duration;
          }
        }

        &.page--moveFromLeftFade {
          animation: imageMoveFromLeftFade $fade-duration ease both;
          @media ( prefers-reduced-motion ) {
            animation-duration: $reduced-duration;
          }
        }

        &.page--fade {
          animation: imageFade $fadeOut-duration ease both;
          @media ( prefers-reduced-motion ) {
            animation-duration: $reduced-duration;
          }
        }

      }

    }
  }

  &[data-view="page"][data-format="plaintext"] {
    .d--reader--viewer {
      @include grid-template-columns(85%);

      .page {
        margin-top: 2rem;
        width: 100%;

        transition: visibility 0s linear 150ms, opacity 300ms;

        &[data-visible="true"] {
          display: block;

          visibility: visible;
          opacity: 1;
          transition: visibility 0s linear 0ms, opacity 150ms;
          width: 100%;

          z-index: 9;

          &.pending {
            z-index: 10;
          }

          &.exiting {
            z-index: -10;
          }
        }

        &[data-visible="false"] {
          .page-text {
            height: 0 !important;
          }
        }
      }
    }
  }

  &[data-view="2up"] {

    @include grid-template-rows(1fr);
    justify-content: center;
    align-content: center;

    .d--reader--container {
      min-width: 0;
      overflow: auto;
      scroll-behavior: smooth;
    }

    .d--reader--viewer {
      grid-template-areas: "verso recto";
      // grid-template-rows: 1fr;
      // grid-template-columns: min-content min-content;
      @include display-grid();
      @include grid-template-rows(1fr);
      @include grid-template-columns(min-content min-content);
      grid-gap: 0rem;

      padding-top: 2.5rem;
      margin-bottom: 6rem;

      min-width: 0;

      justify-content: center;

      @supports not (display: grid) {
        display: flex;
        flex-direction: row;
        position: relative;
      }

      .page {
        backface-visibility: hidden;
        visibility: hidden;
        opacity: 0;

        .page--toolbar {
          position: static !important;
        }

        .image {
          max-height: var(--max-page-height, none);
  
          background: url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAQAAAAFCAYAAABirU3bAAAAG0lEQVQIW2O8c+fOTCEhIYZ3794xgGhGKggAAJf0H/UWcK5GAAAAAElFTkSuQmCC);

          img {
            width: auto;
            height: 100%;
            border: 1px solid #ddd;
          }

        }

        &.verso {
          .image {
            border-left: 4px solid #666;
            .page--backdrop {
              right: 0;
            }
          }
        }

        &.recto {
          .image {
            border-right: 4px solid #666;
            .page--backdrop {
              left: 0;
            }
          }
        }

        &[data-visible="true"] {
          opacity: 1;
          visibility: visible;
        }

        &[data-visible="false"] {
          .image {
          }
        }

        &:last-of-type {
          margin-bottom: auto;
        }

        & + .page {
          margin-top: 0;
        }

        &:first-of-type {
          margin-top: 0;
        }

        &:last-of-type {
          margin-bottom: 0;
        }

        &.page--foldout {
          .image {
            img {
              align-self: flex-start;
              z-index: 1;
            }

            $backdrop-stroke-color: rgba(68, 77, 247, 0.2); // #444df7
            $backdrop-bg-color: rgba(158, 158, 158, 0.2); // #9e9e9e
            .page--backdrop {
              z-index: 0;
              border: none;
              box-shadow: none;
              position: absolute;
              top: 0;
              bottom: 0;

              background-color: #ebebeb;

              &::after {
                content: "";
                display: block;
                position: absolute;
                top: 0;
                right: 0;
                bottom: 0;
                left: 0;

                background-color: #9e9e9e;
                opacity: 0.2;
                background: radial-gradient(circle, transparent 20%, #9e9e9e 20%, #9e9e9e 80%, transparent 80%, transparent), radial-gradient(circle, transparent 20%, #9e9e9e 20%, #9e9e9e 80%, transparent 80%, transparent) 17.5px 17.5px, linear-gradient(#444CF7 1.4000000000000001px, transparent 1.4000000000000001px) 0 -0.7000000000000001px, linear-gradient(90deg, #444CF7 1.4000000000000001px, #9e9e9e 1.4000000000000001px) -0.7000000000000001px 0;
                background-size: 35px 35px, 35px 35px, 17.5px 17.5px, 17.5px 17.5px;
              }
            }
          }

          &.verso {
            img {
              border-left: 8px solid #666;
            }
          }

          &.recto {
            img {
              border-right: 8px solid #666;
            }
          }
        }
      }
    }

  }

  &[data-view="1up"][data-format="plaintext"] {

    .page {

      width: 85%;

    }
  }

  &[data-view="2up"][data-format="plaintext"] {
    
    .d--reader--viewer {
      // grid-template-columns: 50% 50%;
      @include grid-template-columns(50% 50%);

      .page {
        height: 100%;
        width: 100%;

        .page-text {
          height: 100%;
        }

        &[data-visible="false"] {
          .page-text {
            height: 0 !important;
          }
        }
      }

    }
  }

  &[data-view][data-format="plaintext"] {

    .page {

      .page-text {
        display: flex;
        flex-direction: column;

        transition: height 100ms;
        
        position: relative !important;
        height: 100%; // auto
        width: auto;
        overflow: auto;
        clip: unset;
        clip-path: none;

        max-width: 80rem;
        min-height: 85vh;
        padding: 1rem;
        padding-top: 2rem;

        background: #fff;
        box-shadow: 0px 10px 13px -7px #000000, 0px 6px 15px 5px rgba(0, 0, 0, 0);
        border: 1px solid #ddd;

        font-size: var(--page-text-font-size, 1.25rem);
        line-height: 1.25;

        align-items: flex-start;
        justify-content: flex-start;

        .ocr_page, .ocrx_block { font-size: inherit; }
        .ocrx_block {
          margin-bottom: 1rem;
          line-height: 1.5;
        }

        .ocr_page[data-force-breaks="true"] {
          .ocr_line {
            display: block;
          }
        }

        [data-line-break] + [data-line-break] {
          display: block;
        }

        [data-end-paragraph]::after {
          content: "";
          display: table;
          margin-bottom: 1rem;
        }

        .alert-block {
          width: 100%;
        }

      }

      &[data-loaded="false"] {
        .page-text {
          &::before {
            align-items: center;
            justify-content: center;
            position: absolute;
            display: flex;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            font-size: 6rem;
            opacity: 0.4;
            color: #666;

            content: url("data:image/svg+xml,%3Csvg width='24' height='24' viewBox='0 0 24 24' fill='none' xmlns='http://www.w3.org/2000/svg'%0A%3E%3Cpath d='M3 4H15V8H3V4Z' fill='currentColor' /%3E%3Cpath d='M21 8H17V4H21V8Z' fill='currentColor' /%3E%3Cpath d='M3 10H21V14H3V10Z' fill='currentColor' /%3E%3Cpath d='M11 16H3V20H11V16Z' fill='currentColor' /%3E%3Cpath d='M13 16V20H21V16H13Z' fill='currentColor' /%3E%3C/svg%3E"); // "∞"; // "•";
          }

          animation: pulsate 1.5s ease infinite;
          @media ( prefers-reduced-motion ) {
            animation-duration: 0s;
          }
        }
      }
    }
  }

  &[data-view="thumb"][data-format="plaintext"] {
    .page {
      .page-text {
        display: none;
      }
    }
  }
}

.d--reader--viewer {
  width: 100%;
  min-height: 0;

  display: flex;
  flex-direction: column;

  .page {
    margin: auto;
    position: relative;

    .page--toolbar {
      display: flex;
      flex-direction: row;

      margin-top: 1rem;
      margin-bottom: 0.25rem;

      position: sticky;
      background: transparent;

      justify-content: flex-end;
      top: 0.5rem;

      z-index: 10;
    }

    .tag {
      font-size: 1.25rem;
      padding: 0;

      font-family: 'Roboto Mono', monospace;

      // // if we use the standard fonts, then
      // // but it just looks off
      // font-varient-numeric: tabular-nums;

      display: flex;
      align-items: center;
      vertical-align: middle;

      & > * {
        flex: 1 1 auto;
        position: relative;
        border-radius: 0;
      }

      & > span {
        display: flex;
        padding: 0.5rem;
        background: #39383a;
        color: #eee;

        border: 2px solid #666;

        border-top-right-radius: 4px;
        border-bottom-right-radius: 4px;

        height: 100%;
      }

      & > *:first-child {
        border-top-left-radius: 4px;
        border-bottom-left-radius: 4px;
      }

      & > * + * {
        margin-left: -2px;
      }

      button {
        border: 2px solid #666;

        &.tallish {
          padding-bottom: 0.25rem;
        }

        svg {
          height: 1.5rem;
          width: 1.5rem;
          // stroke: white;
          // fill: white;
        }

        &[data-action="toggle"] {
          svg {
            display: none;
          }
        }

        &[aria-pressed="true"] {
          svg.bi-check-square { display: block }
        }

        &[aria-pressed="false"] {
          svg.bi-square { display: block; }
        }
      }
    }

    .page-text {
      display: block;

      top: 0;
      left: 0;
      bottom: 0;
      right: 0;
      background: #eee;

      position: absolute !important;
      height: 1px; width: 1px;
      overflow: hidden;
      clip: rect(1px 1px 1px 1px); /* IE6, IE7 */
      clip: rect(1px, 1px, 1px, 1px);
    }

    .image {
      position: relative;
      flex-grow: 1;

      margin: 0 auto;

      background: #fff;

      display: flex;
      align-items: center;
      justify-content: center;

      background:url("data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHhtbG5zOnhsaW5rPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5L3hsaW5rIiB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIj48ZGVmcz48cGF0dGVybiBpZD0icGF0dGVybiIgd2lkdGg9IjUwIiBoZWlnaHQ9IjUwIiB2aWV3Qm94PSIwIDAgNDAsNDAiIHBhdHRlcm5Vbml0cz0idXNlclNwYWNlT25Vc2UiIHBhdHRlcm5UcmFuc2Zvcm09InJvdGF0ZSg0NSkgIj48cmVjdCBpZD0icGF0dGVybi1iYWNrZ3JvdW5kIiB3aWR0aD0iNDAwJSIgaGVpZ2h0PSI0MDAlIiBmaWxsPSJyZ2JhKDI1NSwgMjU1LCAyNTUsMSkiPjwvcmVjdD4gPGNpcmNsZSBmaWxsPSJyZ2JhKDI1MCwgMjQwLCAxMzcsMSkiIGN4PSI1IiBjeT0iMjYiIHI9IjEuNSI+PC9jaXJjbGU+PGNpcmNsZSBmaWxsPSJyZ2JhKDI1MCwgMjQwLCAxMzcsMSkiIGN4PSIyNSIgY3k9IjE0IiByPSIxLjUiPjwvY2lyY2xlPjxjaXJjbGUgZmlsbD0icmdiYSgyNDYsIDE3MywgODUsMSkiIGN4PSIxNSIgY3k9IjIwIiByPSIxIj48L2NpcmNsZT48Y2lyY2xlIGZpbGw9InJnYmEoMjQ2LCAxNzMsIDg1LDEpIiBjeD0iMzUiIGN5PSIyMCIgcj0iMSI+PC9jaXJjbGU+PC9wYXR0ZXJuPiAgPC9kZWZzPiA8cmVjdCBmaWxsPSJ1cmwoI3BhdHRlcm4pIiBoZWlnaHQ9IjEwMCUiIHdpZHRoPSIxMDAlIj48L3JlY3Q+PC9zdmc+");

      img {
        width: 100%;

        display: block;

        background: #f9f8f5;
        box-shadow: 0px 10px 13px -7px #000000, 0px 6px 15px 5px rgba(0, 0, 0, 0);
        border: 1px solid #ddd;

        &[src=""] { visibility: hidden; }
      }

    }

    &[data-loaded="false"].loading {
      .image {
        img {
          animation: pulsate 1.5s ease infinite;
          @media ( prefers-reduced-motion ) {
            animation-duration: 0s;
          }
        }
      }
    }

    // & + .page {
    //   margin-top: 3rem;
    // }

    &:first-of-type {
      margin-top: 4rem;
    }

    &:last-of-type {
      margin-bottom: 6rem;
    }

    &[data-loaded="true"] {
      .image {
        opacity: 1.0;
        width: auto;
      }
    }

    &[data-rotated="-90"], &[data-rotated="270"] {
      .image {
        img {
          height: 100%;
        }
        transform: rotate(-90deg) scale(0.8);
        margin-top: calc(var(--margin-rotated) * 1px);
        margin-bottom: calc(var(--margin-rotated) * 1px);
      }
    }

    &[data-rotated="-180"], &[data-rotated="180"] {
      .image {
        transform: rotate(-180deg);
      }
    }

    &[data-rotated="-270"], &[data-rotated="90"] {
      .image {
        img {
          height: 100%;
        }
        transform: rotate(-270deg) scale(0.8);
        margin-top: calc(var(--margin-rotated) * 1px);
        margin-bottom: calc(var(--margin-rotated) * 1px);
      }
    }
  }

  @media screen and ( max-width: 900px ) {
    // padding: 1rem 0;
  }
}

.d--reader--toolbar--controls {
  position: absolute;
  display: flex;
  align-items: flex-start;
  top: -0.5rem;
  right: 1.5rem; // -0.5rem; // --- some browsers have scrollbars
  z-index: 23;

  background: transparent;
  pointer-events: none;

  .toolbar {
    // position: fixed;
    display: flex;
    flex-wrap: nowrap;

    pointer-events: auto;

    .btn-group {
      display: flex;
      flex-wrap: nowrap;
    }

    button {
      background-color: #666; // $toolbar-background-color; // #666;
      color: #eee;
      text-shadow: 0 1px 1px rgba(0, 0, 0, 0.75);
      border-color: #333; // #767676; // #333;

      height: 2.375rem;

      &.active {
        background: rgba(0,0,0,0.8);
        // background: #000;
      }

      &:hover:enabled, &:focus:enabled {
        background: rgba(0,0,0,0.8);
        // background: #000;
      }
    }
  }
}

.d--reader[data-view="2up"] {
  $flip-animation-delay: .5s;

  .d--reader--viewer {
    // grid-template-rows: 1fr;
    @include grid-template-rows(1fr);

    &[data-reading-order="left-to-right"] {
      .page {
        &.recto {
          grid-area: recto;
          -ms-grid-column: 2;
          transform-origin: 0% 0%;
          margin-left: 0;

          @supports not (display: grid) {
            position: absolute;
            left: 50%;
          }

          &.page--flipToLeft {
            animation: flip-hide-recto $flip-animation-delay forwards ease;
            @media ( prefers-reduced-motion ) {
              animation-duration: $reduced-duration;
            }
          }

          &.page--flipToRight {
            animation: flip-show-recto $flip-animation-delay forwards ease;
            @media ( prefers-reduced-motion ) {
              animation-duration: $reduced-duration;
            }
          }

          &.page--flippingToLeft {
            z-index: 1;
            visibility: visible;
            opacity: 1;
          }

          .image {
            justify-content: flex-start;
          }
        }

        &.verso {
          grid-area: verso;
          -ms-grid-column: 1;

          @supports not (display: grid) {
            position: absolute;
            left: 0;
          }

          transform-origin: 100% 0%;
          margin-right: 0;

          &.page--flippingToRight {
            z-index: 1;
            visibility: visible;
            opacity: 1;
          }

          &.page--flipToRight {
            animation: flip-hide-verso $flip-animation-delay forwards ease;
            @media ( prefers-reduced-motion ) {
              animation-duration: $reduced-duration;
            }
          }

          &.page--flipToLeft {
            animation: flip-show-verso $flip-animation-delay forwards ease;
            @media ( prefers-reduced-motion ) {
              animation-duration: $reduced-duration;
            }
          }

          .page--toolbar {
            justify-content: flex-start;
            .tag {
              // flex-direction: row-reverse;
            }
          }

          .image {
            justify-content: flex-end;
          }
        }        
      }
    }

    &[data-reading-order="right-to-left"] {
      direction: rtl;

      .page {
        &.recto {
          grid-area: recto;
          transform-origin: 100% 0%;

          @supports not (display: grid) {
            position: absolute;
            left: 0;
          }

          margin-right: 0;

          .image {
            border-right: none;
            border-left: 4px solid #666;
          }

          &.page--flipToLeft {
            animation: flip-hide-recto-right-to-left $flip-animation-delay forwards ease;
            @media ( prefers-reduced-motion ) {
              animation-duration: $reduced-duration;
            }
          }

          &.page--flipToRight {
            animation: flip-show-recto-right-to-left $flip-animation-delay forwards ease;
            @media ( prefers-reduced-motion ) {
              animation-duration: $reduced-duration;
            }
          }

          // &.page--flippingToLeft {
          //   z-index: 0;
          //   visibility: visible;
          //   opacity: 0;
          // }

          &.page--flippingToRight {
            z-index: 1;
            visibility: visible;
            opacity: 1;
          }

        }

        &.verso {
          grid-area: verso;
          transform-origin: 0% 0%;

          @supports not (display: grid) {
            position: absolute;
            left: 50%;
          }

          margin-left: -2rem;

          .image {
            border-left: none;
            border-right: 4px solid #666;
          }

          &.page--flipToRight {
            animation: flip-hide-verso-right-to-left $flip-animation-delay forwards ease;
            @media ( prefers-reduced-motion ) {
              animation-duration: $reduced-duration;
            }
          }

          &.page--flipToLeft {
            animation: flip-show-verso-right-to-left $flip-animation-delay forwards ease;
            @media ( prefers-reduced-motion ) {
              animation-duration: $reduced-duration;
            }
          }

          &.page--flippingToLeft {
            z-index: 1;
            visibility: visible;
            opacity: 1;
          }

          .page--toolbar {
            justify-content: flex-start;
            .tag {
              flex-direction: row-reverse;
            }
          }

          // &.page--flippingToRight {
          //   z-index: 0;
          //   visibility: visible;
          //   opacity: 0;
          // }

        }
      }
    }

  }

}

// PAGE FOCUS --- focus on image frame vs. un-boxed page div
.page[tabindex="0"]:focus {
  outline: none;
  .image {
    // border: 8px solid goldenrod !important;
    outline: 4px solid $outline-color;
    outline-offset: 4px;
  }
  .page-text[data-placeholder] {
    outline: 4px solid $outline-color;
    outline-offset: 4px;    
  }
}

// LOADING ANIMATIONS
@keyframes pulsate-chasing-border {
  0% {
    border-right-color: #666;
  }

  25% {
    border-bottom-color: #666;
  }

  50% {
    border-left-color: #666;
  }

  100% {
    border-top-color: #666;
  }
}

@keyframes pulsate {
  0% {
    border: 1px solid #ddd;
  }

  50% {
   border: 1px solid #666; // #c6c6c6; 
  }

  100% {
    border: 1px solid #ddd;
  }
}

// VIEW=2up ANIMATIONS
@keyframes flip-show-recto {
  from { visibility: visible; opacity: 1; z-index: 2; transform: rotateY(180deg) }
  to { z-index: 2; transform: rotateY(0deg); }
}

@keyframes flip-hide-verso {
  from {  }
  to { transform: rotateY(180deg); }
}

@keyframes flip-hide-recto {
  from { z-index: 3; }
  to { transform: rotateY(-180deg); }
}

@keyframes flip-show-verso {
  from { visibility: visible; opacity: 1; z-index: 2; transform: rotateY(-180deg) }
  to { z-index: 2; transform: rotateY(0deg); }
}

// VIEW=2up ANIMATIONS RTL
@keyframes flip-show-recto-right-to-left {
  from { visibility: visible; opacity: 1; z-index: 3; transform: rotateY(-180deg) }
  to { z-index: 2; transform: rotateY(0deg); }
}

@keyframes flip-hide-verso-right-to-left {
  from { z-index: 3; }
  to { transform: rotateY(-180deg); }
}

@keyframes flip-hide-recto-right-to-left {
  from { z-index: 3 }
  to { transform: rotateY(180deg); }
}

@keyframes flip-show-verso-right-to-left {
  from { visibility: visible; opacity: 1; z-index: 2; transform: rotateY(180deg) }
  to { z-index: 2; transform: rotateY(0deg); }
}

@keyframes imageMoveToLeft {
  from {}
  to{ transform: translateX(-200%) }
}

@keyframes imageMoveFromRight {
  from{ transform: translateX(200%) }
}

@keyframes imageMoveFromRightFade {
  from { opacity: 0.3; transform: translateX(200%); }
}

@keyframes imageMoveToRight {
  from {}
  to{ transform: translateX(200%) }
}

@keyframes imageMoveFromLeft {
  from{ transform: translateX(-200%) }
}

@keyframes imageMoveFromLeftFade {
  from{ opacity: 0.3; transform: translateX(-200%) }
}

@keyframes imageFade {
  from { }
  to { opacity: 0; }
}
