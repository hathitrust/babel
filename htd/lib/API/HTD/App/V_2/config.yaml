---
# =====================================================================
# V_2-specific plugin config
# =====================================================================

# separate, for readability
ark_pattern:       ark:/13960/(t|fk)\d[a-z\d][a-z\d]\d[a-z\d][a-z\d]\d[a-z\d]
id_pattern:        .+
namespace_pattern: .{2,4}
fileid_pattern:    '[a-zA-Z_:].*'

# Resources, URI regexps and data/metadata typing
resources:
  type:
    pattern:                                            ^/(type)/((_NS_)\.((_ARK_)|(_ID_)))$
    dtype:                                                       metadata
  aggregate:
    pattern:                                       ^/(aggregate)/((_NS_)\.((_ARK_)|(_ID_)))$
    dtype:                                                       data
  structure:
    pattern:                                       ^/(structure)/((_NS_)\.((_ARK_)|(_ID_)))$
    dtype:                                                       metadata

  volume:
    pattern:                                          ^/(volume)/((_NS_)\.((_ARK_)|(_ID_)))$
    dtype:                                                       data
  volume/pageimage:
    pattern:                                ^/(volume/pageimage)/((_NS_)\.((_ARK_)|(_ID_)))/((\d+)|(_FILEID_))$
    dtype:                                                       data
  volume/pageocr:
    pattern:                                  ^/(volume/pageocr)/((_NS_)\.((_ARK_)|(_ID_)))/((\d+)|(_FILEID_))$
    dtype:                                                       data
  volume/pagecoordocr:
    pattern:                             ^/(volume/pagecoordocr)/((_NS_)\.((_ARK_)|(_ID_)))/((\d+)|(_FILEID_))$
    dtype:                                                       data
  volume/pagemeta:
    pattern:                                 ^/(volume/pagemeta)/((_NS_)\.((_ARK_)|(_ID_)))/((\d+)|(_FILEID_))$
    dtype:                                                       metadata
  volume/meta:
    pattern:                                     ^/(volume/meta)/((_NS_)\.((_ARK_)|(_ID_)))$
    dtype:                                                       metadata

  article:
    pattern:                                         ^/(article)/((_NS_)\.((_ARK_)|(_ID_)))$
    dtype:                                                       data
  article/alternate:
    pattern:                               ^/(article/alternate)/((_NS_)\.((_ARK_)|(_ID_)))/((\d+)|(_FILEID_))$
    dtype:                                                       data
  article/assets/embedded:
    pattern:                         ^/(article/assets/embedded)/((_NS_)\.((_ARK_)|(_ID_)))/((\d+)|(_FILEID_))$
    dtype:                                                       data
  article/assets/supplementary:
    pattern:                    ^/(article/assets/supplementary)/((_NS_)\.((_ARK_)|(_ID_)))/((\d+)|(_FILEID_))$
    dtype:                                                       data
  article/meta:
    pattern:                                    ^/(article/meta)/((_NS_)\.((_ARK_)|(_ID_)))$
    dtype:                                                       metadata

valid_query_params:
  - ip
  - debug
  - v
  - callback
  - oauth_consumer_key
  - oauth_nonce
  - oauth_signature
  - oauth_signature_method
  - oauth_timestamp
  - oauth_version
  - format
  - width
  - height
  - size
  - res
  - watermark

client_query_params:
  - ip
  - debug
  - v
  - callback
  - format
  - width
  - height
  - size
  - res
  - watermark

# ---------------------------------------------------------------------
# GLOBAL response block definitions
# ---------------------------------------------------------------------
HTD_RIGHTS_BLOCK: &htd-rights-block
  attrs: null
  content:
    htd:source:
      attrs: null
      content: :::SOURCE
    htd:namespace:
      attrs: null
      content: :::NAMESPACE
    htd:time:
      attrs: null
      content: :::TIME
    htd:user:
      attrs: null
      content: :::USER
    htd:reason:
      attrs: null
      content: :::REASON
    htd:id:
      attrs: null
      content: :::ID
    htd:attr:
      attrs: null
      content: :::ATTR
    htd:note:
      attrs: null
      content: :::NOTE

HTD_VOLUME_ACCESS_BLOCK: &htd-volume-access-block
  - attrs:
      resource: volume/pageocr
    content: _HTD_SCHEMAS_URI_#:::DOWNLOADVOLUMEPAGEOCR
  - attrs:
      resource: volume/pagecoordocr
    content: _HTD_SCHEMAS_URI_#:::DOWNLOADVOLUMEPAGECOORDOCR
  - attrs:
      resource: volume/pageimage
    content: _HTD_SCHEMAS_URI_#:::DOWNLOADVOLUMEPAGEIMAGE
  - attrs:
      resource: volume
    content: _HTD_SCHEMAS_URI_#:::DOWNLOADVOLUME
  - attrs:
      resource: aggregate
    content: _HTD_SCHEMAS_URI_#:::DOWNLOADAGGREGATE

HTD_ARTICLE_ACCESS_BLOCK: &htd-article-access-block
  - attrs:
      resource: article/assets/embedded
    content: _HTD_SCHEMAS_URI_#:::DOWNLOADARTICLEASSETS
  - attrs:
      resource: article/assets/supplementary
    content: _HTD_SCHEMAS_URI_#:::DOWNLOADARTICLEASSETS
  - attrs:
      resource: article
    content: _HTD_SCHEMAS_URI_#:::DOWNLOADARTICLE
  - attrs:
      resource: article/alternate
    content: _HTD_SCHEMAS_URI_#:::DOWNLOADARTICLE
  - attrs:
      resource: aggregate
    content: _HTD_SCHEMAS_URI_#:::DOWNLOADAGGREGATE

HTD_VERSION_BLOCK: &htd-version-block
  attrs: null
  content: 2

HTD_ACCESS_USE_STATEMENT_BLOCK: &htd-access-use-statement-block
  attrs: null
  content: :::ACCESSUSESTATEMENT

HTD_ACCESS_USE_BLOCK: &htd-access-use-block
  attrs: null
  content: _HTD_SCHEMAS_URI_#:::ACCESSUSE

UPDATED_BLOCK: &updated-block
  attrs: null
  content: :::UPDATED

PAGETURNER_LINK_LINK_BLOCK: &pageturner-link-link-block
  attrs:
    rel: _HTD_SCHEMAS_URI_#pageturner
    type: text/html
    href: _HTD_PT_ALTERNATE_URI_
  content: null

PAGETURNER_HANDLE_LINK_BLOCK: &pageturner-handle-link-block
  attrs:
    rel: _HTD_SCHEMAS_URI_#handle
    type: text/html
    href: _HTD_HDL_ALTERNATE_URI_
  content: null

XINCLUDE_BLOCK: &xinclude-block
  attrs:
    xmlns:xi: http://www.w3.org/2001/XInclude
    href: :::XINCLUDEMETS
  content: null

# ---------------------------------------------------------------------
# COMMON response block definitions
# ---------------------------------------------------------------------
AGGREGATE_LINK_BLOCK: &aggregate-link-block
  attrs:
    rel: _HTD_SCHEMAS_URI_#aggregate
    type: application/zip
    href: _HTD_AGGREGATE_URI_/aggregate/__ID__
  content: null

STRUCTURE_LINK_BLOCK: &structure-link-block
  attrs:
    rel: _HTD_SCHEMAS_URI_#structure
    type: text/xml
    href: _HTD_STRUCTURE_URI_/structure/__ID__
  content: null

# ---------------------------------------------------------------------
# VOLUME response block definitions
# ---------------------------------------------------------------------
VOLUME_META_LINK_BLOCK: &volume-meta-link-block
  attrs:
    rel: _HTD_SCHEMAS_URI_#volume_meta
    type: application/atom+xml
    href: _HTD_VOLUME_META_URI_/volume/meta/__ID__
  content: null

VOLUME_PAGEMETA_LINK_BLOCK: &volume-pagemeta-link-block
  attrs:
    rel: _HTD_SCHEMAS_URI_#volume_pagemeta
    type: application/atom+xml
    href: _HTD_VOLUME_PAGEMETA_URI_/volume/pagemeta/:SEQ
  content: null

VOLUME_LINK_BLOCK: &volume-link-block
  attrs:
    rel: _HTD_SCHEMAS_URI_#volume
    type: application/pdf
    href: _HTD_VOLUME_URI_/volume/__ID__
  content: null

VOLUME_PAGEIMAGE_LINK_BLOCK: &volume-pageimage-link-block
  attrs:
    rel: _HTD_SCHEMAS_URI_#volume_pageimage
    type: application/unknown
    href: _HTD_VOLUME_PAGEIMAGE_URI_/volume/pageimage/__ID__/:SEQ
  content: null

VOLUME_PAGEOCR_LINK_BLOCK: &volume-pageocr-link-block
  attrs:
    rel: _HTD_SCHEMAS_URI_#volume_pageocr
    type: text/plain
    href: _HTD_VOLUME_PAGEOCR_URI_/volume/pageocr/__ID__/:SEQ
  content: null

VOLUME_PAGECOORDOCR_LINK_BLOCK: &volume-pagecoordocr-link-block
  attrs:
    rel: _HTD_SCHEMAS_URI_#volume_pagecoordocr
    type: application/unknown
    href: _HTD_VOLUME_PAGECOORDOCR_URI_/volume/pagecoordocr/__ID__/:SEQ
  content: null


# ---------------------------------------------------------------------
# ARTICLE response block definitions
# ---------------------------------------------------------------------
ARTICLE_META_LINK_BLOCK: &article-meta-link-block
  attrs:
    rel: _HTD_SCHEMAS_URI_#article_meta
    type: text/xml
    href: _HTD_ARTICLE_META_URI_/article/meta/__ID__
  content: null

ARTICLE_LINK_BLOCK: &article-link-block
  attrs:
    rel: _HTD_SCHEMAS_URI_#article
    type: text/xml
    href: _HTD_ARTICLE_URI_/article/__ID__
  content: null

ARTICLE_ALTERNATE_LINK_BLOCK: &article-alternate-link-block
  attrs:
    rel: _HTD_SCHEMAS_URI_#article_alternate
    type: application/unknown
    href: _HTD_ARTICLE_URI_/article/alternate/__ID__/:SEQ
  content: null

ARTICLE_ASSETS_EMBEDDED_LINK_BLOCK: &article-assets-embedded-link-block
  attrs:
    rel: _HTD_SCHEMAS_URI_#article_assets_embedded
    type: application/unknown
    href: _HTD_ARTICLE_ASSET_URI_/article/assets/embedded/__ID__/:SEQ
  content: null

ARTICLE_ASSETS_SUPPLEMENTARY_LINK_BLOCK: &article-assets-supplementary-link-block
  attrs:
    rel: _HTD_SCHEMAS_URI_#article_assets_supplementary
    type: application/unknown
    href: _HTD_ARTICLE_ASSET_URI_/article/assets/supplementary/__ID__/:SEQ
  content: null


responses:
# ---------------------- volume/meta XML response ----------------------------
  volume/meta:
    entry:
      attrs:
        xmlns: _HTD_ATOM_NAMESPACE_URI_
        xmlns:htd: _HTD_SCHEMAS_URI_
      content:
        htd:rights: *htd-rights-block
        htd:version: *htd-version-block
        htd:access_use_statement: *htd-access-use-statement-block
        htd:access_use: *htd-access-use-block
        htd:access: *htd-volume-access-block
        updated: *updated-block
        id:
          attrs:   null
          content: _HTD_VOLUME_META_URI_/volume/meta/__ID__
        title:
          attrs: null
          content: HathiTrust Repository Data API - Volume metadata
        link:
          - attrs:
              rel:  self
              type: application/atom+xml
              href: _HTD_VOLUME_META_URI_/volume/meta/__ID__
            content: null
          - *pageturner-link-link-block
          - *pageturner-handle-link-block
          - *volume-pagemeta-link-block
          - *volume-link-block
          - *aggregate-link-block
          - *structure-link-block
        xi:include: *xinclude-block

# ------------------------ volume/pagemeta XML response ----------------------
  volume/pagemeta:
    entry:
      attrs:
        xmlns: _HTD_ATOM_NAMESPACE_URI_
        xmlns:htd: _HTD_SCHEMAS_URI_
      content:
        htd:rights: *htd-rights-block
        htd:version: *htd-version-block
        htd:access_use_statement: *htd-access-use-statement-block
        htd:access_use: *htd-access-use-block
        htd:access: *htd-volume-access-block
        updated: *updated-block
        htd:selected_seq:
          attrs: null
          content: __SEQ__
        id:
          attrs: null
          content: _HTD_VOLUME_PAGEMETA_URI_/volume/pagemeta/__ID__/__SEQ__
        title:
          attrs: null
          content: HathiTrust Repository Data API - Volume single page metadata
        link:
          - attrs:
              rel: self
              type: application/atom+xml
              href: _HTD_VOLUME_PAGEMETA_URI_/volume/pagemeta/__ID__/__SEQ__
            content: null
          - *pageturner-link-link-block
          - *pageturner-handle-link-block
          - *volume-pageimage-link-block
          - *volume-pageocr-link-block
          - *volume-pagecoordocr-link-block
          - *volume-meta-link-block
          - *volume-link-block
          - *aggregate-link-block
          - *structure-link-block
        xi:include: *xinclude-block

# ---------------------- article/meta XML response ----------------------------
  article/meta:
    entry:
      attrs:
        xmlns: _HTD_ATOM_NAMESPACE_URI_
        xmlns:htd: _HTD_SCHEMAS_URI_
      content:
        htd:rights: *htd-rights-block
        htd:version: *htd-version-block
        htd:access_use_statement: *htd-access-use-statement-block
        htd:access_use: *htd-access-use-block
        htd:access: *htd-article-access-block
        updated: *updated-block
        id:
          attrs:   null
          content: _HTD_ARTICLE_META_URI_/article/meta/__ID__
        title:
          attrs: null
          content: HathiTrust Repository Data API - Article metadata
        link:
          - attrs:
              rel:  self
              type: application/atom+xml
              href: _HTD_ARTICLE_META_URI_/article/meta/__ID__
            content: null
          - *pageturner-link-link-block
          - *pageturner-handle-link-block
          - *article-assets-embedded-link-block
          - *article-assets-supplementary-link-block
          - *article-link-block
          - *article-alternate-link-block
          - *aggregate-link-block
          - *structure-link-block
        xi:include: *xinclude-block

# ---------------------------------------------------------------------
# MIME type map: f(resource, representation, cannonical_key)
# ---------------------------------------------------------------------
mimetype_map:
  type:
    default: text/xml
    xml: text/xml
    json: application/json

  aggregate:
    default: application/zip
    zip: application/zip

  structure:
    default: text/xml
    xml: text/xml
    json: application/json

  volume/pageimage:
    default: binary/octet-stream
    jpeg: image/jpeg
    png: image/png
  volume/pageocr:
    default: text/plain
  volume/pagecoordocr:
    default: text/html
  volume/pagemeta:
    default: text/xml
    json: application/json
  volume/meta:
    default: text/xml
    json: application/json
  volume:
    default: application/pdf
    pdf: application/pdf

  article:
    default: text/xml
  article/alternate:
    default: binary/octet-stream
  article/assets/embedded:
    default: binary/octet-stream
  article/assets/supplementary:
    default: binary/octet-stream
  article/meta:
    default: text/xml
    json: application/json


# ---------------------------------------------------------------------
# Access type map:
# access_type = g(access_key, f(resource, rights attr, source)).
#
# which means that there are further restrictions on 'open' and
# 'restricted' that are applied downstream:
#
# restricted volume (format=ebm) is further restricted
# by allow_pdf bit:
#
#     code=39: 00100111  00100000  (O|OR|R)|allow_pdf
#
# open pageimage when format=raw|watermark=0 is restricted by the
# allow_raw or allow_unwatermarked_derivatives bit
#
# ---------------------------------------------------------------------
OPEN_ACCESSIBILITY_BLOCK: &open-accessibility-block
  google: open
  lit-dlps-dc: open
  um-press: open
  internet-archive: open
  yale: open
  minn-dig-lib: open
  minn-hist-soc: open
  utah_state_univ_press: open
  univ_madrid: open
  purdue: open
  getty: open
  um-dc-mp: open
  uiuc: open
  brooklynmuseum: open
  uf: open
  tamu: open
  udel: open
  aeu: open
  ucw: open

RESTRICTED_ACCESSIBILITY_BLOCK: &restricted-accessibility-block
  google: restricted
  lit-dlps-dc: restricted
  um-press: restricted
  internet-archive: restricted
  yale: restricted
  minn-dig-lib: restricted
  minn-hist-soc: restricted
  utah_state_univ_press: restricted
  univ_madrid: restricted
  purdue: restricted
  getty: restricted
  um-dc-mp: restricted
  uiuc: restricted
  brooklynmuseum: restricted
  uf: restricted
  tamu: restricted
  udel: restricted
  aeu: restricted
  ucw: restricted

# ---------------------------------------------------------------------
# Access type map:
# access_type = g(access_key, f(resource, rights.attr, rights.source)).
#
# access_types are:
#
#   open
#   open_restricted
#   restricted
#   restricted_forbidden
#
# Only the access_types that match "restricted" have extended
# access_types which are defined by the authorization bits in
# HAuth.pm.
#
# restricted pageimage format=raw||watermark=0 is restricted by the
# allow_raw or allow_unwatermarked_derivatives bit
#
# restricted aggregate is restricted by the allow_zip bit
#
# volume is restricted by the allow_pdf bit for ODB-ebm
# Current rules for "volume" resource:
#
# o  The only format for volume is ebm which is limited by policy to
# source={google, lit-dlps-dc}.
# ---------------------------------------------------------------------
accessibility_matrix:
  type:
    free: *open-accessibility-block
    nonfree: *open-accessibility-block

  structure:
    free: *open-accessibility-block
    nonfree: *open-accessibility-block

  aggregate:
    free:
      google: open_restricted
      lit-dlps-dc: open
      um-press: restricted_forbidden
      internet-archive: open
      yale: open
      minn-dig-lib: restricted_forbidden
      minn-hist-soc: restricted_forbidden
      utah_state_univ_press: open
      univ_madrid: open
      purdue: open
      getty: open
      um-dc-mp: open
      uiuc: open
      brooklynmuseum: open
      uf: open
      tamu: open
      udel: open
      aeu: open
      ucw: open
    nonfree:
      google: restricted
      lit-dlps-dc: restricted
      um-press: restricted_forbidden
      internet-archive: restricted
      yale: restricted
      minn-dig-lib: restricted_forbidden
      minn-hist-soc: restricted_forbidden
      utah_state_univ_press: restricted
      univ_madrid: restricted
      purdue: restricted
      getty: restricted
      um-dc-mp: restricted
      uiuc: restricted
      brooklynmuseum: restricted
      uf: restricted
      tamu: restrcted
      udel: restricted
      aeu: restricted
      ucw: restricted

  volume:
    free:
      google: open_restricted
      lit-dlps-dc: open
      um-press: restricted_forbidden
      internet-archive: restricted_forbidden
      yale: restricted_forbidden
      minn-dig-lib: restricted_forbidden
      minn-hist-soc: restricted_forbidden
      utah_state_univ_press: restricted_forbidden
      univ_madrid: restricted_forbidden
      purdue: restricted_forbidden
      getty: restricted_forbidden
      um-dc-mp: restricted_forbidden
      uiuc: restricted_forbidden
      brooklynmuseum: open
      uf: open
      tamu: open
      udel: open
      aeu: open
      ucw: open
    nonfree:
      google: restricted
      lit-dlps-dc: restricted
      um-press: restricted_forbidden
      internet-archive: restricted
      yale: restricted_forbidden
      minn-dig-lib: restricted_forbidden
      minn-hist-soc: restricted_forbidden
      utah_state_univ_press: restricted_forbidden
      univ_madrid: restricted_forbidden
      purdue: restricted_forbidden
      getty: restricted_forbidden
      um-dc-mp: restricted_forbidden
      uiuc: restricted_forbidden
      brooklynmuseum: restricted
      uf: restricted
      tamu: restrcted
      udel: restricted
      aeu: restricted
      ucw: restricted

  volume/pageimage:
    free:
      google: open_restricted
      lit-dlps-dc: open
      um-press: open
      internet-archive: open
      yale: open
      minn-dig-lib: open
      minn-hist-soc: open
      utah_state_univ_press: open
      univ_madrid: open
      purdue: open
      getty: open
      um-dc-mp: open
      uiuc: open
      brooklynmuseum: open
      uf: open
      tamu: open
      udel: open
      aeu: open
      ucw: open
    nonfree:
      google: restricted
      lit-dlps-dc: restricted
      um-press: restricted
      internet-archive: restricted
      yale: restricted
      minn-dig-lib: restricted_forbidden
      minn-hist-soc: restricted_forbidden
      utah_state_univ_press: restricted
      univ_madrid: restricted
      purdue: restricted
      getty: restricted
      um-dc-mp: restricted
      uiuc: restricted
      brooklynmuseum: restricted
      uf: restricted
      tamu: restrcted
      udel: restricted
      aeu: restricted
      ucw: restricted

  volume/pageocr:
    free: *open-accessibility-block
    nonfree: *restricted-accessibility-block
  volume/pagecoordocr:
    free: *open-accessibility-block
    nonfree: *restricted-accessibility-block
  volume/pagemeta:
    free: *open-accessibility-block
    nonfree: *open-accessibility-block
  volume/meta:
    free: *open-accessibility-block
    nonfree: *open-accessibility-block

  article:
    free: *open-accessibility-block
    nonfree: *restricted-accessibility-block
  article/alternate:
    free: *open-accessibility-block
    nonfree: *restricted-accessibility-block
  article/assets/embedded:
    free: *open-accessibility-block
    nonfree: *restricted-accessibility-block
  article/assets/supplementary:
    free: *open-accessibility-block
    nonfree: *restricted-accessibility-block
  article/meta:
    free: *open-accessibility-block
    nonfree: *open-accessibility-block


# ---------------------------------------------------------------------
# Atom elements, contents and attribute values organized by resource
# ---------------------------------------------------------------------
_HTD_AGGREGATE_URI_:             :::AGGREGATEPROTOCOL://babel.hathitrust.org/cgi/htd
_HTD_STRUCTURE_URI_:             http://babel.hathitrust.org/cgi/htd

_HTD_VOLUME_META_URI_:           http://babel.hathitrust.org/cgi/htd
_HTD_VOLUME_PAGEMETA_URI_:       http://babel.hathitrust.org/cgi/htd
_HTD_VOLUME_PAGEIMAGE_URI_:      :::VOLUMEPAGEIMAGEPROTOCOL://babel.hathitrust.org/cgi/htd
_HTD_VOLUME_PAGEOCR_URI_:        :::VOLUMEPAGEOCRPROTOCOL://babel.hathitrust.org/cgi/htd
_HTD_VOLUME_PAGECOORDOCR_URI_:   :::VOLUMEPAGECOORDOCRPROTOCOL://babel.hathitrust.org/cgi/htd
_HTD_VOLUME_URI_:                :::VOLUMEPROTOCOL://babel.hathitrust.org/cgi/htd

_HTD_ARTICLE_META_URI_:           http://babel.hathitrust.org/cgi/htd
_HTD_ARTICLE_ASSET_URI_:          :::ARTICLEASSETSPROTOCOL://babel.hathitrust.org/cgi/htd
_HTD_ARTICLE_URI_:                :::ARTICLEPROTOCOL://babel.hathitrust.org/cgi/htd

# ---------------------------------------------------------------------
# Token patterns to support dynamic replacement
# ^__XXX__$   replacement by simple substitution
# ^_HTD_[A-Z_]+_$ replacement by substitution by pointer to static data
# ^:::XXX$    replacement by a handler binding
# ---------------------------------------------------------------------
