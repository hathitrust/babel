---
# =====================================================================
# V_1-specific plugin config
# =====================================================================

# resource ids, e.g. "meta", must coordinate with htd_authorization db
# table.
patterns:
  meta:                 /(meta)/((.*?)\.((___ARK___)|([^/]+)))$
  structure:       /(structure)/((.*?)\.((___ARK___)|([^/]+)))$
  aggregate:       /(aggregate)/((.*?)\.((___ARK___)|([^/]+)))$
  pageimage:       /(pageimage)/((.*?)\.((___ARK___)|(.*)))/(\d+)$
  pageocr:           /(pageocr)/((.*?)\.((___ARK___)|(.*)))/(\d+)$
  pagecoordocr: /(pagecoordocr)/((.*?)\.((___ARK___)|(.*)))/(\d+)$
  pagemeta:         /(pagemeta)/((.*?)\.((___ARK___)|(.*)))/(\d+)$

# separate, for readability
ark_pattern:    ark:/13960/(t|fk)\d[a-z\d][a-z\d]\d[a-z\d][a-z\d]\d[a-z\d]

valid_query_params:
  - ip
  - debug
  - v
  - alt
  - callback
  - oauth_consumer_key
  - oauth_nonce
  - oauth_signature
  - oauth_signature_method
  - oauth_timestamp
  - oauth_version
  - format
  - width
  - height
  - size
  - res
  - watermark

client_query_params:
  - ip
  - debug
  - v
  - alt
  - callback
  - format
  - width
  - height
  - size
  - res
  - watermark

responses:
# ---------------------------------------------------------------------
# structure XML response
# ---------------------------------------------------------------------
  structure:
    entry:
      attrs:
        xmlns: _HTD_ATOM_NAMESPACE_URI_
        xmlns:htd: _HTD_SCHEMAS_URI_
      content:
        htd:rights:
          attrs: null
          content:
            htd:source:
              attrs: null
              content: :::SOURCE
            htd:namespace:
              attrs: null
              content: :::NAMESPACE
            htd:time:
              attrs: null
              content: :::TIME
            htd:user:
              attrs: null
              content: :::USER
            htd:reason:
              attrs: null
              content: :::REASON
            htd:id:
              attrs: null
              content: :::ID
            htd:attr:
              attrs: null
              content: :::ATTR
            htd:note:
              attrs: null
              content: :::NOTE
        htd:version:
          attrs: null
          content: 1
        htd:access_use_statement:
          attrs: null
          content: :::ACCESSUSESTATEMENT
        htd:access_use:
          attrs: null
          content: _HTD_SCHEMAS_URI_#:::ACCESSUSE
        htd:access:
          - attrs:
              resource: pageocr
            content: _HTD_SCHEMAS_URI_#:::DOWNLOADPAGEOCR
          - attrs:
              resource: pagecoordocr
            content: _HTD_SCHEMAS_URI_#:::DOWNLOADPAGECOORDOCR
          - attrs:
              resource: pageimage
            content: _HTD_SCHEMAS_URI_#:::DOWNLOADPAGEIMAGE
          - attrs:
              resource: aggregate
            content: _HTD_SCHEMAS_URI_#:::DOWNLOADAGGREGATE
        updated:
          attrs: null
          content: :::UPDATED
        id:
          attrs: null
          content: _HTD_SCHEMAS_URI_/structure/__ID__
        title:
          attrs: null
          content: HathiTrust Repository Data API - METS
        link:
          - attrs:
              rel: alternate
              href: _HTD_PT_ALTERNATE_URI_
              type: text/html
            content: null
          - attrs:
              rel: alternate
              href: _HTD_HDL_ALTERNATE_URI_
              type: text/html
            content: null
          - attrs:
              rel: self
              href: _HTD_STRUCTURE_URI_/structure/__ID__
              type: application/xml
            content: null
          - attrs:
              rel: _HTD_SCHEMAS_URI_#aggregate
              href: _HTD_AGGREGATE_URI_/aggregate/__ID__
              type: application/zip
            content: null
          - attrs:
              rel: _HTD_SCHEMAS_URI_#meta
              type: application/xml
              href: _HTD_META_URI_/meta/__ID__
            content: null
        xi:include:
          attrs:
            xmlns:xi: http://www.w3.org/2001/XInclude
            href: :::XINCLUDEMETS
          content: null

# ---------------------------------------------------------------------
# meta XML response
# ---------------------------------------------------------------------
  meta:
    entry:
      attrs:
        xmlns: _HTD_ATOM_NAMESPACE_URI_
        xmlns:htd: _HTD_SCHEMAS_URI_
      content:
        htd:rights:
          attrs: null
          content:
            htd:source:
              attrs:   null
              content: :::SOURCE
            htd:namespace:
              attrs:   null
              content: :::NAMESPACE
            htd:time:
              attrs:   null
              content: :::TIME
            htd:user:
              attrs:   null
              content: :::USER
            htd:reason:
              attrs:   null
              content: :::REASON
            htd:id:
              attrs:   null
              content: :::ID
            htd:attr:
              attrs:   null
              content: :::ATTR
            htd:note:
              attrs:   null
              content: :::NOTE
        htd:version:
          attrs:   null
          content: 1
        htd:access_use_statement:
          attrs: null
          content: :::ACCESSUSESTATEMENT
        htd:access_use:
          attrs: null
          content: _HTD_SCHEMAS_URI_#:::ACCESSUSE
        htd:access:
          - attrs:
              resource: pageocr
            content: _HTD_SCHEMAS_URI_#:::DOWNLOADPAGEOCR
          - attrs:
              resource: pagecoordocr
            content: _HTD_SCHEMAS_URI_#:::DOWNLOADPAGECOORDOCR
          - attrs:
              resource: pageimage
            content: _HTD_SCHEMAS_URI_#:::DOWNLOADPAGEIMAGE
          - attrs:
              resource: aggregate
            content: _HTD_SCHEMAS_URI_#:::DOWNLOADAGGREGATE
        updated:
          attrs:   null
          content: :::UPDATED
        id:
          attrs:   null
          content: _HTD_META_URI_/meta/__ID__
        title:
          attrs: null
          content: HathiTrust Repository Data API - metadata
        link:
          - attrs:
              rel:  alternate
              href: _HTD_PT_ALTERNATE_URI_
              type: text/html
            content: null
          - attrs:
              rel:  alternate
              href: _HTD_HDL_ALTERNATE_URI_
              type: text/html
            content: null
          - attrs:
              rel:  self
              href: _HTD_META_URI_/meta/__ID__
              type: application/atom+xml
            content: null
          - attrs:
              rel:  _HTD_SCHEMAS_URI_#aggregate
              href: _HTD_AGGREGATE_URI_/aggregate/__ID__
              type: application/zip
            content: null
          - attrs:
              rel:  _HTD_SCHEMAS_URI_#structure
              type: application/xml
              href: _HTD_STRUCTURE_URI_/structure/__ID__
            content: null
        xi:include:
          attrs:
            xmlns:xi: http://www.w3.org/2001/XInclude
            href:     :::XINCLUDEMETS
          content: null

# ---------------------------------------------------------------------
# pagemeta XML response
# ---------------------------------------------------------------------
  pagemeta:
    entry:
      attrs:
        xmlns: _HTD_ATOM_NAMESPACE_URI_
        xmlns:htd: _HTD_SCHEMAS_URI_
      content:
        htd:rights:
          attrs: null
          content:
            htd:source:
              attrs: null
              content: :::SOURCE
            htd:namespace:
              attrs: null
              content: :::NAMESPACE
            htd:time:
              attrs: null
              content: :::TIME
            htd:user:
              attrs: null
              content: :::USER
            htd:reason:
              attrs: null
              content: :::REASON
            htd:id:
              attrs: null
              content: :::ID
            htd:attr:
              attrs: null
              content: :::ATTR
            htd:note:
              attrs: null
              content: :::NOTE
        htd:selected_seq:
          attrs: null
          content: __SEQ__
        htd:version:
          attrs: null
          content: 1
        htd:access_use_statement:
          attrs: null
          content: :::ACCESSUSESTATEMENT
        htd:access_use:
          attrs: null
          content: _HTD_SCHEMAS_URI_#:::ACCESSUSE
        htd:access:
          - attrs:
              resource: pageocr
            content: _HTD_SCHEMAS_URI_#:::DOWNLOADPAGEOCR
          - attrs:
              resource: pagecoordocr
            content: _HTD_SCHEMAS_URI_#:::DOWNLOADPAGECOORDOCR
          - attrs:
              resource: pageimage
            content: _HTD_SCHEMAS_URI_#:::DOWNLOADPAGEIMAGE
          - attrs:
              resource: aggregate
            content: _HTD_SCHEMAS_URI_#:::DOWNLOADAGGREGATE
        updated:
          attrs: null
          content: :::UPDATED
        id:
          attrs: null
          content: _HTD_PAGEMETA_URI_/pagemeta/__ID__/__SEQ__
        title:
          attrs: null
          content: HathiTrust Repository Data API - single page metadata
        link:
          - attrs:
              rel: alternate
              href: _HTD_PT_ALTERNATE_URI_;seq=__SEQ__
              type: text/html
            content: null
          - attrs:
              rel: alternate
              href: _HTD_HDL_ALTERNATE_URI_
              type: text/html
            content: null
          - attrs:
              rel: self
              href: _HTD_PAGEMETA_URI_/pagemeta/__ID__/__SEQ__
              type: application/atom+xml
            content: null
          - attrs:
              rel: _HTD_SCHEMAS_URI_#pageimage
              href: _HTD_PAGEIMAGE_URI_/pageimage/__ID__/__SEQ__
              type: :::IMAGEMIMETYPE
            content: null
          - attrs:
              rel: _HTD_SCHEMAS_URI_#pageocr
              href: _HTD_PAGEOCR_URI_/pageocr/__ID__/__SEQ__
              type: :::OCRMIMETYPE
            content: null
          - attrs:
              rel: _HTD_SCHEMAS_URI_#pagecoordocr
              href: _HTD_PAGEOCR_URI_/pagecoordocr/__ID__/__SEQ__
              type: :::COORDOCRMIMETYPE
            content: null
          - attrs:
              rel: _HTD_SCHEMAS_URI_#aggregate
              href: _HTD_AGGREGATE_URI_/aggregate/__ID__
              type: application/zip
            content: null
          - attrs:
              rel: _HTD_SCHEMAS_URI_#structure
              type: application/xml
              href: _HTD_STRUCTURE_URI_/structure/__ID__
            content: null
          - attrs:
              rel: _HTD_SCHEMAS_URI_#meta
              type: application/atom+xml
              href: _HTD_META_URI_/meta/__ID__
            content: null
        xi:include:
          attrs:
            xmlns:xi: http://www.w3.org/2001/XInclude
            href: :::XINCLUDEMETS
          content: null

# ---------------------------------------------------------------------
# MIME type map: f(resource, representation, cannonical_key)
# ---------------------------------------------------------------------
mimetype_map:
  meta:
    default: application/xml
    json: application/json
  structure:
    default: application/xml
    json: application/json
  pagemeta:
    default: application/xml
    json: application/json
  aggregate:
    default: application/zip
    zip: application/zip
  pageimage:
    tiff: image/tiff
    jp2: image/jp2
    jpeg: image/jpeg
    png: image/png
  pageocr:
    default: text/plain
    text: text/plain
  pagecoordocr:
    default: text/html
    xml: application/xml
    html: text/html

# ---------------------------------------------------------------------
# Access type map:
# access_type = g(access_key, f(resource, rights.attr, rights.source)).
#
# access_types are:
#
#   open
#   open_restricted
#   restricted
#   restricted_forbidden
#
# Only the access_types that match "restricted" have extended
# access_types which are defined by the authorization bits in
# HAuth.pm.
#
# restricted pageimage format=raw||watermark=0 is restricted by the
# allow_raw or allow_unwatermarked_derivatives bit
#
# restricted aggregate is restricted by the allow_zip bit
# ---------------------------------------------------------------------
OPEN_ACCESSIBILITY_BLOCK: &open-accessibility-block
  google: open
  lit-dlps-dc: open
  um-press: open
  internet-archive: open
  yale: open
  minn-dig-lib: open
  minn-hist-soc: open
  utah_state_univ_press: open
  univ_madrid: open
  purdue: open
  getty: open
  um-dc-mp: open
  uiuc: open

RESTRICTED_ACCESSIBILITY_BLOCK: &restricted-accessibility-block
  google: restricted
  lit-dlps-dc: restricted
  um-press: restricted
  internet-archive: restricted
  yale: restricted
  minn-dig-lib: restricted
  minn-hist-soc: restricted
  utah_state_univ_press: restricted
  univ_madrid: restricted
  purdue: restricted
  getty: restricted
  um-dc-mp: restricted
  uiuc: restricted

accessibility_matrix:
  pageimage:
    free:
      google: open_restricted
      lit-dlps-dc: open
      um-press: open
      internet-archive: open
      yale: open
      minn-dig-lib: open
      minn-hist-soc: open
      utah_state_univ_press: open
      univ_madrid: open
      purdue: open
      getty: open
      um-dc-mp: open
      uiuc: open
    nonfree:
      google: restricted
      lit-dlps-dc: restricted
      um-press: restricted
      internet-archive: restricted
      yale: restricted
      minn-dig-lib: restricted_forbidden
      minn-hist-soc: restricted_forbidden
      utah_state_univ_press: restricted
      univ_madrid: restricted
      purdue: restricted
      getty: restricted
      um-dc-mp: restricted
      uiuc: restricted

  aggregate:
    free:
      google: open_restricted
      lit-dlps-dc: open
      um-press: restricted_forbidden
      internet-archive: open
      yale: open
      minn-dig-lib: restricted_forbidden
      minn-hist-soc: restricted_forbidden
      utah_state_univ_press: open
      univ_madrid: open
      purdue: open
      getty: open
      um-dc-mp: open
      uiuc: open
    nonfree:
      google: restricted
      lit-dlps-dc: restricted
      um-press: restricted_forbidden
      internet-archive: restricted
      yale: restricted
      minn-dig-lib: restricted_forbidden
      minn-hist-soc: restricted_forbidden
      utah_state_univ_press: restricted
      univ_madrid: restricted
      purdue: restricted
      getty: restricted
      um-dc-mp: restricted
      uiuc: restricted

  pageocr:
    free: *open-accessibility-block
    nonfree: *restricted-accessibility-block

  pagecoordocr:
    free: *open-accessibility-block
    nonfree: *restricted-accessibility-block

  pagemeta:
    free: *open-accessibility-block
    nonfree: *open-accessibility-block

  meta:
    free: *open-accessibility-block
    nonfree: *open-accessibility-block

  structure:
    free: *open-accessibility-block
    nonfree: *open-accessibility-block


# ---------------------------------------------------------------------
# Atom elements, contents and attribute values organized by resource
# ---------------------------------------------------------------------
_HTD_META_URI_:           http://babel.hathitrust.org/cgi/htd
_HTD_PAGEMETA_URI_:       http://babel.hathitrust.org/cgi/htd
_HTD_STRUCTURE_URI_:      http://babel.hathitrust.org/cgi/htd
_HTD_PAGEIMAGE_URI_:      :::PAGEIMAGEPROTOCOL://babel.hathitrust.org/cgi/htd
_HTD_PAGEOCR_URI_:        :::PAGEOCRPROTOCOL://babel.hathitrust.org/cgi/htd
_HTD_PAGECOORDOCR_URI_:   :::PAGECOORDOCRPROTOCOL://babel.hathitrust.org/cgi/htd
_HTD_AGGREGATE_URI_:      :::AGGREGATEPROTOCOL://babel.hathitrust.org/cgi/htd

# ---------------------------------------------------------------------
# Token patterns to support dynamic replacement
# ^__XXX__$   replacement by simple substitution
# ^_HTD_[A-Z_]+_$ replacement by substitution by pointer to static data
# ^:::XXX$    replacement by a handler binding
# ---------------------------------------------------------------------
